import { useState, useEffect, useCallback } from "react";

// â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
// DESIGN TOKENS
// â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
const C = {
  bg:"#0A0C10", card:"#181C26", border:"#262C3E",
  accent:"#F4A93D", accentDim:"#F4A93D18",
  green:"#2DD4A0", greenDim:"#2DD4A018",
  red:"#F45F5F", redDim:"#F45F5F18",
  blue:"#5B9CF6", blueDim:"#5B9CF618",
  purple:"#A78BFA", purpleDim:"#A78BFA18",
  orange:"#FB923C", orangeDim:"#FB923C18",
  text:"#E8EAF0", muted:"#5A6270", subtle:"#222840",
  panel:"#131720",
};

// â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
// SEED DATA
// â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
const SEED_FRANCHISEES = [
  { id:"f1", name:"Peak Roofing Co.",    owner:"Mike Johnson",   bm:"bm1", region:"Southeast", avgTicket:12400, grossMargin:41, closeRate:63, revenueGoal:1000000, netProfitGoal:220000, strategy:"premium", overhead:38000, ytdRevenue:670200, ytdJobs:54,
    monthlyGoals:{ revenue:85000, jobs:6, margin:40, avgTicket:13000, gpDollars:34000 },
    monthlyNotes:{ "2025-08":"Great month, materials overrun on 2 jobs needs attention.", "2025-07":"Margin slipped due to labor costs â€” revisit crew bids." } },
  { id:"f2", name:"Summit Roofing LLC",  owner:"Sarah Chen",     bm:"bm1", region:"Southeast", avgTicket:10800, grossMargin:38, closeRate:58, revenueGoal:800000,  netProfitGoal:160000, strategy:"volume",  overhead:31000, ytdRevenue:410000, ytdJobs:38,
    monthlyGoals:{ revenue:68000, jobs:7, margin:38, avgTicket:11000, gpDollars:26000 },
    monthlyNotes:{} },
  { id:"f3", name:"Ridge Line Roofing",  owner:"Carlos Vega",    bm:"bm1", region:"Southeast", avgTicket:13200, grossMargin:44, closeRate:71, revenueGoal:1200000, netProfitGoal:280000, strategy:"premium", overhead:44000, ytdRevenue:890000, ytdJobs:67,
    monthlyGoals:{ revenue:100000, jobs:8, margin:44, avgTicket:13500, gpDollars:44000 },
    monthlyNotes:{} },
  { id:"f4", name:"Apex Roofing Group",  owner:"Dana Williams",  bm:"bm2", region:"Midwest",   avgTicket:9900,  grossMargin:36, closeRate:55, revenueGoal:750000,  netProfitGoal:120000, strategy:"volume",  overhead:28000, ytdRevenue:290000, ytdJobs:29,
    monthlyGoals:{ revenue:62000, jobs:7, margin:36, avgTicket:10000, gpDollars:22000 },
    monthlyNotes:{} },
  { id:"f5", name:"Crest Roofing Inc.",  owner:"Tom Bradley",    bm:"bm2", region:"Midwest",   avgTicket:11500, grossMargin:40, closeRate:60, revenueGoal:950000,  netProfitGoal:195000, strategy:"premium", overhead:36000, ytdRevenue:520000, ytdJobs:45,
    monthlyGoals:{ revenue:79000, jobs:7, margin:40, avgTicket:12000, gpDollars:32000 },
    monthlyNotes:{} },
];

const SEED_BMS = [
  { id:"bm1", name:"Jessica Moore",  franchiseeIds:["f1","f2","f3"], region:"Southeast" },
  { id:"bm2", name:"Derek Thompson", franchiseeIds:["f4","f5"],      region:"Midwest" },
];

// Job cost structure:
//   estimated: { materials, labor, dump, franchiseFee, other }  â† entered at job creation
//   actuals:   { materials:[{desc,amount,type},...], labor:[...], dump:[...], franchiseFee:[...], warranty:[], other:[...] }
//   flags are variance-based: actual vs estimated per category
const SEED_JOBS = [
  // f1 â€” pending review; BM has uploaded 3 receipts, franchisee has assigned 2 of them
  { id:"j1", fid:"f1", address:"142 Oak St, Atlanta GA", customer:"Robert Hill", contractPrice:13500,
    status:"pending_review", submittedAt:"2025-08-18", createdAt:"2025-08-10",
    estimated:{ materials:3800, labor:2400, dump:350, franchiseFee:500, warranty:0, other:200 },
    actuals:{ materials:[{desc:"GAF Timberline HDZ Shingles",amount:3200,type:"line"},{desc:"Underlayment & Ice Shield",amount:620,type:"line"},{desc:"Drip Edge & Flashing",amount:380,type:"line"}], labor:[{desc:"Tear-off & Install crew",amount:2420,type:"line"}], dump:[{desc:"Debris haul-off",amount:410,type:"lump"}], franchiseFee:[{desc:"Franchise Safety Fee",amount:500,type:"lump"}], warranty:[], other:[{desc:"Permits",amount:320,type:"lump"}] },
    documents:[
      { id:"d1a", name:"GAF_Invoice_OakSt.pdf",       size:284210, uploadedBy:"Jessica Moore", uploadedByRole:"bm", uploadedAt:"2025-08-17", assignedTo:["materials-0"] },
      { id:"d1b", name:"Underlayment_Receipt.pdf",    size:118400, uploadedBy:"Jessica Moore", uploadedByRole:"bm", uploadedAt:"2025-08-17", assignedTo:["materials-1","materials-2"] },
      { id:"d1c", name:"CrewTimesheet_Aug10-11.xlsx", size:42300,  uploadedBy:"Jessica Moore", uploadedByRole:"bm", uploadedAt:"2025-08-18", assignedTo:["labor-0"] },
    ],
    flags:[] },

  // f1 â€” flagged: materials WAY over + dump over; BM uploaded invoice but franchisee hasn't assigned it yet
  { id:"j2", fid:"f1", address:"88 Maple Ave, Marietta GA", customer:"Linda Torres", contractPrice:9200,
    status:"flagged", submittedAt:"2025-08-11", createdAt:"2025-08-05",
    estimated:{ materials:2600, labor:1900, dump:300, franchiseFee:375, warranty:0, other:150 },
    actuals:{ materials:[{desc:"Owens Corning Duration Shingles",amount:2800,type:"line"},{desc:"Underlayment",amount:480,type:"line"},{desc:"Extra flashing",amount:390,type:"line"}], labor:[{desc:"Install crew",amount:2200,type:"line"}], dump:[{desc:"Debris removal",amount:410,type:"lump"}], franchiseFee:[{desc:"Franchise Safety Fee",amount:375,type:"lump"}], warranty:[], other:[{desc:"Misc supplies",amount:160,type:"lump"}] },
    documents:[
      { id:"d2a", name:"OC_Shingles_Invoice_MapleSt.pdf", size:196000, uploadedBy:"Jessica Moore", uploadedByRole:"bm", uploadedAt:"2025-08-10", assignedTo:[] },
    ],
    flags:[] },

  // f1 â€” approved (clean job, all receipts assigned and paid)
  { id:"j3", fid:"f1", address:"301 Pine Rd, Decatur GA", customer:"James Park", contractPrice:15800,
    status:"approved", submittedAt:"2025-07-31", createdAt:"2025-07-23", approvedAt:"2025-08-01",
    estimated:{ materials:4800, labor:2900, dump:380, franchiseFee:600, warranty:0, other:250 },
    actuals:{ materials:[{desc:"CertainTeed Landmark Pro",amount:3800,type:"line"},{desc:"Premium underlayment",amount:720,type:"line"},{desc:"Ridge cap",amount:540,type:"line"}], labor:[{desc:"Full install crew",amount:2900,type:"line"}], dump:[{desc:"Haul-off",amount:360,type:"lump"}], franchiseFee:[{desc:"Franchise Safety Fee",amount:600,type:"lump"}], warranty:[], other:[{desc:"Permits",amount:280,type:"lump"}] },
    documents:[
      { id:"d3a", name:"CertainTeed_Invoice.pdf",   size:312000, uploadedBy:"Jessica Moore", uploadedByRole:"bm", uploadedAt:"2025-07-30", assignedTo:["materials-0","materials-1","materials-2"] },
      { id:"d3b", name:"LaborTimesheet_PineRd.pdf", size:98000,  uploadedBy:"Jessica Moore", uploadedByRole:"bm", uploadedAt:"2025-07-30", assignedTo:["labor-0"] },
      { id:"d3c", name:"DumpTicket_PineRd.jpg",     size:54000,  uploadedBy:"Jessica Moore", uploadedByRole:"bm", uploadedAt:"2025-07-31", assignedTo:["dump-0"] },
    ],
    flags:[], payouts:{ materials:[{payee:"CertainTeed Supply Co",amount:5060,status:"paid"}], subs:[], franchisee:{ gross:15800, costs:9200, net:6600, status:"paid" } } },

  // f1 â€” open; BM has pre-loaded an invoice but no actuals entered yet
  { id:"j4", fid:"f1", address:"55 Birch Ln, Smyrna GA", customer:"Karen Scott", contractPrice:11200,
    status:"open", createdAt:"2025-08-20",
    estimated:{ materials:3100, labor:2100, dump:320, franchiseFee:430, warranty:0, other:175 },
    actuals:{ materials:[], labor:[], dump:[], franchiseFee:[], warranty:[], other:[] },
    documents:[
      { id:"d4a", name:"BirchLn_MaterialsEstimate.pdf", size:220000, uploadedBy:"Jessica Moore", uploadedByRole:"bm", uploadedAt:"2025-08-20", assignedTo:[] },
    ],
    flags:[] },

  // f2 â€” pending review, clean â€” week of Aug 18
  { id:"j5", fid:"f2", address:"220 Elm Dr, Charlotte NC", customer:"Frank Davis", contractPrice:10400,
    status:"pending_review", submittedAt:"2025-08-19", createdAt:"2025-08-11",
    estimated:{ materials:2900, labor:2000, dump:300, franchiseFee:400, warranty:0, other:180 },
    actuals:{ materials:[{desc:"GAF Shingles",amount:2910,type:"line"},{desc:"Underlayment",amount:490,type:"line"}], labor:[{desc:"Install",amount:2050,type:"line"}], dump:[{desc:"Haul-off",amount:315,type:"lump"}], franchiseFee:[{desc:"Franchise Safety Fee",amount:400,type:"lump"}], warranty:[], other:[{desc:"Misc",amount:195,type:"lump"}] }, documents:[], flags:[] },

  // f2 â€” flagged: materials and labor both over â€” week of Aug 4
  { id:"j6", fid:"f2", address:"17 Cedar Blvd, Rock Hill SC", customer:"Maria Nguyen", contractPrice:8800,
    status:"flagged", submittedAt:"2025-08-04", createdAt:"2025-07-28",
    estimated:{ materials:2400, labor:1800, dump:280, franchiseFee:340, warranty:0, other:120 },
    actuals:{ materials:[{desc:"Shingles",amount:3100,type:"line"},{desc:"Underlayment",amount:510,type:"line"}], labor:[{desc:"Crew",amount:2400,type:"line"}], dump:[{desc:"Disposal",amount:400,type:"lump"}], franchiseFee:[{desc:"Franchise Safety Fee",amount:340,type:"lump"}], warranty:[], other:[{desc:"Misc",amount:130,type:"lump"}] }, documents:[], flags:[] },

  // f3 â€” pending review, clean â€” week of Aug 11
  { id:"j7", fid:"f3", address:"789 Summit Dr, Nashville TN", customer:"Bill Chen", contractPrice:16200,
    status:"pending_review", submittedAt:"2025-08-12", createdAt:"2025-08-04",
    estimated:{ materials:5100, labor:3100, dump:420, franchiseFee:620, warranty:0, other:280 },
    actuals:{ materials:[{desc:"Premium Shingles",amount:4100,type:"line"},{desc:"Synthetic Underlayment",amount:780,type:"line"},{desc:"Flashing kit",amount:420,type:"line"}], labor:[{desc:"Elite crew",amount:3100,type:"line"}], dump:[{desc:"Haul-off",amount:430,type:"lump"}], franchiseFee:[{desc:"Franchise Safety Fee",amount:620,type:"lump"}], warranty:[], other:[{desc:"Permits",amount:290,type:"lump"}] }, documents:[], flags:[] },

  // f4 â€” flagged: labor way over â€” week of Aug 18
  { id:"j8", fid:"f4", address:"44 Willow Way, Columbus OH", customer:"Amy Reed", contractPrice:9600,
    status:"flagged", submittedAt:"2025-08-18", createdAt:"2025-08-11",
    estimated:{ materials:2800, labor:1900, dump:260, franchiseFee:370, warranty:0, other:140 },
    actuals:{ materials:[{desc:"Standard shingles",amount:2850,type:"line"},{desc:"Underlayment",amount:520,type:"line"}], labor:[{desc:"Crew â€” extra day",amount:2750,type:"line"}], dump:[{desc:"Haul-off",amount:295,type:"lump"}], franchiseFee:[{desc:"Franchise Safety Fee",amount:370,type:"lump"}], warranty:[], other:[{desc:"Misc",amount:150,type:"lump"}] }, documents:[], flags:[] },

  // f4 â€” open, estimates only
  { id:"j9", fid:"f4", address:"103 Ash Ct, Dayton OH", customer:"George King", contractPrice:10100,
    status:"open", createdAt:"2025-08-21",
    estimated:{ materials:2900, labor:2000, dump:290, franchiseFee:390, warranty:0, other:160 },
    actuals:{ materials:[], labor:[], dump:[], franchiseFee:[], warranty:[], other:[] }, documents:[], flags:[] },

  // f5 â€” approved, pending payouts â€” week of Aug 11
  { id:"j10", fid:"f5", address:"612 Ridge Rd, Indianapolis IN", customer:"Nancy Wright", contractPrice:12800,
    status:"approved", submittedAt:"2025-08-12", createdAt:"2025-08-05", approvedAt:"2025-08-15",
    estimated:{ materials:3600, labor:2600, dump:340, franchiseFee:490, warranty:0, other:200 },
    actuals:{ materials:[{desc:"GAF Premium",amount:3300,type:"line"},{desc:"Ice & water shield",amount:680,type:"line"}], labor:[{desc:"Install crew",amount:2700,type:"line"}], dump:[{desc:"Haul-off",amount:350,type:"lump"}], franchiseFee:[{desc:"Franchise Safety Fee",amount:490,type:"lump"}], warranty:[], other:[{desc:"Permits & fees",amount:310,type:"lump"}] },
    documents:[
      { id:"d10a", name:"GAF_Invoice_RidgeRd.pdf",    size:265000, uploadedBy:"Derek Thompson", uploadedByRole:"bm", uploadedAt:"2025-08-11", assignedTo:["materials-0","materials-1"] },
      { id:"d10b", name:"CrewTimesheet_RidgeRd.xlsx", size:38000,  uploadedBy:"Derek Thompson", uploadedByRole:"bm", uploadedAt:"2025-08-11", assignedTo:["labor-0"] },
    ],
    flags:[], payouts:{ materials:[{payee:"GAF Supply Midwest",amount:3980,status:"pending"}], subs:[], franchisee:{ gross:12800, costs:7830, net:4970, status:"pending" } } },
];

// â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
// VARIANCE-BASED FLAG ENGINE
//
// Business rules (confirmed):
//   materials:    flag if actual > est+5% OR actual < est (missing entries)
//   labor:        flag if actual > est+5% OR actual < est (missing entries)
//   dump:         flag if actual > est+12% (loose â€” small variable cost)
//   franchiseFee: FIXED â€” never flagged, always matches the set amount
//   other:        flag if actual > est+15%
//
// Franchise Safety Fee is set by HQ, never varies, never flagged.
// â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€

// Per-category variance tolerance (%) â€” over threshold triggers ğŸ”´ flag
// Under threshold triggers ğŸŸ¡ flag for materials/labor (possible missing entries)
// franchiseFee has no tolerance â€” it's a fixed fee, never evaluated
const VARIANCE_TOLERANCES = {
  materials:    5,   // 4Kâ€“6K+ range â€” tight, flag if >5% over
  labor:        5,   // predictable â€” tight, flag if >5% over
  dump:         12,  // small variable cost â€” moderate tolerance
  franchiseFee: null,// FIXED by HQ â€” never flagged
  warranty:     10,  // varies by warranty tier â€” moderate tolerance
  other:        15,  // catch-all â€” loose tolerance
};

// Whether a category can trigger an "under" flag (possible missing entries)
const CAN_FLAG_UNDER = { materials:true, labor:true, dump:false, franchiseFee:false, warranty:false, other:false };

const CAT_META = {
  materials:    { label:"Materials",           icon:"ğŸªš", color:C.accent  },
  labor:        { label:"Labor",               icon:"ğŸ‘·", color:C.blue    },
  dump:         { label:"Dump Fees",           icon:"ğŸš›", color:C.orange  },
  franchiseFee: { label:"Franchise Safety Fee",icon:"ğŸ›¡ï¸", color:C.purple  },
  warranty:     { label:"Warranties",          icon:"ğŸ“‹", color:C.green   },
  other:        { label:"Other",               icon:"ğŸ“¦", color:C.muted   },
};

// Sum all line items in one actual category
function actualCatTotal(actuals, cat) {
  return (actuals?.[cat] || []).reduce((a,b)=>a+(Number(b.amount)||0), 0);
}

// Full job margin from actuals
function calcJobMargin(job) {
  const cats = ["materials","labor","dump","franchiseFee","warranty","other"];
  const totalCost = cats.reduce((a,cat)=>a+actualCatTotal(job.actuals,cat), 0);
  const gp     = job.contractPrice - totalCost;
  const margin = job.contractPrice > 0 ? (gp/job.contractPrice)*100 : 0;
  return { totalCost, gp, margin };
}

// Per-category variance analysis
function calcVariances(job) {
  const cats = ["materials","labor","dump","franchiseFee","warranty","other"];
  return cats.map(cat => {
    const est    = Number(job.estimated?.[cat] || 0);
    const actual = actualCatTotal(job.actuals, cat);
    const hasActuals = (job.actuals?.[cat]?.length || 0) > 0;
    const diff   = actual - est;
    const variancePct = est > 0 ? (diff / est) * 100 : 0;
    const tolerance   = VARIANCE_TOLERANCES[cat]; // null = fixed, never flag

    // franchiseFee is fixed â€” never over or under
    const isFixed = tolerance === null;
    const over  = !isFixed && hasActuals && est > 0 && variancePct >  tolerance;
    const under = !isFixed && CAN_FLAG_UNDER[cat] && hasActuals && est > 0 && variancePct < -tolerance;

    return { cat, est, actual, diff, variancePct, tolerance, over, under, hasActuals, isFixed };
  });
}

// Derive flags from variances
function evaluateFlags(job) {
  const variances = calcVariances(job);
  const flags = [];
  const cats  = ["materials","labor","dump","franchiseFee","warranty","other"];
  const hasAnyActuals = cats.some(c=>(job.actuals?.[c]?.length||0)>0);

  if (!hasAnyActuals && job.status !== "open") {
    flags.push({ key:"no_costs", label:"No Actuals Entered", icon:"ğŸ”´", color:C.red, tip:"Job submitted with no actual cost data." });
    return flags;
  }

  variances.forEach(v => {
    if (v.over) flags.push({
      key:`${v.cat}_over`,
      label:`${CAT_META[v.cat].label} over by ${v.variancePct.toFixed(1)}%`,
      icon:"ğŸ”´", color:C.red,
      tip:`Actual ${CAT_META[v.cat].label.toLowerCase()} ($${v.actual.toLocaleString()}) is $${Math.abs(v.diff).toLocaleString()} over estimate ($${v.est.toLocaleString()}) â€” ${v.variancePct.toFixed(1)}% vs Â±${v.tolerance}% tolerance.`,
    });
    if (v.under) flags.push({
      key:`${v.cat}_under`,
      label:`${CAT_META[v.cat].label} under by ${Math.abs(v.variancePct).toFixed(1)}%`,
      icon:"ğŸŸ¡", color:C.orange,
      tip:`Actual ${CAT_META[v.cat].label.toLowerCase()} ($${v.actual.toLocaleString()}) is $${Math.abs(v.diff).toLocaleString()} below estimate ($${v.est.toLocaleString()}). Verify no costs are missing.`,
    });
  });

  return flags;
}

// â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
// HELPERS
// â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
const fmtDollar = v => {
  const n = Number(v)||0;
  return "$"+(n>=1000000?(n/1000000).toFixed(2)+"M":n>=1000?(n/1000).toFixed(0)+"K":n.toLocaleString());
};
const fmtDollarFull = v => "$"+Number(v).toLocaleString();
const fmtPct = v => Number(v).toFixed(1)+"%";

const STATUS_META = {
  open:            { label:"Open",           color:C.muted,  bg:C.subtle,    icon:"ğŸ”“" },
  pending_review:  { label:"Pending Review", color:C.accent, bg:C.accentDim, icon:"â³" },
  flagged:         { label:"Flagged",        color:C.red,    bg:C.redDim,    icon:"ğŸš©" },
  approved:        { label:"Approved",       color:C.green,  bg:C.greenDim,  icon:"âœ…" },
  closed:          { label:"Closed",         color:C.blue,   bg:C.blueDim,   icon:"ğŸ”’" },
};

function StatusBadge({ status, small }) {
  const m = STATUS_META[status] || STATUS_META.open;
  return (
    <span style={{ background:m.bg, color:m.color, borderRadius:99, padding:small?"2px 8px":"4px 10px", fontSize:small?11:12, fontFamily:"'Inter',sans-serif", fontWeight:600, whiteSpace:"nowrap" }}>
      {m.icon} {m.label}
    </span>
  );
}

function FlagBadge({ flag }) {
  // flag is now an object: { key, label, icon, color, tip }
  if (!flag || !flag.color) return null;
  return (
    <span title={flag.tip} style={{ background:flag.color+"22", color:flag.color, borderRadius:99, padding:"3px 9px", fontSize:11, fontFamily:"'Inter',sans-serif", fontWeight:600, cursor:"help", whiteSpace:"nowrap" }}>
      {flag.icon} {flag.label}
    </span>
  );
}

function Ring({ pct, size=56, stroke=5, color=C.accent, children }) {
  const r=(size-stroke)/2, circ=2*Math.PI*r, filled=Math.min(pct/100,1)*circ;
  return (
    <div style={{ position:"relative", width:size, height:size, flexShrink:0 }}>
      <svg width={size} height={size} style={{ transform:"rotate(-90deg)" }}>
        <circle cx={size/2} cy={size/2} r={r} fill="none" stroke={C.border} strokeWidth={stroke}/>
        <circle cx={size/2} cy={size/2} r={r} fill="none" stroke={color} strokeWidth={stroke} strokeDasharray={`${filled} ${circ}`} strokeLinecap="round" style={{ transition:"stroke-dasharray 0.6s" }}/>
      </svg>
      <div style={{ position:"absolute", inset:0, display:"flex", alignItems:"center", justifyContent:"center" }}>{children}</div>
    </div>
  );
}

function KPI({ icon, label, value, sub, color, onClick }) {
  return (
    <div onClick={onClick} style={{ background:C.card, border:`1px solid ${C.border}`, borderRadius:14, padding:"16px 18px", cursor:onClick?"pointer":"default", position:"relative", overflow:"hidden" }}>
      <div style={{ position:"absolute", top:0, right:0, width:55, height:55, background:(color||C.accent)+"10", borderRadius:"0 14px 0 55px" }}/>
      <div style={{ fontSize:18, marginBottom:6 }}>{icon}</div>
      <div style={{ color:C.muted, fontSize:11, fontFamily:"'Inter',sans-serif", fontWeight:500, marginBottom:3 }}>{label}</div>
      <div style={{ color:color||C.text, fontSize:22, fontWeight:700, fontFamily:"'Cabinet Grotesk',sans-serif", lineHeight:1 }}>{value}</div>
      {sub && <div style={{ color:C.muted, fontSize:11, marginTop:4 }}>{sub}</div>}
    </div>
  );
}

const inputStyle = { width:"100%", boxSizing:"border-box", background:C.panel, border:`1px solid ${C.border}`, borderRadius:9, padding:"10px 13px", color:C.text, fontSize:13, fontFamily:"'Inter',sans-serif", outline:"none" };
const btnPrimary = { background:C.accent, color:"#0A0C10", border:"none", borderRadius:9, padding:"10px 18px", fontWeight:800, cursor:"pointer", fontSize:13, fontFamily:"'Cabinet Grotesk',sans-serif" };

// â”€â”€ Comma-formatted number input
// Displays with commas (1,000 / 10,000 / 1,000,000)
// Stores as raw numeric string internally
// No slashed zeros â€” uses Inter, not monospace
function NumericInput({ value, onChange, placeholder, style, onKeyDown }) {
  const [display, setDisplay] = useState(() => {
    const n = Number(String(value).replace(/,/g,""));
    return n > 0 ? n.toLocaleString("en-US") : (value ? String(value) : "");
  });

  // Keep display in sync if value changes externally (e.g. on reset)
  useEffect(() => {
    const n = Number(String(value).replace(/,/g,""));
    if (!isNaN(n) && n > 0) {
      setDisplay(n.toLocaleString("en-US"));
    } else if (!value && value !== 0) {
      setDisplay("");
    }
  }, [value]);

  function handleChange(e) {
    const raw = e.target.value.replace(/,/g,"").replace(/[^0-9.]/g,"");
    // Format with commas â€” split on decimal to preserve it
    const parts = raw.split(".");
    parts[0] = parts[0].replace(/\B(?=(\d{3})+(?!\d))/g, ",");
    const formatted = parts.join(".");
    setDisplay(formatted);
    onChange(raw); // pass raw numeric string up
  }

  const numInputStyle = {
    ...inputStyle,
    fontFamily:"'Inter',sans-serif",
    fontVariantNumeric:"tabular-nums",
    ...(style||{}),
  };

  return (
    <input
      type="text"
      inputMode="decimal"
      value={display}
      onChange={handleChange}
      onKeyDown={onKeyDown}
      placeholder={placeholder}
      style={numInputStyle}
    />
  );
}
const btnSecondary = { background:C.panel, color:C.muted, border:`1px solid ${C.border}`, borderRadius:9, padding:"10px 16px", fontWeight:600, cursor:"pointer", fontSize:13 };
const btnDanger = { background:C.redDim, color:C.red, border:`1px solid ${C.red}33`, borderRadius:9, padding:"8px 14px", fontWeight:700, cursor:"pointer", fontSize:12 };

// â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
// DOCUMENT SYSTEM
//
// Ownership rules:
//   BM  â†’ uploads receipts, can delete them, receives all docs from suppliers/labor
//   Franchisee â†’ reads receipts, assigns them to their cost line items, cannot delete
//
// Submission block:
//   A job cannot be submitted while any BM-uploaded document is unassigned.
//   Costs do NOT need receipts â€” only receipts need to be assigned.
// â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€

function fileIcon(name) {
  const ext = (name||"").split(".").pop().toLowerCase();
  if (ext==="pdf")                                            return { icon:"ğŸ“„", color:C.red    };
  if (["jpg","jpeg","png","gif","webp","heic"].includes(ext)) return { icon:"ğŸ–¼ï¸", color:C.blue   };
  if (["xls","xlsx","csv"].includes(ext))                     return { icon:"ğŸ“Š", color:C.green  };
  if (["doc","docx"].includes(ext))                           return { icon:"ğŸ“", color:C.blue   };
  return                                                             { icon:"ğŸ“", color:C.muted  };
}

function fmtBytes(b) {
  if (!b) return "";
  if (b < 1024)        return b+"B";
  if (b < 1048576)     return (b/1024).toFixed(0)+"KB";
  return (b/1048576).toFixed(1)+"MB";
}

// Flat list of all actual cost line items for the assignment picker
function buildCostLineItems(actuals) {
  const cats = ["materials","labor","dump","franchiseFee","warranty","other"];
  const items = [];
  cats.forEach(cat => {
    (actuals?.[cat]||[]).forEach((item, idx) => {
      items.push({ id:`${cat}-${idx}`, cat, idx, desc:item.desc, amount:item.amount });
    });
  });
  return items;
}

// â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
// DocumentPanel
//   viewerRole: "franchisee" | "bm"
//   docs: array of doc objects
//   actuals: current actuals (for line item picker)
//   onDocsChange: (newDocs) => void
// â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
function DocumentPanel({ docs, actuals, viewerRole, viewerName, onDocsChange, onActualsChange }) {
  const [selectedDoc, setSelectedDoc] = useState(docs.length > 0 ? docs[0].id : null);
  const [assigning,   setAssigning]   = useState(null);  // BM mode only
  const [dragOver,    setDragOver]    = useState(false);
  // Inline "add cost + assign" form â€” franchisee mode
  const [addForm, setAddForm]   = useState({ cat:"materials", desc:"", amount:"", type:"line", supplier:"", subId:"" });
  const [addMode, setAddMode]   = useState(false);

  const isBM        = viewerRole === "bm";
  const lineItems   = buildCostLineItems(actuals);
  const unassigned  = docs.filter(d => !d.assignedTo || d.assignedTo.length === 0);
  const cats        = ["materials","labor","dump","franchiseFee","warranty","other"];
  const uploadInputId = `doc-upload-bm-${Math.random().toString(36).slice(2,6)}`;

  const activeDoc = docs.find(d => d.id === selectedDoc) || docs[0] || null;

  function handleFiles(files) {
    if (!isBM) return;
    const newDocs = Array.from(files).map(f => ({
      id: `doc-${Date.now()}-${Math.random().toString(36).slice(2,7)}`,
      name: f.name, size: f.size,
      uploadedBy: viewerName,
      uploadedAt: new Date().toISOString().slice(0,10),
      assignedTo: [],
    }));
    const updated = [...docs, ...newDocs];
    onDocsChange(updated);
    if (!selectedDoc) setSelectedDoc(newDocs[0]?.id);
  }

  function removeDoc(docId) {
    if (!isBM) return;
    const updated = docs.filter(d => d.id !== docId);
    onDocsChange(updated);
    if (selectedDoc === docId) setSelectedDoc(updated[0]?.id || null);
  }

  function toggleAssignment(docId, costId) {
    onDocsChange(docs.map(d => {
      if (d.id !== docId) return d;
      const already = (d.assignedTo||[]).includes(costId);
      return { ...d, assignedTo: already ? d.assignedTo.filter(x=>x!==costId) : [...d.assignedTo, costId] };
    }));
  }

  // Franchisee: add a cost item AND assign this doc to it in one step
  function addCostAndAssign() {
    if (!addForm.desc.trim() || !addForm.amount || !activeDoc) return;
    const cat   = addForm.cat;
    const item  = { desc:addForm.desc, amount:Number(addForm.amount), type:addForm.type };
    if (cat === "materials" && addForm.supplier.trim()) item.supplier = addForm.supplier.trim();
    if (cat === "labor"     && addForm.subId.trim())    item.subId    = addForm.subId.trim();

    // Add item to actuals
    const newActuals = { ...actuals, [cat]: [...(actuals[cat]||[]), item] };
    onActualsChange && onActualsChange(newActuals);

    // Build the new cost ID (it'll be at the last index)
    const newIdx   = newActuals[cat].length - 1;
    const newCostId = `${cat}-${newIdx}`;

    // Assign the document to the new cost item
    onDocsChange(docs.map(d =>
      d.id === activeDoc.id
        ? { ...d, assignedTo: [...(d.assignedTo||[]), newCostId] }
        : d
    ));

    setAddForm({ cat:"materials", desc:"", amount:"", type:"line", supplier:"", subId:"" });
    setAddMode(false);
  }

  // â”€â”€ Document viewer area â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
  function DocViewer({ doc }) {
    if (!doc) return null;
    const ext  = (doc.name||"").split(".").pop().toLowerCase();
    const isPdf  = ext === "pdf";
    const isImg  = ["jpg","jpeg","png","gif","webp","heic"].includes(ext);
    const { icon, color } = fileIcon(doc.name);

    // In production these would be real signed URLs from Supabase Storage.
    // In the prototype we render a styled placeholder that looks like a viewer chrome.
    return (
      <div style={{ background:"#0D1117", border:`1px solid ${C.border}`, borderRadius:12, overflow:"hidden", height:"100%", minHeight:480, display:"flex", flexDirection:"column" }}>
        {/* Viewer toolbar */}
        <div style={{ background:C.card, borderBottom:`1px solid ${C.border}`, padding:"8px 14px", display:"flex", alignItems:"center", gap:10 }}>
          <span style={{ fontSize:16 }}>{icon}</span>
          <span style={{ color:C.text, fontSize:12, fontWeight:600, flex:1, overflow:"hidden", textOverflow:"ellipsis", whiteSpace:"nowrap" }}>{doc.name}</span>
          <span style={{ color:C.muted, fontSize:11 }}>{fmtBytes(doc.size)}</span>
        </div>
        {/* Viewer body â€” placeholder (production: <iframe src={signedUrl}> or <img>) */}
        <div style={{ flex:1, display:"flex", flexDirection:"column", alignItems:"center", justifyContent:"center", gap:14, padding:24, background:"#0D1117" }}>
          <span style={{ fontSize:52, filter:"grayscale(0.3)" }}>{icon}</span>
          <div style={{ color:C.muted, fontSize:13, textAlign:"center", lineHeight:1.8 }}>
            <div style={{ color:C.text, fontWeight:600, marginBottom:4 }}>{doc.name}</div>
            <div>{isPdf ? "PDF document" : isImg ? "Image file" : "Document"} Â· {fmtBytes(doc.size)}</div>
            <div style={{ marginTop:4, fontSize:11 }}>Uploaded by <span style={{ color:C.blue }}>{doc.uploadedBy}</span> on {doc.uploadedAt}</div>
          </div>
          <a
            href="#"
            onClick={e=>e.preventDefault()}
            style={{ background:C.blueDim, color:C.blue, border:`1px solid ${C.blue}33`, borderRadius:8, padding:"7px 16px", fontSize:12, fontWeight:600, textDecoration:"none" }}
          >
            â†— Open full document
          </a>
          <div style={{ color:C.muted, fontSize:10, opacity:0.6 }}>
            (In production, document renders inline here via secure signed URL)
          </div>
        </div>
      </div>
    );
  }

  // â”€â”€ BM layout â€” same as before but with sidebar doc list â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
  if (isBM) {
    return (
      <div>
        <div style={{ display:"flex", alignItems:"center", justifyContent:"space-between", marginBottom:10 }}>
          <div style={{ color:C.muted, fontSize:11, fontWeight:500 }}>ğŸ“ JOB DOCUMENTS ({docs.length})</div>
          <div style={{ display:"flex", gap:8, alignItems:"center" }}>
            {unassigned.length > 0
              ? <span style={{ background:C.redDim, color:C.red, borderRadius:99, padding:"3px 10px", fontSize:11, fontWeight:600 }}>âš  {unassigned.length} unassigned</span>
              : docs.length > 0 && <span style={{ background:C.greenDim, color:C.green, borderRadius:99, padding:"3px 10px", fontSize:11, fontWeight:600 }}>âœ“ All assigned</span>
            }
          </div>
        </div>
        <div style={{ background:C.blueDim, border:`1px solid ${C.blue}33`, borderRadius:9, padding:"9px 13px", marginBottom:12, fontSize:12, color:C.muted }}>
          <span style={{ color:C.blue, fontWeight:700 }}>ğŸ‘” BM:</span> Upload and manage receipts. Franchisee will assign them to their cost line items.
        </div>
        {/* Upload zone */}
        <div
          onDragOver={e=>{ e.preventDefault(); setDragOver(true); }}
          onDragLeave={()=>setDragOver(false)}
          onDrop={e=>{ e.preventDefault(); setDragOver(false); handleFiles(e.dataTransfer.files); }}
          onClick={()=>document.getElementById(uploadInputId).click()}
          style={{ border:`2px dashed ${dragOver?C.blue:C.border}`, borderRadius:11, padding:"16px 14px", textAlign:"center", background:dragOver?C.blueDim:"transparent", transition:"all 0.15s", marginBottom:14, cursor:"pointer" }}
        >
          <input id={uploadInputId} type="file" multiple style={{ display:"none" }} onChange={e=>handleFiles(e.target.files)} />
          <div style={{ fontSize:22, marginBottom:4 }}>ğŸ“¤</div>
          <div style={{ color:dragOver?C.blue:C.muted, fontSize:13 }}>Drop receipts/invoices here or <span style={{ color:C.blue, textDecoration:"underline" }}>browse</span></div>
          <div style={{ color:C.muted, fontSize:10, marginTop:3 }}>Any file type â€” PDFs, images, spreadsheets, docs</div>
        </div>
        {/* Doc list */}
        {docs.map(doc => {
          const { icon } = fileIcon(doc.name);
          const isUnassigned  = !doc.assignedTo || doc.assignedTo.length === 0;
          const isAssigningThis = assigning === doc.id;
          const assignedItems  = lineItems.filter(li => (doc.assignedTo||[]).includes(li.id));
          return (
            <div key={doc.id} style={{ background:C.panel, border:`1px solid ${isUnassigned?C.red+"55":C.border}`, borderRadius:10, padding:"11px 13px", marginBottom:8 }}>
              <div style={{ display:"flex", alignItems:"flex-start", gap:9 }}>
                <span style={{ fontSize:20, flexShrink:0, marginTop:1 }}>{icon}</span>
                <div style={{ flex:1, minWidth:0 }}>
                  <div style={{ color:C.text, fontSize:13, fontWeight:600, overflow:"hidden", textOverflow:"ellipsis", whiteSpace:"nowrap" }}>{doc.name}</div>
                  <div style={{ display:"flex", gap:8, flexWrap:"wrap", marginTop:3 }}>
                    {doc.size && <span style={{ color:C.muted, fontSize:11 }}>{fmtBytes(doc.size)}</span>}
                    <span style={{ background:C.blueDim, color:C.blue, fontSize:10, fontWeight:600, padding:"2px 7px", borderRadius:4 }}>ğŸ‘” {doc.uploadedBy}</span>
                    <span style={{ color:C.muted, fontSize:11 }}>{doc.uploadedAt}</span>
                  </div>
                  {!isAssigningThis && assignedItems.length > 0 && (
                    <div style={{ display:"flex", gap:5, flexWrap:"wrap", marginTop:7 }}>
                      {assignedItems.map(li => (
                        <span key={li.id} style={{ background:CAT_META[li.cat].color+"22", color:CAT_META[li.cat].color, borderRadius:99, padding:"3px 9px", fontSize:11, fontWeight:500 }}>
                          {CAT_META[li.cat].icon} {li.desc} Â· {fmtDollarFull(li.amount)}
                        </span>
                      ))}
                    </div>
                  )}
                </div>
                <div style={{ display:"flex", flexDirection:"column", alignItems:"flex-end", gap:5, flexShrink:0 }}>
                  <div style={{ display:"flex", alignItems:"center", gap:6 }}>
                    {isUnassigned
                      ? <span style={{ color:C.red, fontSize:11, fontWeight:600 }}>âš  Unassigned</span>
                      : <span style={{ color:C.green, fontSize:11, fontWeight:600 }}>âœ“ Assigned</span>
                    }
                    <button onClick={()=>setAssigning(isAssigningThis ? null : doc.id)}
                      style={{ background:C.accentDim, color:C.accent, border:`1px solid ${C.accent}33`, borderRadius:6, padding:"3px 9px", fontSize:11, fontWeight:600, cursor:"pointer" }}>
                      {isAssigningThis ? "Done âœ“" : "Assign â†’"}
                    </button>
                    <button onClick={()=>removeDoc(doc.id)}
                      style={{ background:C.redDim, color:C.red, border:`1px solid ${C.red}33`, borderRadius:6, padding:"3px 8px", fontSize:11, cursor:"pointer", fontWeight:700 }}>âœ•</button>
                  </div>
                </div>
              </div>
              {isAssigningThis && (
                <div style={{ background:C.card, border:`1px solid ${C.border}`, borderRadius:9, padding:11, marginTop:10 }}>
                  <div style={{ color:C.muted, fontSize:11, fontWeight:500, marginBottom:9 }}>ASSIGN TO COST LINE ITEM(S)</div>
                  {lineItems.length === 0
                    ? <div style={{ color:C.muted, fontSize:12, fontStyle:"italic" }}>No cost line items entered yet.</div>
                    : lineItems.map(li => {
                        const checked = (doc.assignedTo||[]).includes(li.id);
                        const m = CAT_META[li.cat];
                        return (
                          <div key={li.id} onClick={()=>toggleAssignment(doc.id, li.id)}
                            style={{ display:"flex", alignItems:"center", gap:9, padding:"8px 10px", borderRadius:7, marginBottom:4, cursor:"pointer", background:checked?m.color+"15":C.panel, border:`1px solid ${checked?m.color+"55":C.border}` }}>
                            <div style={{ width:16, height:16, borderRadius:4, border:`2px solid ${checked?m.color:C.border}`, background:checked?m.color:"transparent", flexShrink:0, display:"flex", alignItems:"center", justifyContent:"center" }}>
                              {checked && <span style={{ color:"#0A0C10", fontSize:9, fontWeight:900 }}>âœ“</span>}
                            </div>
                            <span style={{ fontSize:11, color:m.color, fontWeight:500, flexShrink:0 }}>{m.icon} {m.label}</span>
                            <span style={{ flex:1, color:C.text, fontSize:12 }}>{li.desc}</span>
                            <span style={{ color:C.muted, fontFamily:"'DM Mono',monospace", fontSize:11 }}>{fmtDollarFull(li.amount)}</span>
                          </div>
                        );
                      })
                  }
                </div>
              )}
            </div>
          );
        })}
      </div>
    );
  }

  // â”€â”€ FRANCHISEE split-pane layout â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
  return (
    <div>
      {/* Header */}
      <div style={{ display:"flex", alignItems:"center", justifyContent:"space-between", marginBottom:10 }}>
        <div style={{ color:C.muted, fontSize:11, fontWeight:500 }}>ğŸ“ JOB DOCUMENTS ({docs.length})</div>
        {unassigned.length > 0
          ? <span style={{ background:C.redDim, color:C.red, borderRadius:99, padding:"3px 10px", fontSize:11, fontWeight:600 }}>âš  {unassigned.length} unassigned</span>
          : docs.length > 0 && <span style={{ background:C.greenDim, color:C.green, borderRadius:99, padding:"3px 10px", fontSize:11, fontWeight:600 }}>âœ“ All assigned</span>
        }
      </div>

      {/* Role hint */}
      <div style={{ background:C.panel, border:`1px solid ${C.border}`, borderRadius:9, padding:"9px 13px", marginBottom:12, fontSize:12, color:C.muted, lineHeight:1.6 }}>
        <span style={{ color:C.accent, fontWeight:700 }}>ğŸ  Franchisee:</span> Select a document to view it. You can add cost line items and assign them to the document at the same time.
      </div>

      {/* No docs yet */}
      {docs.length === 0 && (
        <div style={{ background:C.panel, border:`1px dashed ${C.border}`, borderRadius:10, padding:"32px 14px", textAlign:"center" }}>
          <div style={{ fontSize:28, marginBottom:8 }}>ğŸ“­</div>
          <div style={{ color:C.muted, fontSize:13, fontWeight:500 }}>No receipts uploaded yet</div>
          <div style={{ color:C.muted, fontSize:12, marginTop:4 }}>Your BM will upload invoices here. You can then view them and assign your cost line items.</div>
        </div>
      )}

      {docs.length > 0 && (
        <div style={{ display:"grid", gridTemplateColumns:"200px 1fr", gap:10, alignItems:"start" }}>

          {/* â”€â”€ Left sidebar: doc list â”€â”€ */}
          <div style={{ display:"flex", flexDirection:"column", gap:6 }}>
            {docs.map(doc => {
              const { icon } = fileIcon(doc.name);
              const isUnassigned = !doc.assignedTo || doc.assignedTo.length === 0;
              const isActive     = activeDoc?.id === doc.id;
              return (
                <button key={doc.id} onClick={()=>{ setSelectedDoc(doc.id); setAddMode(false); }}
                  style={{ display:"flex", alignItems:"center", gap:8, background: isActive ? C.card : C.panel, border:`1px solid ${isActive ? C.accent : isUnassigned ? C.red+"55" : C.border}`, borderRadius:9, padding:"9px 10px", cursor:"pointer", textAlign:"left", width:"100%" }}>
                  <span style={{ fontSize:18, flexShrink:0 }}>{icon}</span>
                  <div style={{ flex:1, minWidth:0 }}>
                    <div style={{ color: isActive ? C.text : C.muted, fontSize:11, fontWeight: isActive ? 600 : 400, overflow:"hidden", textOverflow:"ellipsis", whiteSpace:"nowrap" }}>{doc.name}</div>
                    <div style={{ marginTop:2 }}>
                      {isUnassigned
                        ? <span style={{ color:C.red, fontSize:10, fontWeight:600 }}>âš  Unassigned</span>
                        : <span style={{ color:C.green, fontSize:10, fontWeight:600 }}>âœ“ Assigned</span>
                      }
                    </div>
                  </div>
                </button>
              );
            })}
          </div>

          {/* â”€â”€ Right pane: viewer + assign/add â”€â”€ */}
          {activeDoc && (
            <div style={{ display:"flex", flexDirection:"column", gap:10 }}>

              {/* Document viewer */}
              <DocViewer doc={activeDoc} />

              {/* Assignment + add-cost panel */}
              <div style={{ background:C.panel, border:`1px solid ${C.border}`, borderRadius:12, padding:14 }}>
                {/* Assigned chips */}
                {(() => {
                  const assignedItems = lineItems.filter(li => (activeDoc.assignedTo||[]).includes(li.id));
                  return assignedItems.length > 0 ? (
                    <div style={{ marginBottom:12 }}>
                      <div style={{ color:C.muted, fontSize:10, fontWeight:600, marginBottom:6 }}>ASSIGNED TO</div>
                      <div style={{ display:"flex", gap:6, flexWrap:"wrap" }}>
                        {assignedItems.map(li => (
                          <span key={li.id} onClick={()=>toggleAssignment(activeDoc.id, li.id)}
                            style={{ display:"inline-flex", alignItems:"center", gap:5, background:CAT_META[li.cat].color+"22", color:CAT_META[li.cat].color, borderRadius:99, padding:"4px 10px", fontSize:11, fontWeight:500, cursor:"pointer" }}
                            title="Click to unassign">
                            {CAT_META[li.cat].icon} {li.desc} Â· {fmtDollarFull(li.amount)}
                            <span style={{ opacity:0.6, fontSize:12, marginLeft:2 }}>Ã—</span>
                          </span>
                        ))}
                      </div>
                    </div>
                  ) : null;
                })()}

                {/* Existing line items to assign */}
                {lineItems.length > 0 && (
                  <div style={{ marginBottom:12 }}>
                    <div style={{ color:C.muted, fontSize:10, fontWeight:600, marginBottom:6 }}>ASSIGN TO EXISTING COST</div>
                    <div style={{ display:"flex", flexDirection:"column", gap:4 }}>
                      {lineItems.map(li => {
                        const checked = (activeDoc.assignedTo||[]).includes(li.id);
                        const m = CAT_META[li.cat];
                        return (
                          <div key={li.id} onClick={()=>toggleAssignment(activeDoc.id, li.id)}
                            style={{ display:"flex", alignItems:"center", gap:9, padding:"8px 10px", borderRadius:7, cursor:"pointer", background:checked?m.color+"15":C.card, border:`1px solid ${checked?m.color+"55":C.border}` }}>
                            <div style={{ width:16, height:16, borderRadius:4, border:`2px solid ${checked?m.color:C.border}`, background:checked?m.color:"transparent", flexShrink:0, display:"flex", alignItems:"center", justifyContent:"center" }}>
                              {checked && <span style={{ color:"#0A0C10", fontSize:9, fontWeight:900 }}>âœ“</span>}
                            </div>
                            <span style={{ fontSize:11, color:m.color, fontWeight:500, flexShrink:0 }}>{m.icon} {m.label}</span>
                            <span style={{ flex:1, color:C.text, fontSize:12 }}>{li.desc}</span>
                            <span style={{ color:C.muted, fontFamily:"'DM Mono',monospace", fontSize:11 }}>{fmtDollarFull(li.amount)}</span>
                          </div>
                        );
                      })}
                    </div>
                  </div>
                )}

                {/* Add new cost + auto-assign */}
                {!addMode ? (
                  <button onClick={()=>setAddMode(true)}
                    style={{ width:"100%", background:C.accentDim, color:C.accent, border:`1px dashed ${C.accent}55`, borderRadius:9, padding:"10px 14px", fontSize:12, fontWeight:700, cursor:"pointer" }}>
                    + Add cost from this invoice & assign automatically
                  </button>
                ) : (
                  <div style={{ background:C.card, border:`1px solid ${C.accent}44`, borderRadius:10, padding:13 }}>
                    <div style={{ color:C.accent, fontSize:11, fontWeight:700, marginBottom:10 }}>
                      â• NEW COST â€” will auto-assign to <span style={{ color:C.text }}>{activeDoc.name}</span>
                    </div>
                    <div style={{ display:"flex", gap:8, flexWrap:"wrap", marginBottom:8 }}>
                      <select value={addForm.cat} onChange={e=>setAddForm(f=>({...f,cat:e.target.value,supplier:"",subId:""}))}
                        style={{ ...inputStyle, flex:"1 1 130px", cursor:"pointer" }}>
                        {cats.map(c=><option key={c} value={c}>{CAT_META[c].label}</option>)}
                      </select>
                      <input style={{ ...inputStyle, flex:"2 1 180px" }} placeholder="Description (e.g. GAF Timberline HDZ)"
                        value={addForm.desc} onChange={e=>setAddForm(f=>({...f,desc:e.target.value}))}
                        onKeyDown={e=>e.key==="Enter"&&addCostAndAssign()} />
                      <div style={{ position:"relative", flex:"1 1 100px" }}>
                        <span style={{ position:"absolute", left:9, top:"50%", transform:"translateY(-50%)", color:C.muted, fontSize:13, zIndex:1 }}>$</span>
                        <NumericInput value={addForm.amount} onChange={v=>setAddForm(f=>({...f,amount:v}))} placeholder="0" style={{ paddingLeft:22 }}
                          onKeyDown={e=>e.key==="Enter"&&addCostAndAssign()} />
                      </div>
                      <select value={addForm.type} onChange={e=>setAddForm(f=>({...f,type:e.target.value}))}
                        style={{ ...inputStyle, flex:"0 0 100px", cursor:"pointer" }}>
                        <option value="line">Line Item</option>
                        <option value="lump">Lump Sum</option>
                      </select>
                    </div>
                    {addForm.cat === "materials" && (
                      <input style={{ ...inputStyle, width:"100%", marginBottom:8 }}
                        placeholder="Supplier name (optional) â€” e.g. SRS Distribution, ABC Roofing Supply"
                        value={addForm.supplier} onChange={e=>setAddForm(f=>({...f,supplier:e.target.value}))} />
                    )}
                    {addForm.cat === "labor" && (
                      <input style={{ ...inputStyle, width:"100%", marginBottom:8 }}
                        placeholder="Subcontractor name or Sub ID (optional)"
                        value={addForm.subId} onChange={e=>setAddForm(f=>({...f,subId:e.target.value}))} />
                    )}
                    <div style={{ display:"flex", gap:8 }}>
                      <button onClick={()=>{ setAddMode(false); setAddForm({ cat:"materials", desc:"", amount:"", type:"line", supplier:"", subId:"" }); }}
                        style={{ ...btnSecondary, fontSize:12, padding:"8px 14px" }}>Cancel</button>
                      <button onClick={addCostAndAssign}
                        style={{ ...btnPrimary, flex:1, fontSize:12 }}>
                        âœ“ Add cost & assign to this document
                      </button>
                    </div>
                  </div>
                )}
              </div>
            </div>
          )}
        </div>
      )}
    </div>
  );
}

// â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
// JOB COSTING MODAL â€” two phases:
//   Phase 1 (Estimate): fill in expected costs per category
//   Phase 2 (Actuals):  enter real line items, see live variance
// â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
function JobCostModal({ job, onSave, onSubmit, onClose, franchiseeName }) {
  const hasEstimates = job.estimated && Object.values(job.estimated).some(v=>Number(v)>0);
  const [phase, setPhase]         = useState(hasEstimates ? "actuals" : "estimate");
  const [estimated, setEstimated] = useState({ materials:job.estimated?.materials||"", labor:job.estimated?.labor||"", dump:job.estimated?.dump||"", franchiseFee:job.estimated?.franchiseFee||"", warranty:job.estimated?.warranty||"", other:job.estimated?.other||"" });
  const [actuals, setActuals]     = useState(JSON.parse(JSON.stringify(job.actuals || { materials:[], labor:[], dump:[], franchiseFee:[], warranty:[], other:[] })));
  const [docs, setDocs]           = useState(JSON.parse(JSON.stringify(job.documents || [])));
  const [newItem, setNewItem]     = useState({ cat:"materials", desc:"", amount:"", type:"line", supplier:"", subId:"" });

  const unassignedDocs = docs.filter(d => !d.assignedTo || d.assignedTo.length === 0);

  const cats = ["materials","labor","dump","franchiseFee","warranty","other"];
  const estTotal    = cats.reduce((a,c)=>a+(Number(estimated[c])||0),0);
  const actualTotal = cats.reduce((a,c)=>a+actualCatTotal(actuals,c),0);
  const gp          = job.contractPrice - actualTotal;
  const margin      = job.contractPrice > 0 ? (gp/job.contractPrice)*100 : 0;

  // Live variance using current state
  const liveVariances = cats.map(cat => {
    const est    = Number(estimated[cat]||0);
    const actual = actualCatTotal(actuals, cat);
    const hasAct = (actuals[cat]?.length||0) > 0;
    const diff   = actual - est;
    const variancePct = est > 0 ? (diff/est)*100 : 0;
    const tol    = VARIANCE_TOLERANCES[cat]; // null = fixed
    const isFixed = tol === null;
    const over  = !isFixed && hasAct && est > 0 && variancePct > tol;
    const under = !isFixed && CAN_FLAG_UNDER[cat] && hasAct && est > 0 && variancePct < -tol;
    return { cat, est, actual, diff, variancePct, tol, over, under, hasAct, isFixed };
  });
  const anyFlag = liveVariances.some(v=>v.over||v.under);

  function addActualItem() {
    if (!newItem.desc.trim() || !newItem.amount) return;
    const item = { desc:newItem.desc, amount:Number(newItem.amount), type:newItem.type };
    if (newItem.cat === "materials" && newItem.supplier.trim()) item.supplier = newItem.supplier.trim();
    if (newItem.cat === "labor"     && newItem.subId.trim())    item.subId    = newItem.subId.trim();
    setActuals(a=>({ ...a, [newItem.cat]: [...a[newItem.cat], item] }));
    setNewItem(n=>({ ...n, desc:"", amount:"", supplier:"", subId:"" }));
  }
  function removeActualItem(cat, idx) {
    setActuals(a=>({ ...a, [cat]: a[cat].filter((_,i)=>i!==idx) }));
  }

  const marginColor = margin < 25 ? C.red : margin < 35 ? C.orange : C.green;

  return (
    <div style={{ position:"fixed", inset:0, background:"#000000DD", zIndex:400, display:"flex", alignItems:"flex-start", justifyContent:"center", overflowY:"auto", padding:"16px 12px 120px" }}>
      <div style={{ background:C.card, border:`1px solid ${C.border}`, borderRadius:20, width:"100%", maxWidth:860, padding:24 }}>

        {/* Header */}
        <div style={{ display:"flex", justifyContent:"space-between", alignItems:"flex-start", marginBottom:16 }}>
          <div>
            <div style={{ color:C.muted, fontSize:11, fontFamily:"'Inter',sans-serif", fontWeight:500, marginBottom:4 }}>JOB COSTING â€” {job.id.toUpperCase()}</div>
            <div style={{ fontFamily:"'Cabinet Grotesk',sans-serif", fontWeight:900, fontSize:20, color:C.text }}>{job.address}</div>
            <div style={{ color:C.muted, fontSize:12, marginTop:2 }}>{job.customer} Â· Contract: <strong style={{ color:C.accent }}>{fmtDollarFull(job.contractPrice)}</strong></div>
          </div>
          <button onClick={onClose} style={{ ...btnSecondary, padding:"6px 12px" }}>âœ•</button>
        </div>

        {/* Phase tabs */}
        <div style={{ display:"flex", gap:0, marginBottom:20, background:C.panel, borderRadius:10, padding:4 }}>
          {[
            { id:"estimate", label:"1. Estimates" },
            { id:"actuals",  label:"2. Actuals" },
            { id:"documents",label:`3. Documents${unassignedDocs.length>0?" ("+unassignedDocs.length+")":""}` },
          ].map(p=>(
            <button key={p.id} onClick={()=>setPhase(p.id)} style={{ flex:1, background:phase===p.id?(p.id==="documents"&&unassignedDocs.length>0?C.red:C.accent):"transparent", color:phase===p.id?"#0A0C10":p.id==="documents"&&unassignedDocs.length>0?C.red:C.muted, border:"none", borderRadius:7, padding:"8px 10px", fontWeight:600, cursor:"pointer", fontSize:12, fontFamily:"'Inter',sans-serif", transition:"all 0.15s" }}>
              {p.label}
            </button>
          ))}
        </div>

        {/* â”€â”€ PHASE 1: ESTIMATES â”€â”€ */}
        {phase === "estimate" && (
          <div>
            <p style={{ color:C.muted, fontSize:12, margin:"0 0 16px", lineHeight:1.6 }}>
              Enter your expected cost for each category before the job begins. These become the benchmark â€” actuals will be compared against them when the job is submitted.
            </p>
            <div style={{ display:"grid", gridTemplateColumns:"repeat(auto-fit,minmax(220px,1fr))", gap:12, marginBottom:16 }}>
              {cats.map(cat=>{
                const m = CAT_META[cat];
                return (
                  <div key={cat}>
                    <div style={{ color:m.color, fontSize:11, fontFamily:"'Inter',sans-serif", fontWeight:600, fontWeight:700, marginBottom:6 }}>{m.icon} {m.label} <span style={{ color:C.muted, fontWeight:400 }}>Â±{VARIANCE_TOLERANCES[cat]}% tol.</span></div>
                    <div style={{ position:"relative" }}>
                      <span style={{ position:"absolute", left:10, top:"50%", transform:"translateY(-50%)", color:C.muted, zIndex:1 }}>$</span>
                      <NumericInput
                        value={estimated[cat]}
                        onChange={v=>setEstimated(est=>({...est,[cat]:v}))}
                        placeholder="0"
                        style={{ paddingLeft:22 }}
                      />
                    </div>
                  </div>
                );
              })}
            </div>
            {estTotal > 0 && (
              <div style={{ background:C.panel, borderRadius:10, padding:"12px 16px", marginBottom:16, display:"flex", justifyContent:"space-between", flexWrap:"wrap", gap:10 }}>
                <div><div style={{ color:C.muted, fontSize:11, fontFamily:"'Inter',sans-serif", fontWeight:500 }}>ESTIMATED TOTAL COST</div><div style={{ color:C.text, fontFamily:"'Cabinet Grotesk',sans-serif", fontWeight:700, fontSize:20 }}>{fmtDollarFull(estTotal)}</div></div>
                <div><div style={{ color:C.muted, fontSize:11, fontFamily:"'Inter',sans-serif", fontWeight:500 }}>ESTIMATED GROSS PROFIT</div><div style={{ color:C.green, fontFamily:"'Cabinet Grotesk',sans-serif", fontWeight:700, fontSize:20 }}>{fmtDollarFull(job.contractPrice-estTotal)}</div></div>
                <div><div style={{ color:C.muted, fontSize:11, fontFamily:"'Inter',sans-serif", fontWeight:500 }}>ESTIMATED MARGIN</div><div style={{ color:C.green, fontFamily:"'Cabinet Grotesk',sans-serif", fontWeight:700, fontSize:20 }}>{fmtPct(job.contractPrice>0?((job.contractPrice-estTotal)/job.contractPrice)*100:0)}</div></div>
              </div>
            )}
            <div style={{ display:"flex", gap:10 }}>
              <button onClick={()=>{ onSave({ estimated, actuals }); onClose(); }} style={btnSecondary}>Save Estimates</button>
              <button onClick={()=>{ onSave({ estimated, actuals }); setPhase("actuals"); }} style={{ ...btnPrimary, flex:1 }}>Save & Enter Actuals â†’</button>
            </div>
          </div>
        )}

        {/* â”€â”€ PHASE 2: ACTUALS â”€â”€ */}
        {phase === "actuals" && (
          <div>
            {/* Live margin bar */}
            <div style={{ background:C.panel, border:`2px solid ${marginColor}55`, borderRadius:12, padding:"12px 16px", marginBottom:16, display:"flex", justifyContent:"space-between", alignItems:"center", flexWrap:"wrap", gap:10 }}>
              <div style={{ display:"flex", gap:18, flexWrap:"wrap" }}>
                {[
                  { l:"Contract",    v:fmtDollarFull(job.contractPrice), c:C.text },
                  { l:"Actual Cost", v:fmtDollarFull(actualTotal),       c:C.text },
                  { l:"Gross Profit",v:fmtDollarFull(gp),                c:gp>=0?C.green:C.red },
                ].map(s=><div key={s.l}><div style={{ color:C.muted, fontSize:11, fontFamily:"'Inter',sans-serif", fontWeight:500 }}>{s.l}</div><div style={{ color:s.c, fontFamily:"'Cabinet Grotesk',sans-serif", fontWeight:700, fontSize:18 }}>{s.v}</div></div>)}
              </div>
              <div style={{ textAlign:"center" }}>
                <div style={{ color:C.muted, fontSize:11, fontFamily:"'Inter',sans-serif", fontWeight:500 }}>ACTUAL MARGIN</div>
                <div style={{ color:marginColor, fontFamily:"'Cabinet Grotesk',sans-serif", fontWeight:900, fontSize:26 }}>{fmtPct(margin)}</div>
              </div>
            </div>

            {/* Variance comparison table */}
            <div style={{ background:C.panel, border:`1px solid ${C.border}`, borderRadius:12, padding:14, marginBottom:16 }}>
              <div style={{ color:C.muted, fontSize:11, fontFamily:"'Inter',sans-serif", fontWeight:500, letterSpacing:0, marginBottom:12 }}>ESTIMATED vs ACTUAL â€” VARIANCE ANALYSIS</div>
              {/* Column headers */}
              <div style={{ display:"grid", gridTemplateColumns:"1fr 115px 115px 110px 140px", gap:0, marginBottom:4, padding:"0 8px" }}>
                {["Category","Estimated","Actual","Difference","Variance"].map(h=>(
                  <div key={h} style={{ color:C.muted, fontSize:10, fontFamily:"'Inter',sans-serif", fontWeight:600, textAlign:h==="Category"?"left":"right", paddingRight: h==="Category"?0:8 }}>{h}</div>
                ))}
              </div>
              {liveVariances.map(v=>{
                const m = CAT_META[v.cat];
                const rowColor = v.over ? C.red : v.under ? C.orange : v.hasAct ? C.green : C.muted;
                const icon = v.over ? "ğŸ”´" : v.under ? "ğŸŸ¡" : v.hasAct ? "âœ…" : "â€”";
                return (
                  <div key={v.cat} style={{ display:"grid", gridTemplateColumns:"1fr 115px 115px 110px 140px", gap:0, padding:"8px 8px", borderBottom:`1px solid ${C.border}`, alignItems:"center" }}>
                    <div style={{ color:m.color, fontSize:12, fontWeight:600 }}>{m.icon} {m.label}</div>
                    <div style={{ color:C.muted, fontSize:12, fontFamily:"'DM Mono',monospace", textAlign:"right", paddingRight:8 }}>{v.est>0?fmtDollarFull(v.est):"â€”"}</div>
                    <div style={{ color:C.text, fontSize:12, fontFamily:"'DM Mono',monospace", textAlign:"right", paddingRight:8 }}>{v.hasAct?fmtDollarFull(v.actual):"â€”"}</div>
                    <div style={{ color:v.isFixed?C.muted:v.diff>0?C.red:v.diff<0?C.green:C.muted, fontSize:12, fontFamily:"'DM Mono',monospace", textAlign:"right", paddingRight:8 }}>
                      {v.isFixed ? "â€”" : v.hasAct&&v.est>0 ? (v.diff>=0?"+":"")+fmtDollarFull(v.diff) : "â€”"}
                    </div>
                    <div style={{ display:"flex", alignItems:"center", justifyContent:"flex-end" }}>
                      {v.isFixed
                        ? <span style={{ color:C.purple, fontSize:10, fontFamily:"'Inter',sans-serif", fontWeight:600, background:C.purpleDim, borderRadius:99, padding:"2px 8px" }}>ğŸ›¡ï¸ Fixed</span>
                        : v.hasAct && v.est>0
                          ? <span style={{ color:rowColor, fontSize:11, fontFamily:"'DM Mono',monospace", fontWeight:600 }}>{icon} {(v.variancePct>=0?"+":"")+v.variancePct.toFixed(1)}% <span style={{ color:C.muted, fontWeight:400 }}>/ Â±{v.tol}%</span></span>
                          : <span style={{ color:C.muted, fontSize:11, fontFamily:"'Inter',sans-serif", fontWeight:400 }}>no actuals</span>
                      }
                    </div>
                  </div>
                );
              })}
              {/* Totals row */}
              <div style={{ display:"grid", gridTemplateColumns:"1fr 115px 115px 110px 140px", gap:0, padding:"10px 8px 2px", alignItems:"center", borderTop:`1px solid ${C.border}`, marginTop:2 }}>
                <div style={{ color:C.text, fontSize:12, fontWeight:700 }}>TOTAL</div>
                <div style={{ color:C.muted, fontSize:13, fontFamily:"'DM Mono',monospace", textAlign:"right", paddingRight:8, fontWeight:700 }}>{fmtDollarFull(estTotal)}</div>
                <div style={{ color:C.text, fontSize:13, fontFamily:"'DM Mono',monospace", textAlign:"right", paddingRight:8, fontWeight:700 }}>{fmtDollarFull(actualTotal)}</div>
                <div style={{ color:actualTotal>estTotal?C.red:C.green, fontSize:13, fontFamily:"'DM Mono',monospace", textAlign:"right", paddingRight:8, fontWeight:700 }}>{actualTotal>0&&estTotal>0?(actualTotal-estTotal>=0?"+":"")+fmtDollarFull(actualTotal-estTotal):"â€”"}</div>
                <div style={{ color:anyFlag?C.red:C.green, fontSize:11, fontFamily:"'Inter',sans-serif", fontWeight:600, textAlign:"right" }}>{anyFlag?"ğŸ”´ FLAGGED":"âœ… IN RANGE"}</div>
              </div>
            </div>

            {/* Actual line items by category */}
            {cats.map(cat=>{
              const m = CAT_META[cat];
              const items = actuals[cat]||[];
              const total = actualCatTotal(actuals,cat);
              return (
                <div key={cat} style={{ marginBottom:14 }}>
                  <div style={{ color:m.color, fontSize:12, fontFamily:"'Inter',sans-serif", fontWeight:600, marginBottom:6 }}>
                    {m.icon} {m.label} â€” {total>0?fmtDollarFull(total):"$0"}
                    {estimated[cat]>0 && <span style={{ color:C.muted, fontWeight:400 }}> (est. {fmtDollarFull(estimated[cat])})</span>}
                  </div>
                  {items.map((item,idx)=>(
                    <div key={idx} style={{ background:C.panel, borderRadius:8, padding:"7px 11px", border:`1px solid ${C.border}`, marginBottom:4 }}>
                      <div style={{ display:"flex", alignItems:"center", gap:8 }}>
                        <span style={{ background:item.type==="lump"?C.purpleDim:C.subtle, color:item.type==="lump"?C.purple:C.muted, fontSize:10, fontFamily:"'Inter',sans-serif", fontWeight:500, padding:"2px 7px", borderRadius:4, flexShrink:0 }}>{item.type==="lump"?"LUMP":"LINE"}</span>
                        <span style={{ flex:1, color:C.text, fontSize:13 }}>{item.desc}</span>
                        <span style={{ color:m.color, fontFamily:"'DM Mono',monospace", fontWeight:700, fontSize:13 }}>{fmtDollarFull(item.amount)}</span>
                        <button onClick={()=>removeActualItem(cat,idx)} style={{ background:"none", border:"none", color:C.muted, cursor:"pointer", fontSize:14 }}>âœ•</button>
                      </div>
                      {item.supplier && (
                        <div style={{ marginTop:4, display:"flex", alignItems:"center", gap:5 }}>
                          <span style={{ color:C.muted, fontSize:10 }}>ğŸª</span>
                          <span style={{ color:C.muted, fontSize:11 }}>Supplier: <span style={{ color:C.accent, fontWeight:500 }}>{item.supplier}</span></span>
                        </div>
                      )}
                      {item.subId && (
                        <div style={{ marginTop:4, display:"flex", alignItems:"center", gap:5 }}>
                          <span style={{ color:C.muted, fontSize:10 }}>ğŸ”§</span>
                          <span style={{ color:C.muted, fontSize:11 }}>Sub: <span style={{ color:C.blue, fontWeight:500 }}>{item.subId}</span></span>
                        </div>
                      )}
                    </div>
                  ))}
                </div>
              );
            })}

            {/* Add item */}
            <div style={{ background:C.panel, border:`1px solid ${C.border}`, borderRadius:11, padding:13, marginBottom:16 }}>
              <div style={{ color:C.muted, fontSize:11, fontFamily:"'Inter',sans-serif", fontWeight:500, marginBottom:10 }}>ADD ACTUAL COST ITEM</div>
              <div style={{ display:"flex", gap:8, flexWrap:"wrap" }}>
                <select value={newItem.cat} onChange={e=>setNewItem(n=>({...n,cat:e.target.value,supplier:"",subId:""}))} style={{ ...inputStyle, flex:"1 1 130px", cursor:"pointer" }}>
                  {cats.map(c=><option key={c} value={c}>{CAT_META[c].label}</option>)}
                </select>
                <input style={{ ...inputStyle, flex:"2 1 180px" }} placeholder="Description" value={newItem.desc}
                  onChange={e=>setNewItem(n=>({...n,desc:e.target.value}))} onKeyDown={e=>e.key==="Enter"&&addActualItem()} />
                <div style={{ position:"relative", flex:"1 1 100px" }}>
                  <span style={{ position:"absolute", left:9, top:"50%", transform:"translateY(-50%)", color:C.muted, fontSize:13, zIndex:1 }}>$</span>
                  <NumericInput
                    value={newItem.amount}
                    onChange={v=>setNewItem(n=>({...n,amount:v}))}
                    placeholder="0"
                    style={{ paddingLeft:22 }}
                    onKeyDown={e=>e.key==="Enter"&&addActualItem()}
                  />
                </div>
                <select value={newItem.type} onChange={e=>setNewItem(n=>({...n,type:e.target.value}))} style={{ ...inputStyle, flex:"0 0 100px", cursor:"pointer" }}>
                  <option value="line">Line Item</option>
                  <option value="lump">Lump Sum</option>
                </select>
                <button onClick={addActualItem} style={{ ...btnPrimary, flexShrink:0 }}>+ Add</button>
              </div>
              {/* Contextual extra field: supplier for materials, sub ID for labor */}
              {newItem.cat === "materials" && (
                <div style={{ marginTop:8 }}>
                  <input
                    style={{ ...inputStyle, width:"100%" }}
                    placeholder="Supplier name (optional) â€” e.g. ABC Roofing Supply, SRS Distribution"
                    value={newItem.supplier}
                    onChange={e=>setNewItem(n=>({...n,supplier:e.target.value}))}
                  />
                </div>
              )}
              {newItem.cat === "labor" && (
                <div style={{ marginTop:8 }}>
                  <input
                    style={{ ...inputStyle, width:"100%" }}
                    placeholder="Subcontractor name or Sub ID (optional) â€” e.g. Martinez Roofing LLC, SUB-2041"
                    value={newItem.subId}
                    onChange={e=>setNewItem(n=>({...n,subId:e.target.value}))}
                  />
                </div>
              )}
              {newItem.cat === "warranty" && (
                <div style={{ marginTop:8, color:C.muted, fontSize:11, lineHeight:1.6, padding:"6px 10px", background:C.greenDim, borderRadius:7, border:`1px solid ${C.green}33` }}>
                  ğŸ“‹ Include the warranty tier and cost. We submit warranties on your behalf â€” this cost will be tracked and reported separately.
                </div>
              )}
            </div>

            {/* Flag preview */}
            {anyFlag && (
              <div style={{ background:C.redDim, border:`1px solid ${C.red}44`, borderRadius:10, padding:"10px 14px", marginBottom:16 }}>
                <div style={{ color:C.red, fontSize:12, fontFamily:"'Inter',sans-serif", fontWeight:600, marginBottom:6 }}>âš  Variance flags â€” will require BM review</div>
                <div style={{ display:"flex", flexWrap:"wrap", gap:6 }}>
                  {liveVariances.filter(v=>v.over||v.under).map(v=>(
                    <span key={v.cat} style={{ background:v.over?C.redDim:C.orangeDim, color:v.over?C.red:C.orange, borderRadius:99, padding:"3px 10px", fontSize:11, fontFamily:"'Inter',sans-serif", fontWeight:600 }}>
                      {v.over?"ğŸ”´":"ğŸŸ¡"} {CAT_META[v.cat].label}: {(v.variancePct>=0?"+":"")+v.variancePct.toFixed(1)}% (Â±{v.tol}% tol)
                    </span>
                  ))}
                </div>
              </div>
            )}

            {/* Unassigned doc block */}
            {unassignedDocs.length > 0 && (
              <div style={{ background:C.redDim, border:`1px solid ${C.red}44`, borderRadius:10, padding:"10px 14px", marginBottom:12 }}>
                <div style={{ color:C.red, fontSize:12, fontFamily:"'Inter',sans-serif", fontWeight:600, marginBottom:4 }}>
                  ğŸ”´ CANNOT SUBMIT â€” {unassignedDocs.length} receipt{unassignedDocs.length>1?"s":""} not yet assigned to a cost
                </div>
                <div style={{ color:C.red, fontSize:11, lineHeight:1.6 }}>
                  Go to the <strong>Documents tab</strong> and assign each receipt to its matching cost line item.
                </div>
                <div style={{ display:"flex", gap:5, flexWrap:"wrap", marginTop:7 }}>
                  {unassignedDocs.map(d=>(
                    <span key={d.id} style={{ background:C.redDim, color:C.red, border:`1px solid ${C.red}33`, borderRadius:99, padding:"3px 10px", fontSize:11, fontFamily:"'Inter',sans-serif" }}>
                      ğŸ“„ {d.name}
                    </span>
                  ))}
                </div>
              </div>
            )}

            <div style={{ display:"flex", gap:10 }}>
              <button onClick={()=>setPhase("estimate")} style={btnSecondary}>â† Estimates</button>
              <button onClick={()=>setPhase("documents")} style={{ ...btnSecondary, position:"relative" }}>
                Documents {unassignedDocs.length>0 && <span style={{ background:C.red, color:"#fff", borderRadius:"50%", width:16, height:16, fontSize:10, fontWeight:700, display:"inline-flex", alignItems:"center", justifyContent:"center", marginLeft:4 }}>{unassignedDocs.length}</span>}
              </button>
              <button onClick={()=>{ onSave({ estimated, actuals, documents:docs }); onClose(); }} style={btnSecondary}>Save Draft</button>
              <button
                disabled={unassignedDocs.length > 0}
                onClick={()=>{ onSave({ estimated, actuals, documents:docs }); onSubmit(); onClose(); }}
                style={{ ...btnPrimary, flex:1, opacity:unassignedDocs.length>0?0.4:1, cursor:unassignedDocs.length>0?"not-allowed":"pointer" }}
              >
                {unassignedDocs.length>0 ? `Assign ${unassignedDocs.length} receipt${unassignedDocs.length>1?"s":""} first` : "Submit for Closeout â†’"}
              </button>
            </div>
          </div>
        )}

        {/* â”€â”€ PHASE 3: DOCUMENTS (franchisee view â€” assign only) â”€â”€ */}
        {phase === "documents" && (
          <div>
            <DocumentPanel
              docs={docs}
              actuals={actuals}
              viewerRole="franchisee"
              viewerName={franchiseeName||"Franchisee"}
              onDocsChange={setDocs}
            />
            <div style={{ display:"flex", gap:10, marginTop:16 }}>
              <button onClick={()=>setPhase("actuals")} style={btnSecondary}>â† Back to Actuals</button>
              <button onClick={()=>{ onSave({ estimated, actuals, documents:docs }); onClose(); }} style={{ ...btnPrimary, flex:1 }}>
                Save & Close
              </button>
            </div>
          </div>
        )}
      </div>
    </div>
  );
}

// â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
// REVIEW MODAL (Business Manager)
// â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
function ReviewModal({ job, franchisee, bmName, onApprove, onFlag, onClose, onDocsChange }) {
  const [note, setNote]     = useState("");
  const [docs, setDocs]     = useState(JSON.parse(JSON.stringify(job.documents || [])));
  const [bmTab, setBmTab]   = useState("review"); // "review" | "documents"
  const { totalCost, gp, margin } = calcJobMargin(job);
  const flags     = evaluateFlags(job);
  const variances = calcVariances(job);
  const cats      = ["materials","labor","dump","franchiseFee","warranty","other"];

  const estTotal  = cats.reduce((a,c)=>a+(Number(job.estimated?.[c]||0)),0);
  const marginColor = margin < 25 ? C.red : margin < 35 ? C.orange : C.green;
  const hasFlags  = flags.length > 0;
  const unassignedDocs = docs.filter(d => !d.assignedTo || d.assignedTo.length === 0);

  function handleDocsChange(newDocs) {
    setDocs(newDocs);
    onDocsChange && onDocsChange(newDocs);
  }

  // Build payout list from actuals
  const matTotal  = actualCatTotal(job.actuals, "materials");
  const subPayees = (job.actuals?.other||[]).filter(i=>i.type==="lump");

  const payouts = [
    ...(matTotal > 0 ? [{ payee:"Materials Supplier", amount:matTotal, type:"materials" }] : []),
    { payee:`${franchisee.owner} (${franchisee.name})`, amount:Math.max(0,gp), type:"franchisee" },
  ];

  return (
    <div style={{ position:"fixed", inset:0, background:"#000000DD", zIndex:400, display:"flex", alignItems:"flex-start", justifyContent:"center", overflowY:"auto", padding:"16px 12px 120px" }}>
      <div style={{ background:C.card, border:`1px solid ${C.border}`, borderRadius:20, width:"100%", maxWidth:860, padding:24 }}>

        {/* Header */}
        <div style={{ display:"flex", justifyContent:"space-between", alignItems:"flex-start", marginBottom:4 }}>
          <div>
            <div style={{ color:C.muted, fontSize:11, fontFamily:"'Inter',sans-serif", fontWeight:500, marginBottom:4 }}>BM REVIEW â€” {job.id.toUpperCase()}</div>
            <div style={{ fontFamily:"'Cabinet Grotesk',sans-serif", fontWeight:900, fontSize:20, color:C.text }}>{job.address}</div>
            <div style={{ color:C.muted, fontSize:12, marginTop:2 }}>{franchisee.name} Â· {job.customer} Â· <span style={{ color:C.accent, fontFamily:"'Inter',sans-serif" }}>{fmtDollarFull(job.contractPrice)}</span></div>
          </div>
          <button onClick={onClose} style={{ ...btnSecondary, padding:"6px 12px" }}>âœ•</button>
        </div>

        {/* BM tab switcher */}
        <div style={{ display:"flex", gap:0, margin:"14px 0", background:C.panel, borderRadius:10, padding:4 }}>
          {[
            { id:"review",    label:"ğŸ“‹ Review & Approve" },
            { id:"documents", label:`ğŸ“ Documents${unassignedDocs.length>0?" (âš  "+unassignedDocs.length+")":"  ("+docs.length+")"}` },
          ].map(t=>(
            <button key={t.id} onClick={()=>setBmTab(t.id)} style={{ flex:1, background:bmTab===t.id?C.blue:"transparent", color:bmTab===t.id?"#fff":C.muted, border:"none", borderRadius:7, padding:"8px 12px", fontWeight:600, cursor:"pointer", fontSize:13, fontFamily:"'Inter',sans-serif", transition:"all 0.15s" }}>
              {t.label}
            </button>
          ))}
        </div>

        {/* â”€â”€ BM DOCUMENTS TAB â”€â”€ */}
        {bmTab === "documents" && (
          <div>
            <DocumentPanel
              docs={docs}
              actuals={job.actuals}
              viewerRole="bm"
              viewerName={bmName || "Business Manager"}
              onDocsChange={handleDocsChange}
            />
            <div style={{ marginTop:16 }}>
              <button onClick={()=>setBmTab("review")} style={{ ...btnPrimary, width:"100%" }}>
                â† Back to Review
              </button>
            </div>
          </div>
        )}

        {/* â”€â”€ BM REVIEW TAB â”€â”€ */}
        {bmTab === "review" && (<>

        {/* Flag banner */}
        {hasFlags && (
          <div style={{ background:C.redDim, border:`1px solid ${C.red}44`, borderRadius:12, padding:"12px 16px", margin:"14px 0" }}>
            <div style={{ color:C.red, fontSize:12, fontFamily:"'Inter',sans-serif", fontWeight:600, marginBottom:8 }}>ğŸš© Variance flags â€” review before approving</div>
            <div style={{ display:"flex", flexWrap:"wrap", gap:6 }}>
              {flags.map((f,i)=><FlagBadge key={i} flag={f} />)}
            </div>
          </div>
        )}
        {!hasFlags && (
          <div style={{ background:C.greenDim, border:`1px solid ${C.green}44`, borderRadius:12, padding:"10px 16px", margin:"14px 0" }}>
            <span style={{ color:C.green, fontSize:12, fontFamily:"'Inter',sans-serif", fontWeight:600 }}>âœ… All categories within tolerance â€” clean job</span>
          </div>
        )}

        {/* Margin summary */}
        <div style={{ background:C.panel, border:`2px solid ${marginColor}44`, borderRadius:12, padding:14, marginBottom:16 }}>
          <div style={{ display:"flex", justifyContent:"space-around", flexWrap:"wrap", gap:12 }}>
            {[
              { l:"Contract Price",  v:fmtDollarFull(job.contractPrice), c:C.text },
              { l:"Est. Total Cost", v:fmtDollarFull(estTotal),          c:C.muted },
              { l:"Actual Cost",     v:fmtDollarFull(totalCost),         c:C.text },
              { l:"Gross Profit",    v:fmtDollarFull(gp),                c:gp>=0?C.green:C.red },
              { l:"Actual Margin",   v:fmtPct(margin),                   c:marginColor },
            ].map(s=>(
              <div key={s.l} style={{ textAlign:"center" }}>
                <div style={{ color:C.muted, fontSize:11, fontFamily:"'Inter',sans-serif", fontWeight:500 }}>{s.l}</div>
                <div style={{ color:s.c, fontFamily:"'Cabinet Grotesk',sans-serif", fontWeight:700, fontSize:18 }}>{s.v}</div>
              </div>
            ))}
          </div>
        </div>

        {/* â”€â”€ VARIANCE TABLE â€” the heart of this modal â”€â”€ */}
        <div style={{ background:C.panel, border:`1px solid ${C.border}`, borderRadius:12, overflow:"hidden", marginBottom:16 }}>
          <div style={{ padding:"10px 14px", borderBottom:`1px solid ${C.border}` }}>
            <span style={{ color:C.muted, fontSize:11, fontFamily:"'Inter',sans-serif", fontWeight:500, letterSpacing:0 }}>EXPECTED vs ACTUAL â€” VARIANCE BY CATEGORY</span>
          </div>

          {/* Header row */}
          <div style={{ display:"grid", gridTemplateColumns:"1fr 115px 115px 110px 140px", gap:0, padding:"8px 14px", borderBottom:`1px solid ${C.border}` }}>
            {["Category","Estimated","Actual","Difference","Status"].map((h,i)=>(
              <div key={h} style={{ color:C.muted, fontSize:10, fontFamily:"'Inter',sans-serif", fontWeight:600, textAlign:i===0?"left":"right", paddingRight: i===0?0:8 }}>{h}</div>
            ))}
          </div>

          {/* Data rows */}
          {variances.map(v => {
            const m = CAT_META[v.cat];
            const isOver  = v.over;
            const isUnder = v.under;
            const isOk    = v.hasAct && !isOver && !isUnder;
            const rowBg   = isOver ? C.red+"0A" : isUnder ? C.orange+"0A" : "transparent";
            const statusColor = isOver ? C.red : isUnder ? C.orange : isOk ? C.green : C.muted;
            const statusIcon  = isOver ? "ğŸ”´ Over" : isUnder ? "ğŸŸ¡ Under" : isOk ? "âœ… OK" : "â€” no data";

            const items = job.actuals?.[v.cat] || [];

            return (
              <div key={v.cat} style={{ background:rowBg, borderBottom:`1px solid ${C.border}` }}>
                {/* Summary row */}
                <div style={{ display:"grid", gridTemplateColumns:"1fr 115px 115px 110px 140px", gap:0, padding:"10px 14px", alignItems:"center" }}>
                  <div style={{ color:m.color, fontSize:12, fontWeight:600 }}>{m.icon} {m.label}</div>
                  <div style={{ color:C.muted, fontSize:12, fontFamily:"'DM Mono',monospace", textAlign:"right", paddingRight:8 }}>{v.est>0?fmtDollarFull(v.est):"â€”"}</div>
                  <div style={{ color:C.text, fontSize:12, fontFamily:"'DM Mono',monospace", textAlign:"right", paddingRight:8, fontWeight:600 }}>{v.hasAct?fmtDollarFull(v.actual):"â€”"}</div>
                  <div style={{ color:v.isFixed?C.muted:isOver?C.red:isUnder?C.green:C.muted, fontSize:12, fontFamily:"'DM Mono',monospace", textAlign:"right", paddingRight:8, fontWeight:600 }}>
                    {v.isFixed ? "â€”" : v.hasAct && v.est>0 ? (v.diff>=0?"+":"")+fmtDollarFull(v.diff) : "â€”"}
                  </div>
                  <div style={{ textAlign:"right" }}>
                    {v.isFixed
                      ? <span style={{ color:C.purple, fontSize:10, fontFamily:"'Inter',sans-serif", fontWeight:600, background:C.purpleDim, borderRadius:99, padding:"2px 8px" }}>ğŸ›¡ï¸ Fixed</span>
                      : <>
                          <div style={{ color:statusColor, fontSize:11, fontFamily:"'Inter',sans-serif", fontWeight:600 }}>{statusIcon}</div>
                          {v.hasAct && v.est>0 && (
                            <div style={{ color:C.muted, fontSize:10, fontFamily:"'DM Mono',monospace", marginTop:2 }}>
                              {(v.variancePct>=0?"+":"")+v.variancePct.toFixed(1)}% / Â±{v.tol}% tol.
                            </div>
                          )}
                        </>
                    }
                  </div>
                </div>

                {/* Line items indented below */}
                {items.length > 0 && (
                  <div style={{ padding:"0 14px 10px 28px", display:"flex", flexDirection:"column", gap:3 }}>
                    {items.map((item,i)=>(
                      <div key={i} style={{ padding:"5px 8px", background:C.card, borderRadius:5 }}>
                        <div style={{ display:"flex", justifyContent:"space-between", alignItems:"center" }}>
                          <div style={{ display:"flex", alignItems:"center", gap:6 }}>
                            <span style={{ background:item.type==="lump"?C.purpleDim:C.subtle, color:item.type==="lump"?C.purple:C.muted, fontSize:10, fontFamily:"'Inter',sans-serif", fontWeight:500, padding:"2px 6px", borderRadius:3 }}>{item.type==="lump"?"LUMP":"LINE"}</span>
                            <span style={{ color:C.text, fontSize:12 }}>{item.desc}</span>
                          </div>
                          <span style={{ color:C.muted, fontFamily:"'DM Mono',monospace", fontSize:12 }}>{fmtDollarFull(item.amount)}</span>
                        </div>
                        {item.supplier && (
                          <div style={{ marginTop:3, fontSize:11, color:C.muted, paddingLeft:2 }}>
                            ğŸª Supplier: <span style={{ color:C.accent, fontWeight:500 }}>{item.supplier}</span>
                          </div>
                        )}
                        {item.subId && (
                          <div style={{ marginTop:3, fontSize:11, color:C.muted, paddingLeft:2 }}>
                            ğŸ”§ Sub: <span style={{ color:C.blue, fontWeight:500 }}>{item.subId}</span>
                          </div>
                        )}
                      </div>
                    ))}
                  </div>
                )}
              </div>
            );
          })}

          {/* Totals footer */}
          <div style={{ display:"grid", gridTemplateColumns:"1fr 115px 115px 110px 140px", gap:0, padding:"12px 14px", background:C.subtle }}>
            <div style={{ color:C.text, fontSize:12, fontWeight:700 }}>TOTAL</div>
            <div style={{ color:C.muted, fontSize:13, fontFamily:"'DM Mono',monospace", textAlign:"right", paddingRight:8, fontWeight:700 }}>{fmtDollarFull(estTotal)}</div>
            <div style={{ color:C.text, fontSize:13, fontFamily:"'DM Mono',monospace", textAlign:"right", paddingRight:8, fontWeight:700 }}>{fmtDollarFull(totalCost)}</div>
            <div style={{ color:totalCost>estTotal?C.red:C.green, fontSize:13, fontFamily:"'DM Mono',monospace", textAlign:"right", paddingRight:8, fontWeight:600 }}>
              {estTotal>0?(totalCost-estTotal>=0?"+":"")+fmtDollarFull(totalCost-estTotal):"â€”"}
            </div>
            <div style={{ textAlign:"right" }}>
              <span style={{ color:hasFlags?C.red:C.green, fontSize:11, fontFamily:"'Inter',sans-serif", fontWeight:600 }}>
                {hasFlags?"ğŸ”´ FLAGGED":"âœ… CLEAN"}
              </span>
            </div>
          </div>
        </div>

        {/* Payout preview */}
        <div style={{ background:C.greenDim, border:`1px solid ${C.green}44`, borderRadius:12, padding:14, marginBottom:16 }}>
          <div style={{ color:C.green, fontSize:11, fontFamily:"'Inter',sans-serif", fontWeight:600, marginBottom:10 }}>ğŸ’° Payout queue (upon approval)</div>
          {payouts.map((p,i)=>(
            <div key={i} style={{ display:"flex", justifyContent:"space-between", alignItems:"center", padding:"7px 0", borderBottom:i<payouts.length-1?`1px solid ${C.green}22`:"none" }}>
              <div>
                <div style={{ color:C.text, fontSize:13, fontWeight:600 }}>{p.payee}</div>
                <div style={{ color:C.muted, fontSize:11, fontFamily:"'Inter',sans-serif", fontWeight:500 }}>{p.type==="franchisee"?"Franchisee Gross Profit":p.type==="sub"?"Subcontractor":"Materials"}</div>
              </div>
              <div style={{ color:p.type==="franchisee"?C.green:C.text, fontFamily:"'Cabinet Grotesk',sans-serif", fontWeight:800, fontSize:16 }}>{fmtDollarFull(p.amount)}</div>
            </div>
          ))}
        </div>

        {/* BM note */}
        <div style={{ marginBottom:16 }}>
          <div style={{ color:C.muted, fontSize:11, fontFamily:"'Inter',sans-serif", fontWeight:500, marginBottom:6 }}>
            {hasFlags ? "EXPLAIN YOUR DECISION (required for flagged jobs)" : "ADD NOTE (optional)"}
          </div>
          <textarea value={note} onChange={e=>setNote(e.target.value)}
            placeholder={hasFlags ? "Explain why you're approving despite the flag, or describe what needs to be fixed..." : "Leave a note for the franchisee..."}
            style={{ ...inputStyle, minHeight:64, resize:"vertical", fontFamily:"'Inter',sans-serif" }} />
        </div>

        {/* Actions */}
        <div style={{ display:"flex", gap:10 }}>
          <button onClick={()=>{ onFlag(note); onClose(); }} style={{ ...btnDanger, flex:1, textAlign:"center" }}>ğŸš© Flag & Return</button>
          <button
            onClick={()=>{ if(hasFlags && !note.trim()){ alert("Please add a note explaining your decision on this flagged job."); return; } onApprove(payouts,note); onClose(); }}
            style={{ ...btnPrimary, flex:2, textAlign:"center", opacity: hasFlags && !note.trim() ? 0.6 : 1 }}
          >
            âœ… Approve & Queue Payouts
          </button>
        </div>
        {hasFlags && !note.trim() && (
          <div style={{ color:C.orange, fontSize:12, fontFamily:"'Inter',sans-serif", textAlign:"center", marginTop:8 }}>
            âš  Note required to approve a flagged job
          </div>
        )}
        </>)}
      </div>
    </div>
  );
}

// â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
// FINANCIALS TAB â€” Monthly Snapshot & KPI Tracker
// Built for the franchisee + BM monthly review meeting.
// Data pulled live from actual job records.
// Goals are set per franchisee and tracked month by month.
// â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€

const MONTHS = ["Jan","Feb","Mar","Apr","May","Jun","Jul","Aug","Sep","Oct","Nov","Dec"];

// â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
// GOAL ENGINE
// â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
const MONTHS_FULL = ["January","February","March","April","May","June","July","August","September","October","November","December"];

const RANK_TIERS = [
  { min:0,   max:29,  rank:"Rookie",     icon:"ğŸª¨", color:"#6B7280" },
  { min:30,  max:49,  rank:"Builder",    icon:"ğŸ”§", color:"#F97316" },
  { min:50,  max:64,  rank:"Competitor", icon:"âš¡", color:"#60A5FA" },
  { min:65,  max:79,  rank:"Pro",        icon:"ğŸ”¥", color:"#94F2C4" },
  { min:80,  max:89,  rank:"Elite",      icon:"ğŸ’", color:"#A855F7" },
  { min:90,  max:100, rank:"Legend",     icon:"ğŸ‘‘", color:"#FFD700" },
];

function getRank(score) {
  return RANK_TIERS.find(t => score >= t.min && score <= t.max) || RANK_TIERS[0];
}

function scoreColor(s) {
  return s >= 80 ? C.green : s >= 60 ? C.accent : s >= 40 ? C.orange : C.red;
}

function deriveMonthlyGoals(yearly) {
  const monthlyRevenue = Math.round(yearly.revenue / 12);
  const monthlyJobs    = Math.max(1, Math.round(yearly.jobs / 12));
  return {
    revenue:   monthlyRevenue,
    gpDollars: Math.round(monthlyRevenue * (yearly.margin / 100)),
    jobs:      monthlyJobs,
    margin:    yearly.margin,
    avgTicket: monthlyJobs > 0 ? Math.round(monthlyRevenue / monthlyJobs) : yearly.avgTicket,
  };
}

function computeAchievements(approvedJobs) {
  const badges    = [];
  const totalRev  = approvedJobs.reduce((a,j) => a + j.contractPrice, 0);
  const totalJobs = approvedJobs.length;
  const margins   = approvedJobs.map(j => calcJobMargin(j).margin);
  const avgMargin = margins.length > 0 ? margins.reduce((a,b) => a+b, 0) / margins.length : 0;
  const maxTicket = approvedJobs.length > 0 ? Math.max(...approvedJobs.map(j => j.contractPrice)) : 0;

  if (totalJobs >= 1)      badges.push({ id:"first",   icon:"ğŸ”‘", label:"First Close",        desc:"Closed your first job",          color:C.accent  });
  if (totalJobs >= 10)     badges.push({ id:"ten",     icon:"ğŸ”Ÿ", label:"10 Jobs",             desc:"Closed 10 jobs",                 color:C.blue    });
  if (totalJobs >= 25)     badges.push({ id:"25",      icon:"â­", label:"25 Jobs",             desc:"Closed 25 jobs",                 color:C.green   });
  if (totalJobs >= 50)     badges.push({ id:"50",      icon:"ğŸ†", label:"50 Jobs",             desc:"Closed 50 jobs",                 color:"#FFD700" });
  if (totalRev >= 100000)  badges.push({ id:"100k",    icon:"ğŸ’¯", label:"$100K Club",          desc:"Crossed $100K in revenue",       color:C.green   });
  if (totalRev >= 500000)  badges.push({ id:"500k",    icon:"ğŸ’°", label:"$500K Club",          desc:"Crossed $500K in revenue",       color:C.accent  });
  if (totalRev >= 1000000) badges.push({ id:"1m",      icon:"ğŸ¦„", label:"Million Dollar Club", desc:"Crossed $1M in revenue",         color:"#FFD700" });
  if (avgMargin >= 40)     badges.push({ id:"m40",     icon:"ğŸ“ˆ", label:"Margin Master",       desc:"Avg gross margin at or above 40%", color:C.purple });
  if (avgMargin >= 45)     badges.push({ id:"m45",     icon:"ğŸ¯", label:"Margin Elite",        desc:"Avg gross margin at or above 45%", color:"#FFD700"});
  if (maxTicket >= 20000)  badges.push({ id:"big",     icon:"ğŸ—ï¸", label:"Big Ticket",          desc:"Single job over $20K",           color:C.blue    });
  if (maxTicket >= 50000)  badges.push({ id:"whale",   icon:"ğŸ‹", label:"Whale Closer",        desc:"Single job over $50K",           color:"#FFD700" });
  return badges;
}

function computeStreak(jobsByMonth, monthlyGoalRevenue, sortedMonths) {
  let streak = 0;
  for (const ym of sortedMonths) {
    const rev = (jobsByMonth[ym] || []).reduce((a,j) => a + j.contractPrice, 0);
    if (rev >= monthlyGoalRevenue) streak++;
    else break;
  }
  return streak;
}

function scoreMonth(monthJobs, goals) {
  const rev    = monthJobs.reduce((a,j) => a + j.contractPrice, 0);
  const gp     = monthJobs.reduce((a,j) => a + calcJobMargin(j).gp, 0);
  const margin = rev > 0 ? (gp / rev) * 100 : 0;
  const ticket = monthJobs.length > 0 ? rev / monthJobs.length : 0;
  const pcts = [
    Math.min(rev    / Math.max(goals.revenue,   1) * 100, 100),
    Math.min(gp     / Math.max(goals.gpDollars, 1) * 100, 100),
    Math.min(monthJobs.length / Math.max(goals.jobs, 1) * 100, 100),
    Math.min(margin / Math.max(goals.margin,    1) * 100, 100),
    Math.min(ticket / Math.max(goals.avgTicket, 1) * 100, 100),
  ];
  const score = Math.round(pcts.reduce((a,b) => a+b, 0) / pcts.length);
  return { score, rev, gp, margin, ticket, jobs: monthJobs.length };
}

// â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
// YEARLY GOAL WIZARD
// â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
function YearlyGoalWizard({ franchisee, onSave, onCancel }) {
  const currentYear = new Date().getFullYear();
  const existing    = franchisee.yearlyGoals || {};
  const [step, setStep] = useState(1);
  const [form, setForm] = useState({
    year:      existing.year      || currentYear,
    netIncome: existing.netIncome || 150000,
    overhead:  existing.overhead  || franchisee.overhead    || 36000,
    margin:    existing.margin    || franchisee.grossMargin || 40,
    avgTicket: existing.avgTicket || franchisee.avgTicket   || 12000,
    closeRate: existing.closeRate || franchisee.closeRate   || 60,
  });

  const gpNeeded      = form.netIncome + form.overhead;
  const revenueNeeded = form.margin > 0 ? Math.round(gpNeeded / (form.margin / 100)) : 0;
  const jobsNeeded    = form.avgTicket > 0 ? Math.round(revenueNeeded / form.avgTicket) : 0;
  const jobsPerMonth  = Math.ceil(jobsNeeded / 12);
  const leadsNeeded   = form.closeRate > 0 ? Math.round(jobsNeeded / (form.closeRate / 100)) : 0;
  const leadsPerMonth = Math.ceil(leadsNeeded / 12);
  const monthlyRev    = Math.round(revenueNeeded / 12);
  const monthlyGP     = Math.round(gpNeeded / 12);

  const STEPS = [
    { n:1, label:"Income Goal" },
    { n:2, label:"Your Numbers" },
    { n:3, label:"Review" },
  ];

  function upd(key, val) { setForm(f => ({ ...f, [key]: val })); }

  return (
    <div style={{ position:"fixed", inset:0, background:"#000000DD", zIndex:500, display:"flex", alignItems:"center", justifyContent:"center", padding:20 }}>
      <div style={{ background:C.card, border:`1px solid ${C.border}`, borderRadius:24, width:"100%", maxWidth:520, padding:28, animation:"fadeIn 0.25s ease" }}>

        {/* Step progress bar */}
        <div style={{ display:"flex", gap:0, marginBottom:24, position:"relative" }}>
          <div style={{ position:"absolute", top:14, left:28, right:28, height:2, background:C.border, zIndex:0 }} />
          {STEPS.map(s => (
            <div key={s.n} style={{ flex:1, display:"flex", flexDirection:"column", alignItems:"center", gap:6, position:"relative", zIndex:1 }}>
              <div style={{ width:28, height:28, borderRadius:"50%", background:step>=s.n?C.accent:C.panel, border:`2px solid ${step>=s.n?C.accent:C.border}`, display:"flex", alignItems:"center", justifyContent:"center", fontSize:12, fontWeight:700, color:step>=s.n?"#0A0C10":C.muted }}>
                {step > s.n ? "âœ“" : s.n}
              </div>
              <span style={{ color:step===s.n?C.accent:C.muted, fontSize:10, fontWeight:step===s.n?700:400 }}>{s.label}</span>
            </div>
          ))}
        </div>

        {/* Step 1 â€” Income goal */}
        {step === 1 && (
          <div>
            <div style={{ textAlign:"center", marginBottom:24 }}>
              <div style={{ fontSize:40, marginBottom:8 }}>ğŸ¯</div>
              <h2 style={{ fontFamily:"'Cabinet Grotesk',sans-serif", fontWeight:900, fontSize:22, margin:"0 0 6px" }}>What's your income goal?</h2>
              <p style={{ color:C.muted, fontSize:13, margin:0, lineHeight:1.6 }}>Set your personal net income target. Everything gets reverse-engineered from here.</p>
            </div>
            <div style={{ marginBottom:16 }}>
              <div style={{ color:C.muted, fontSize:11, fontWeight:600, marginBottom:8, textAlign:"center" }}>TARGET NET INCOME FOR {form.year}</div>
              <div style={{ position:"relative" }}>
                <span style={{ position:"absolute", left:16, top:"50%", transform:"translateY(-50%)", color:C.accent, fontSize:22, fontWeight:700 }}>$</span>
                <input type="number" value={form.netIncome} onChange={e => upd("netIncome", Number(e.target.value))}
                  style={{ ...inputStyle, paddingLeft:36, fontSize:24, height:56, width:"100%" }} />
              </div>
              <div style={{ display:"flex", gap:8, marginTop:10, flexWrap:"wrap" }}>
                {[80000,120000,150000,200000,250000].map(v => (
                  <button key={v} onClick={() => upd("netIncome", v)}
                    style={{ background:form.netIncome===v?C.accent:C.panel, color:form.netIncome===v?"#0A0C10":C.muted, border:`1px solid ${form.netIncome===v?C.accent:C.border}`, borderRadius:8, padding:"6px 12px", fontSize:12, fontWeight:600, cursor:"pointer" }}>
                    {fmtDollar(v)}
                  </button>
                ))}
              </div>
            </div>
            <div style={{ marginBottom:20 }}>
              <div style={{ color:C.muted, fontSize:11, fontWeight:600, marginBottom:8 }}>YEAR</div>
              <select value={form.year} onChange={e => upd("year", Number(e.target.value))} style={{ ...inputStyle, cursor:"pointer" }}>
                {[currentYear, currentYear+1].map(y => (
                  <option key={y} value={y}>{y}</option>
                ))}
              </select>
            </div>
            <div style={{ display:"flex", gap:10 }}>
              <button onClick={onCancel} style={{ ...btnSecondary, flex:1 }}>Cancel</button>
              <button onClick={() => setStep(2)} style={{ ...btnPrimary, flex:2 }}>Next: Your Numbers â†’</button>
            </div>
          </div>
        )}

        {/* Step 2 â€” Business numbers */}
        {step === 2 && (
          <div>
            <div style={{ textAlign:"center", marginBottom:20 }}>
              <div style={{ fontSize:40, marginBottom:8 }}>ğŸ”§</div>
              <h2 style={{ fontFamily:"'Cabinet Grotesk',sans-serif", fontWeight:900, fontSize:20, margin:"0 0 6px" }}>Your business numbers</h2>
              <p style={{ color:C.muted, fontSize:13, margin:0 }}>These let us calculate exactly what you need to hit your income goal.</p>
            </div>
            <div style={{ display:"grid", gridTemplateColumns:"1fr 1fr", gap:14, marginBottom:20 }}>
              {[
                { key:"overhead",  label:"Annual Overhead",    prefix:"$", suffix:"",  hint:"Rent, insurance, payroll, trucks" },
                { key:"margin",    label:"Target Gross Margin", prefix:"",  suffix:"%", hint:"% of revenue left after job costs" },
                { key:"avgTicket", label:"Avg Job Size",        prefix:"$", suffix:"",  hint:"Average contract price per job" },
                { key:"closeRate", label:"Close Rate",          prefix:"",  suffix:"%", hint:"% of leads you convert to jobs" },
              ].map(g => (
                <div key={g.key}>
                  <div style={{ color:C.muted, fontSize:10, fontWeight:600, marginBottom:4 }}>{g.label}</div>
                  <div style={{ position:"relative" }}>
                    {g.prefix ? <span style={{ position:"absolute", left:10, top:"50%", transform:"translateY(-50%)", color:C.muted }}>{g.prefix}</span> : null}
                    <input type="number" value={form[g.key]} onChange={e => upd(g.key, Number(e.target.value))}
                      style={{ ...inputStyle, paddingLeft:g.prefix?24:13, paddingRight:g.suffix?24:13, width:"100%" }} />
                    {g.suffix ? <span style={{ position:"absolute", right:10, top:"50%", transform:"translateY(-50%)", color:C.muted }}>{g.suffix}</span> : null}
                  </div>
                  <div style={{ color:C.muted, fontSize:10, marginTop:4 }}>{g.hint}</div>
                </div>
              ))}
            </div>
            <div style={{ display:"flex", gap:10 }}>
              <button onClick={() => setStep(1)} style={btnSecondary}>â† Back</button>
              <button onClick={() => setStep(3)} style={{ ...btnPrimary, flex:1 }}>See Your Plan â†’</button>
            </div>
          </div>
        )}

        {/* Step 3 â€” Review plan */}
        {step === 3 && (
          <div>
            <div style={{ textAlign:"center", marginBottom:20 }}>
              <div style={{ fontSize:40, marginBottom:8 }}>ğŸš€</div>
              <h2 style={{ fontFamily:"'Cabinet Grotesk',sans-serif", fontWeight:900, fontSize:20, margin:"0 0 6px" }}>Your {form.year} Plan</h2>
              <p style={{ color:C.muted, fontSize:13, margin:0 }}>
                To earn <span style={{ color:C.accent, fontWeight:700 }}>{fmtDollar(form.netIncome)}</span> net, here is what you need.
              </p>
            </div>
            <div style={{ display:"grid", gridTemplateColumns:"1fr 1fr", gap:10, marginBottom:16 }}>
              {[
                { icon:"ğŸ’°", label:"Annual Revenue",    value:fmtDollar(revenueNeeded), sub:"needed to hit your goal",  color:C.accent },
                { icon:"ğŸ“ˆ", label:"Annual GP",          value:fmtDollar(gpNeeded),      sub:"after all job costs",       color:C.green  },
                { icon:"ğŸ”¨", label:"Jobs Needed / Year", value:jobsNeeded+" jobs",        sub:jobsPerMonth+"/mo avg",      color:C.blue   },
                { icon:"ğŸ“", label:"Leads Needed / Year",value:leadsNeeded+" leads",      sub:leadsPerMonth+"/mo avg",     color:C.orange },
                { icon:"ğŸ ", label:"Monthly Revenue",   value:fmtDollar(monthlyRev),     sub:"target per month",         color:C.accent },
                { icon:"ğŸ“Š", label:"Monthly GP",         value:fmtDollar(monthlyGP),      sub:"after job costs",           color:C.green  },
              ].map(s => (
                <div key={s.label} style={{ background:C.panel, border:`1px solid ${C.border}`, borderRadius:12, padding:"12px 14px" }}>
                  <div style={{ fontSize:18, marginBottom:4 }}>{s.icon}</div>
                  <div style={{ color:s.color, fontFamily:"'Cabinet Grotesk',sans-serif", fontWeight:900, fontSize:18 }}>{s.value}</div>
                  <div style={{ color:C.muted, fontSize:10, marginTop:2 }}>{s.label}</div>
                  <div style={{ color:C.muted, fontSize:10, opacity:0.7 }}>{s.sub}</div>
                </div>
              ))}
            </div>
            <div style={{ background:C.accentDim, border:`1px solid ${C.accent}33`, borderRadius:10, padding:"10px 14px", marginBottom:16, fontSize:11, color:C.muted, lineHeight:1.8 }}>
              Monthly goals are automatically set from this. Fine-tune them anytime on the Monthly tab.
            </div>
            <div style={{ display:"flex", gap:10 }}>
              <button onClick={() => setStep(2)} style={btnSecondary}>â† Back</button>
              <button onClick={() => onSave({
                year: form.year, netIncome: form.netIncome, overhead: form.overhead,
                margin: form.margin, avgTicket: form.avgTicket, closeRate: form.closeRate,
                revenue: revenueNeeded, jobs: jobsNeeded, gpDollars: gpNeeded,
                monthlyRevenue: monthlyRev, monthlyGP: monthlyGP, monthlyJobs: jobsPerMonth,
              })} style={{ ...btnPrimary, flex:1 }}>ğŸ¯ Save My Plan</button>
            </div>
          </div>
        )}

      </div>
    </div>
  );
}

// â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
// FINANCIALS TAB
// â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
function FinancialsTab({ franchisee, allJobs, approvedJobs, ytdRevenue, ytdGP, ytdMargin, avgTicket, onUpdateFranchisee }) {
  const [view, setView]               = useState("dashboard");
  const [showWizard, setShowWizard]   = useState(false);
  const [editMonthly, setEditMonthly] = useState(false);

  const yearlyGoals = franchisee.yearlyGoals || null;

  const defaultMonthly = yearlyGoals
    ? { revenue: yearlyGoals.monthlyRevenue || Math.round((yearlyGoals.revenue||0)/12),
        gpDollars: yearlyGoals.monthlyGP    || Math.round((yearlyGoals.gpDollars||0)/12),
        jobs:      yearlyGoals.monthlyJobs  || Math.max(1, Math.round((yearlyGoals.jobs||0)/12)),
        margin:    yearlyGoals.margin       || 40,
        avgTicket: yearlyGoals.avgTicket    || 12000 }
    : { revenue:   franchisee.monthlyGoals?.revenue    || 80000,
        gpDollars: franchisee.monthlyGoals?.gpDollars  || 32000,
        jobs:      franchisee.monthlyGoals?.jobs       || 6,
        margin:    franchisee.monthlyGoals?.margin     || 40,
        avgTicket: franchisee.monthlyGoals?.avgTicket  || 12000 };

  const [monthly, setMonthly]     = useState(defaultMonthly);
  const [draftM,  setDraftM]      = useState(defaultMonthly);

  // Group approved jobs by month
  const jobsByMonth = {};
  approvedJobs.forEach(job => {
    const d = job.approvedAt || job.submittedAt;
    if (!d) return;
    const m = d.slice(0,7);
    if (!jobsByMonth[m]) jobsByMonth[m] = [];
    jobsByMonth[m].push(job);
  });
  const sortedMonths = Object.keys(jobsByMonth).sort().reverse();
  const [selMonth, setSelMonth] = useState(sortedMonths[0] || null);
  const monthJobs = selMonth ? (jobsByMonth[selMonth] || []) : [];

  function fmtMonthLabel(ym) {
    if (!ym) return "â€”";
    const [y,m] = ym.split("-");
    return MONTHS_FULL[Number(m)-1] + " " + y;
  }

  // Gamification
  const badges    = computeAchievements(approvedJobs);
  const streak    = computeStreak(jobsByMonth, monthly.revenue, sortedMonths);
  const allScores = sortedMonths.map(ym => ({ ym, ...scoreMonth(jobsByMonth[ym]||[], monthly) }));
  const avgScore  = allScores.length > 0 ? Math.round(allScores.reduce((a,s) => a+s.score, 0) / allScores.length) : 0;
  const curRank   = getRank(avgScore);
  const nxtRank   = RANK_TIERS.find(t => t.min > avgScore);

  // YTD goals
  const annualRev = yearlyGoals?.revenue    || franchisee.revenueGoal    || 1000000;
  const annualGP  = yearlyGoals?.gpDollars  || franchisee.netProfitGoal  || 250000;

  function saveYearlyGoals(goals) {
    onUpdateFranchisee(f => ({
      ...f,
      yearlyGoals:  goals,
      revenueGoal:  goals.revenue,
      grossMargin:  goals.margin,
      avgTicket:    goals.avgTicket,
      closeRate:    goals.closeRate,
      overhead:     goals.overhead,
    }));
    const nm = { revenue: goals.monthlyRevenue, gpDollars: goals.monthlyGP,
                 jobs: goals.monthlyJobs, margin: goals.margin, avgTicket: goals.avgTicket };
    setMonthly(nm);
    setDraftM(nm);
    setShowWizard(false);
    setView("dashboard");
  }

  const VIEWS = [
    { id:"dashboard", label:"ğŸ† Dashboard" },
    { id:"monthly",   label:"ğŸ“… Monthly"   },
    { id:"ytd",       label:"ğŸ—“ Year"       },
    { id:"history",   label:"ğŸ“ˆ History"    },
  ];

  return (
    <div>
      {showWizard && (
        <YearlyGoalWizard franchisee={franchisee} onSave={saveYearlyGoals} onCancel={() => setShowWizard(false)} />
      )}

      {/* Header */}
      <div style={{ display:"flex", alignItems:"flex-start", justifyContent:"space-between", marginBottom:16, flexWrap:"wrap", gap:10 }}>
        <div>
          <h1 style={{ fontFamily:"'Cabinet Grotesk',sans-serif", fontSize:24, fontWeight:900, margin:0 }}>Financials</h1>
          <p style={{ color:C.muted, fontSize:13, margin:"4px 0 0" }}>
            {yearlyGoals
              ? "Goal: " + fmtDollar(yearlyGoals.netIncome) + "/yr net income Â· " + yearlyGoals.year
              : "Set your yearly goal to unlock monthly targets and tracking."}
          </p>
        </div>
        <button onClick={() => setShowWizard(true)}
          style={{ background:C.accentDim, color:C.accent, border:`1px solid ${C.accent}44`, borderRadius:9, padding:"8px 16px", fontSize:12, fontWeight:700, cursor:"pointer" }}>
          {yearlyGoals ? "âœï¸ Edit Goal" : "ğŸ¯ Set Yearly Goal"}
        </button>
      </div>

      {/* No goals prompt */}
      {!yearlyGoals && (
        <div style={{ background:C.card, border:`2px dashed ${C.accent}55`, borderRadius:16, padding:32, textAlign:"center", marginBottom:16 }}>
          <div style={{ fontSize:48, marginBottom:12 }}>ğŸ¯</div>
          <div style={{ fontFamily:"'Cabinet Grotesk',sans-serif", fontWeight:800, fontSize:20, marginBottom:8 }}>Set your yearly income goal</div>
          <div style={{ color:C.muted, fontSize:14, lineHeight:1.7, marginBottom:20 }}>Enter your target net income and we will automatically calculate how much revenue you need, how many jobs to close each month, and how to get there.</div>
          <button onClick={() => setShowWizard(true)} style={{ ...btnPrimary, fontSize:14, padding:"12px 28px" }}>ğŸš€ Build My Plan</button>
        </div>
      )}

      {/* Sub-nav */}
      <div style={{ display:"flex", gap:0, background:C.panel, borderRadius:10, padding:4, marginBottom:18 }}>
        {VIEWS.map(v => (
          <button key={v.id} onClick={() => setView(v.id)}
            style={{ flex:1, background:view===v.id?C.accent:"transparent", color:view===v.id?"#0A0C10":C.muted, border:"none", borderRadius:7, padding:"8px 4px", fontWeight:600, cursor:"pointer", fontSize:11, fontFamily:"'Inter',sans-serif" }}>
            {v.label}
          </button>
        ))}
      </div>

      {/* â”€â”€ DASHBOARD â”€â”€ */}
      {view === "dashboard" && (
        <div>
          {/* Rank card */}
          <div style={{ background:C.card, border:`1px solid ${curRank.color}55`, borderRadius:20, padding:22, marginBottom:14 }}>
            <div style={{ display:"flex", alignItems:"center", gap:18, flexWrap:"wrap" }}>
              <div style={{ fontSize:52, lineHeight:1 }}>{curRank.icon}</div>
              <div style={{ flex:1 }}>
                <div style={{ color:C.muted, fontSize:10, fontWeight:600, letterSpacing:1 }}>YOUR RANK</div>
                <div style={{ fontFamily:"'Cabinet Grotesk',sans-serif", fontWeight:900, fontSize:30, color:curRank.color, lineHeight:1.1 }}>{curRank.rank}</div>
                <div style={{ color:C.muted, fontSize:12, marginTop:4 }}>Avg monthly score: <span style={{ color:curRank.color, fontWeight:700 }}>{avgScore}/100</span></div>
                {nxtRank && (
                  <div style={{ marginTop:8 }}>
                    <div style={{ display:"flex", justifyContent:"space-between", marginBottom:3 }}>
                      <span style={{ color:C.muted, fontSize:10 }}>Next: {nxtRank.icon} {nxtRank.rank}</span>
                      <span style={{ color:nxtRank.color, fontSize:10, fontWeight:600 }}>{avgScore}/{nxtRank.min}</span>
                    </div>
                    <div style={{ height:4, background:C.border, borderRadius:99 }}>
                      <div style={{ width: Math.min(((avgScore-curRank.min)/Math.max(nxtRank.min-curRank.min,1))*100, 100) + "%", height:"100%", background:nxtRank.color, borderRadius:99 }} />
                    </div>
                  </div>
                )}
              </div>
              <div style={{ textAlign:"center" }}>
                <div style={{ fontSize:32 }}>{streak > 0 ? "ğŸ”¥" : "ğŸ’¤"}</div>
                <div style={{ fontFamily:"'Cabinet Grotesk',sans-serif", fontWeight:900, fontSize:24, color:streak>0?C.orange:C.muted }}>{streak}</div>
                <div style={{ color:C.muted, fontSize:10 }}>month streak</div>
              </div>
            </div>
          </div>

          {/* Latest month KPIs */}
          {allScores.length > 0 && (
            <div style={{ marginBottom:14 }}>
              <div style={{ color:C.muted, fontSize:11, fontWeight:600, marginBottom:10 }}>{fmtMonthLabel(sortedMonths[0]).toUpperCase()} â€” LATEST MONTH</div>
              <div style={{ display:"grid", gridTemplateColumns:"repeat(2,1fr)", gap:8 }}>
                {(() => {
                  const s = allScores[0];
                  return [
                    { icon:"ğŸ’°", label:"Revenue",  val:fmtDollar(s.rev),             goal:monthly.revenue,   hit:s.rev>=monthly.revenue,    color:C.accent },
                    { icon:"ğŸ“ˆ", label:"GP",        val:fmtDollar(s.gp),              goal:monthly.gpDollars, hit:s.gp>=monthly.gpDollars,   color:C.green  },
                    { icon:"ğŸ”¨", label:"Jobs",      val:String(s.jobs),               goal:monthly.jobs,      hit:s.jobs>=monthly.jobs,      color:C.blue   },
                    { icon:"ğŸ“Š", label:"Margin",    val:s.margin.toFixed(1)+"%",      goal:monthly.margin,    hit:s.margin>=monthly.margin,  color:C.purple },
                  ].map(k => (
                    <div key={k.label} style={{ background:C.card, border:`1px solid ${k.hit?k.color+"44":C.border}`, borderRadius:12, padding:"12px 14px" }}>
                      <div style={{ fontSize:16, marginBottom:4 }}>{k.icon}</div>
                      <div style={{ color:k.color, fontFamily:"'Cabinet Grotesk',sans-serif", fontWeight:800, fontSize:18 }}>{k.val}</div>
                      <div style={{ color:C.muted, fontSize:10, marginTop:1 }}>{k.label}</div>
                      <div style={{ height:3, background:C.border, borderRadius:99, marginTop:6 }}>
                        <div style={{ width: Math.min((typeof k.val==="number"?k.val:parseFloat(k.val)) / k.goal * 100, 100) + "%", height:"100%", background:k.hit?C.green:k.color, borderRadius:99 }} />
                      </div>
                      {k.hit && <div style={{ color:C.green, fontSize:10, marginTop:3, fontWeight:600 }}>âœ… Goal hit</div>}
                    </div>
                  ));
                })()}
              </div>
            </div>
          )}

          {/* Achievements */}
          <div style={{ background:C.card, border:`1px solid ${C.border}`, borderRadius:14, padding:16, marginBottom:14 }}>
            <div style={{ color:C.muted, fontSize:11, fontWeight:600, marginBottom:12 }}>ğŸ… ACHIEVEMENTS ({badges.length})</div>
            {badges.length === 0
              ? <div style={{ color:C.muted, fontSize:12, fontStyle:"italic" }}>Close your first job to start earning badges.</div>
              : (
                <div style={{ display:"flex", flexWrap:"wrap", gap:8 }}>
                  {badges.map(b => (
                    <div key={b.id} style={{ display:"flex", alignItems:"center", gap:8, background:b.color+"18", border:`1px solid ${b.color}44`, borderRadius:10, padding:"8px 12px" }}>
                      <span style={{ fontSize:20 }}>{b.icon}</span>
                      <div>
                        <div style={{ color:b.color, fontSize:12, fontWeight:700 }}>{b.label}</div>
                        <div style={{ color:C.muted, fontSize:10 }}>{b.desc}</div>
                      </div>
                    </div>
                  ))}
                </div>
              )
            }
          </div>

          {/* Monthly score history */}
          {allScores.length > 0 && (
            <div style={{ background:C.card, border:`1px solid ${C.border}`, borderRadius:14, padding:16 }}>
              <div style={{ color:C.muted, fontSize:11, fontWeight:600, marginBottom:12 }}>ğŸ“… MONTHLY SCORES</div>
              {[...allScores].reverse().map(s => {
                const r = getRank(s.score);
                return (
                  <div key={s.ym} style={{ display:"flex", alignItems:"center", gap:12, marginBottom:10 }}>
                    <div style={{ width:80, color:C.muted, fontSize:11, flexShrink:0 }}>{fmtMonthLabel(s.ym).slice(0,7)}</div>
                    <div style={{ flex:1, height:6, background:C.border, borderRadius:99 }}>
                      <div style={{ width:s.score+"%", height:"100%", background:r.color, borderRadius:99 }} />
                    </div>
                    <div style={{ width:32, textAlign:"right", color:r.color, fontSize:12, fontWeight:700, fontFamily:"'DM Mono',monospace" }}>{s.score}</div>
                    <div style={{ fontSize:14 }}>{r.icon}</div>
                  </div>
                );
              })}
            </div>
          )}
        </div>
      )}

      {/* â”€â”€ MONTHLY â”€â”€ */}
      {view === "monthly" && (
        <div>
          <div style={{ display:"flex", alignItems:"center", justifyContent:"space-between", marginBottom:14, flexWrap:"wrap", gap:8 }}>
            <div style={{ display:"flex", gap:6, flexWrap:"wrap" }}>
              {sortedMonths.length === 0
                ? <span style={{ color:C.muted, fontSize:13 }}>No closed jobs yet.</span>
                : sortedMonths.map(ym => (
                  <button key={ym} onClick={() => setSelMonth(ym)}
                    style={{ background:selMonth===ym?C.accent:C.panel, color:selMonth===ym?"#0A0C10":C.muted, border:`1px solid ${selMonth===ym?C.accent:C.border}`, borderRadius:8, padding:"5px 12px", fontSize:12, fontWeight:600, cursor:"pointer" }}>
                    {fmtMonthLabel(ym)}
                  </button>
                ))
              }
            </div>
            <button onClick={() => setEditMonthly(!editMonthly)}
              style={{ background:editMonthly?C.blue:C.panel, color:editMonthly?"#fff":C.muted, border:`1px solid ${editMonthly?C.blue:C.border}`, borderRadius:8, padding:"5px 12px", fontSize:12, fontWeight:600, cursor:"pointer" }}>
              {editMonthly ? "âœ“ Done" : "âœï¸ Adjust Goals"}
            </button>
          </div>

          {editMonthly && (
            <div style={{ background:C.card, border:`1px solid ${C.blue}44`, borderRadius:12, padding:16, marginBottom:16 }}>
              <div style={{ color:C.blue, fontSize:12, fontWeight:700, marginBottom:4 }}>Monthly Goal Targets</div>
              <div style={{ color:C.muted, fontSize:11, marginBottom:12 }}>
                {yearlyGoals ? "Auto-set from your yearly goal â€” fine-tune here if needed." : "Set manually, or set a yearly goal to auto-calculate."}
              </div>
              <div style={{ display:"grid", gridTemplateColumns:"repeat(auto-fit,minmax(150px,1fr))", gap:12 }}>
                {[
                  { key:"revenue",   label:"Monthly Revenue",  prefix:"$", suffix:"" },
                  { key:"gpDollars", label:"Monthly GP",        prefix:"$", suffix:"" },
                  { key:"jobs",      label:"Jobs / month",      prefix:"",  suffix:"" },
                  { key:"margin",    label:"Margin %",          prefix:"",  suffix:"%" },
                  { key:"avgTicket", label:"Avg Ticket",        prefix:"$", suffix:"" },
                ].map(g => (
                  <div key={g.key}>
                    <div style={{ color:C.muted, fontSize:10, fontWeight:600, marginBottom:4 }}>{g.label}</div>
                    <div style={{ position:"relative" }}>
                      {g.prefix ? <span style={{ position:"absolute", left:10, top:"50%", transform:"translateY(-50%)", color:C.muted }}>{g.prefix}</span> : null}
                      <input type="number" value={draftM[g.key]}
                        onChange={e => setDraftM(d => ({ ...d, [g.key]: Number(e.target.value) }))}
                        onBlur={() => setMonthly({ ...draftM })}
                        style={{ ...inputStyle, paddingLeft:g.prefix?24:13, paddingRight:g.suffix?24:13, width:"100%" }} />
                      {g.suffix ? <span style={{ position:"absolute", right:10, top:"50%", transform:"translateY(-50%)", color:C.muted }}>{g.suffix}</span> : null}
                    </div>
                  </div>
                ))}
              </div>
            </div>
          )}

          {selMonth && (() => {
            const s    = scoreMonth(monthJobs, monthly);
            const rank = getRank(s.score);
            return (
              <div>
                <div style={{ background:rank.color+"18", border:`1px solid ${rank.color}44`, borderRadius:12, padding:"10px 16px", marginBottom:14, display:"flex", alignItems:"center", gap:12 }}>
                  <span style={{ fontSize:28 }}>{rank.icon}</span>
                  <div>
                    <div style={{ fontFamily:"'Cabinet Grotesk',sans-serif", fontWeight:900, fontSize:18, color:rank.color }}>{fmtMonthLabel(selMonth)}</div>
                    <div style={{ color:C.muted, fontSize:12 }}>Score: <span style={{ color:rank.color, fontWeight:700 }}>{s.score}/100</span> Â· {rank.rank}</div>
                  </div>
                </div>
                <div style={{ display:"flex", flexDirection:"column", gap:10 }}>
                  {[
                    { key:"revenue",   label:"Revenue",      icon:"ğŸ’°", actual:s.rev,    goal:monthly.revenue,   color:C.accent, fmt:fmtDollarFull },
                    { key:"gpDollars", label:"Gross Profit", icon:"ğŸ“ˆ", actual:s.gp,     goal:monthly.gpDollars, color:C.green,  fmt:fmtDollarFull },
                    { key:"jobs",      label:"Jobs Closed",  icon:"ğŸ”¨", actual:s.jobs,   goal:monthly.jobs,      color:C.blue,   fmt:v=>String(Math.round(v)) },
                    { key:"margin",    label:"Gross Margin", icon:"ğŸ“Š", actual:s.margin, goal:monthly.margin,    color:C.purple, fmt:fmtPct },
                    { key:"avgTicket", label:"Avg Ticket",   icon:"ğŸ ", actual:s.ticket, goal:monthly.avgTicket, color:C.orange, fmt:fmtDollarFull },
                  ].map(k => {
                    const pct   = k.goal > 0 ? Math.min((k.actual / k.goal) * 100, 100) : 0;
                    const hit   = k.actual >= k.goal;
                    const delta = k.actual - k.goal;
                    return (
                      <div key={k.key} style={{ background:C.card, border:`1px solid ${hit?C.green+"44":C.border}`, borderRadius:12, padding:"14px 16px" }}>
                        <div style={{ display:"flex", alignItems:"center", justifyContent:"space-between", marginBottom:10 }}>
                          <div style={{ display:"flex", alignItems:"center", gap:10 }}>
                            <span style={{ fontSize:20 }}>{k.icon}</span>
                            <div>
                              <div style={{ color:C.text, fontWeight:600, fontSize:14 }}>{k.label}</div>
                              <div style={{ display:"flex", gap:8, alignItems:"baseline", marginTop:2 }}>
                                <span style={{ color:k.color, fontFamily:"'Cabinet Grotesk',sans-serif", fontWeight:800, fontSize:22 }}>{k.fmt(k.actual)}</span>
                                <span style={{ color:C.muted, fontSize:12 }}>/ {k.fmt(k.goal)}</span>
                              </div>
                            </div>
                          </div>
                          <div style={{ textAlign:"right" }}>
                            <div style={{ background:hit?C.greenDim:pct>=80?C.orangeDim:C.redDim, color:hit?C.green:pct>=80?C.orange:C.red, borderRadius:99, padding:"3px 10px", fontSize:11, fontWeight:600, marginBottom:3 }}>
                              {hit ? "âœ…" : "â¬œ"} {Math.round(pct)}%
                            </div>
                            <div style={{ color:delta>=0?C.green:C.red, fontSize:11, fontFamily:"'DM Mono',monospace", fontWeight:600 }}>
                              {(delta >= 0 ? "+" : "") + k.fmt(Math.abs(delta))} {delta >= 0 ? "above" : "below"}
                            </div>
                          </div>
                        </div>
                        <div style={{ height:5, background:C.border, borderRadius:99 }}>
                          <div style={{ width:pct+"%", height:"100%", background:hit?C.green:pct>=80?C.orange:C.red, borderRadius:99 }} />
                        </div>
                      </div>
                    );
                  })}
                </div>
                {franchisee.monthlyNotes && franchisee.monthlyNotes[selMonth] && (
                  <div style={{ background:C.card, border:`1px solid ${C.blue}33`, borderRadius:12, padding:"12px 16px", marginTop:14 }}>
                    <div style={{ color:C.blue, fontSize:11, fontWeight:600, marginBottom:5 }}>ğŸ“ BM Note</div>
                    <div style={{ color:C.text, fontSize:13, lineHeight:1.6 }}>{franchisee.monthlyNotes[selMonth]}</div>
                  </div>
                )}
                {monthJobs.length > 0 && (
                  <div style={{ background:C.card, border:`1px solid ${C.border}`, borderRadius:12, padding:16, marginTop:14 }}>
                    <div style={{ color:C.muted, fontSize:11, fontWeight:600, marginBottom:10 }}>JOBS THIS MONTH</div>
                    {monthJobs.map(job => {
                      const { gp, margin } = calcJobMargin(job);
                      const mc = margin < 30 ? C.red : margin < 40 ? C.orange : C.green;
                      return (
                        <div key={job.id} style={{ marginBottom:10 }}>
                          <div style={{ display:"flex", justifyContent:"space-between", marginBottom:3, flexWrap:"wrap", gap:4 }}>
                            <span style={{ color:C.text, fontSize:13, fontWeight:600 }}>{job.address}</span>
                            <div style={{ display:"flex", gap:12, alignItems:"center" }}>
                              <span style={{ color:C.muted, fontSize:12 }}>{job.customer}</span>
                              <span style={{ color:C.text, fontSize:12, fontFamily:"'DM Mono',monospace" }}>{fmtDollarFull(job.contractPrice)}</span>
                              <span style={{ color:mc, fontSize:12, fontFamily:"'DM Mono',monospace", fontWeight:600 }}>{fmtPct(margin)}</span>
                            </div>
                          </div>
                          <div style={{ height:4, background:C.border, borderRadius:99 }}>
                            <div style={{ width: Math.min(margin,60)/60*100 + "%", height:"100%", background:mc, borderRadius:99 }} />
                          </div>
                        </div>
                      );
                    })}
                  </div>
                )}
              </div>
            );
          })()}
        </div>
      )}

      {/* â”€â”€ YEAR TO DATE â”€â”€ */}
      {view === "ytd" && (
        <div>
          <div style={{ background:C.card, border:`1px solid ${C.border}`, borderRadius:16, padding:20, marginBottom:14 }}>
            <div style={{ display:"flex", justifyContent:"space-between", alignItems:"center", marginBottom:16, flexWrap:"wrap", gap:8 }}>
              <div style={{ color:C.muted, fontSize:11, fontWeight:600 }}>ANNUAL GOAL PROGRESS</div>
              {yearlyGoals && <span style={{ color:C.accent, fontSize:12, fontWeight:600 }}>{yearlyGoals.year} Â· Target: {fmtDollar(yearlyGoals.netIncome)}/yr net</span>}
            </div>
            {[
              { label:"Revenue",     current:ytdRevenue, goal:annualRev, color:C.accent, fmt:fmtDollarFull, fmtS:fmtDollar },
              { label:"Gross Profit",current:ytdGP,      goal:annualGP,  color:C.green,  fmt:fmtDollarFull, fmtS:fmtDollar },
            ].map(g => {
              const pct     = Math.min((g.current / g.goal) * 100, 100);
              const today   = new Date();
              const dayOfYr = Math.floor((today - new Date(today.getFullYear(),0,0)) / 86400000);
              const pacePct = Math.round((dayOfYr / 365) * 100);
              return (
                <div key={g.label} style={{ marginBottom:20 }}>
                  <div style={{ display:"flex", justifyContent:"space-between", marginBottom:6, flexWrap:"wrap", gap:4 }}>
                    <span style={{ color:C.text, fontWeight:600, fontSize:14 }}>{g.label}</span>
                    <span style={{ color:g.color, fontFamily:"'DM Mono',monospace", fontWeight:600 }}>{g.fmtS(g.current)} / {g.fmtS(g.goal)}</span>
                  </div>
                  <div style={{ position:"relative", height:12, background:C.border, borderRadius:99, marginBottom:4 }}>
                    <div style={{ position:"absolute", left:0, top:0, height:"100%", width:pct+"%", background:g.color, borderRadius:99 }} />
                    <div style={{ position:"absolute", top:-2, left:pacePct+"%", transform:"translateX(-50%)", width:2, height:16, background:C.muted, borderRadius:1 }} />
                  </div>
                  <div style={{ display:"flex", justifyContent:"space-between" }}>
                    <span style={{ color:C.muted, fontSize:10 }}>{Math.round(pct)}% complete</span>
                    <span style={{ color:pct>=pacePct?C.green:C.red, fontSize:10, fontWeight:600 }}>
                      {pct >= pacePct ? "âœ… Ahead of pace" : "âš ï¸ Behind pace"} ({pacePct}% of year elapsed)
                    </span>
                  </div>
                </div>
              );
            })}
          </div>

          <div style={{ background:C.card, border:`1px solid ${C.border}`, borderRadius:14, padding:18, marginBottom:14 }}>
            <div style={{ color:C.muted, fontSize:11, fontWeight:600, marginBottom:12 }}>ANNUAL RUN RATE</div>
            <div style={{ display:"grid", gridTemplateColumns:"repeat(auto-fit,minmax(140px,1fr))", gap:12 }}>
              {(() => {
                const mo  = sortedMonths.length || 1;
                const mrr = ytdRevenue / mo;
                const proj= mrr * 12;
                return [
                  { label:"Monthly avg revenue",     value:fmtDollar(mrr),                  color:C.accent },
                  { label:"Projected annual revenue", value:fmtDollar(proj),                 color:proj>=annualRev?C.green:C.red },
                  { label:"Months of data",           value:mo + " months",                  color:C.blue },
                  { label:"YTD jobs closed",          value:String(approvedJobs.length),     color:C.orange },
                  { label:"Projected jobs / year",    value:String(Math.round(approvedJobs.length/mo*12)), color:C.muted },
                ].map(s => (
                  <div key={s.label}>
                    <div style={{ color:C.muted, fontSize:10, fontWeight:500 }}>{s.label}</div>
                    <div style={{ color:s.color, fontFamily:"'Cabinet Grotesk',sans-serif", fontWeight:700, fontSize:18 }}>{s.value}</div>
                  </div>
                ));
              })()}
            </div>
          </div>

          {sortedMonths.length > 0 && (
            <div style={{ background:C.card, border:`1px solid ${C.border}`, borderRadius:14, padding:18 }}>
              <div style={{ color:C.muted, fontSize:11, fontWeight:600, marginBottom:14 }}>REVENUE BY MONTH vs GOAL</div>
              {[...sortedMonths].reverse().map(ym => {
                const mJobs = jobsByMonth[ym] || [];
                const mRev  = mJobs.reduce((a,j) => a+j.contractPrice, 0);
                const hit   = mRev >= monthly.revenue;
                const barW  = monthly.revenue > 0 ? Math.min((mRev/monthly.revenue)*100, 100) : 50;
                const ms    = scoreMonth(mJobs, monthly);
                const mr    = getRank(ms.score);
                return (
                  <div key={ym} style={{ marginBottom:12 }}>
                    <div style={{ display:"flex", justifyContent:"space-between", marginBottom:4, alignItems:"center" }}>
                      <div style={{ display:"flex", alignItems:"center", gap:8 }}>
                        <span style={{ fontSize:14 }}>{mr.icon}</span>
                        <span style={{ color:C.text, fontSize:12, fontWeight:500 }}>{fmtMonthLabel(ym)}</span>
                      </div>
                      <div style={{ display:"flex", gap:10, alignItems:"center" }}>
                        <span style={{ color:C.muted, fontSize:11 }}>{mJobs.length} job{mJobs.length!==1?"s":""}</span>
                        <span style={{ color:hit?C.green:C.text, fontFamily:"'DM Mono',monospace", fontSize:12, fontWeight:600 }}>{fmtDollarFull(mRev)}</span>
                        {hit && <span style={{ color:C.green, fontSize:11 }}>âœ…</span>}
                      </div>
                    </div>
                    <div style={{ height:6, background:C.border, borderRadius:99 }}>
                      <div style={{ width:barW+"%", height:"100%", background:hit?C.green:C.accent, borderRadius:99 }} />
                    </div>
                  </div>
                );
              })}
              <div style={{ marginTop:8, color:C.muted, fontSize:11 }}>Goal line: {fmtDollar(monthly.revenue)}/mo</div>
            </div>
          )}
        </div>
      )}

      {/* â”€â”€ HISTORY â”€â”€ */}
      {view === "history" && (
        <div>
          <div style={{ display:"grid", gridTemplateColumns:"repeat(auto-fit,minmax(140px,1fr))", gap:10, marginBottom:16 }}>
            <KPI icon="ğŸ’°" label="YTD Revenue"      value={fmtDollar(ytdRevenue)} color={C.green}  />
            <KPI icon="ğŸ“ˆ" label="YTD Gross Profit" value={fmtDollar(ytdGP)}      color={C.blue}   />
            <KPI icon="ğŸ“Š" label="Avg Margin"       value={fmtPct(ytdMargin)}     color={ytdMargin<30?C.red:C.green} />
            <KPI icon="ğŸ " label="Avg Ticket"       value={fmtDollar(avgTicket)}  color={C.accent} />
          </div>
          <div style={{ background:C.card, border:`1px solid ${C.border}`, borderRadius:14, padding:18 }}>
            <div style={{ color:C.muted, fontSize:11, fontWeight:600, marginBottom:14 }}>ALL APPROVED JOBS â€” newest first</div>
            {approvedJobs.length === 0
              ? <div style={{ color:C.muted, fontSize:13, textAlign:"center", padding:"16px 0" }}>No approved jobs yet.</div>
              : [...approvedJobs].sort((a,b) => (b.approvedAt||b.submittedAt||"").localeCompare(a.approvedAt||a.submittedAt||"")).map(job => {
                  const { gp, margin } = calcJobMargin(job);
                  const mc = margin < 30 ? C.red : margin < 40 ? C.orange : C.green;
                  return (
                    <div key={job.id} style={{ marginBottom:14 }}>
                      <div style={{ display:"flex", justifyContent:"space-between", marginBottom:4, flexWrap:"wrap", gap:4 }}>
                        <div>
                          <span style={{ color:C.text, fontSize:13, fontWeight:600 }}>{job.address}</span>
                          <span style={{ color:C.muted, fontSize:11, marginLeft:8 }}>{job.customer}</span>
                        </div>
                        <div style={{ display:"flex", gap:12, alignItems:"center" }}>
                          <span style={{ color:C.muted, fontSize:11 }}>{job.approvedAt || job.submittedAt}</span>
                          <span style={{ color:C.text, fontFamily:"'DM Mono',monospace", fontSize:12 }}>{fmtDollarFull(job.contractPrice)}</span>
                          <span style={{ color:mc, fontFamily:"'DM Mono',monospace", fontWeight:600, fontSize:12 }}>{fmtPct(margin)}</span>
                        </div>
                      </div>
                      <div style={{ height:4, background:C.border, borderRadius:99 }}>
                        <div style={{ width: Math.min(margin,60)/60*100 + "%", height:"100%", background:mc, borderRadius:99 }} />
                      </div>
                    </div>
                  );
                })
            }
          </div>
        </div>
      )}
    </div>
  );
}

// â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
// SHARED HELPERS
// â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
function daysBetween(a, b) {
  const d1 = new Date(a), d2 = new Date(b || new Date().toISOString().slice(0,10));
  return Math.round((d2 - d1) / 86400000);
}

function weekStart(dateStr) {
  const d = new Date(dateStr + "T12:00:00");
  const day = d.getDay();
  const diff = (day === 0) ? -6 : 1 - day;
  d.setDate(d.getDate() + diff);
  return d.toISOString().slice(0, 10);
}

function weekFriday(weekStartStr) {
  const d = new Date(weekStartStr + "T12:00:00");
  d.setDate(d.getDate() + 4);
  return d.toISOString().slice(0, 10);
}

function weekLabel(weekStartStr, short=false) {
  const start = new Date(weekStartStr + "T12:00:00");
  const fri   = new Date(weekStartStr + "T12:00:00");
  fri.setDate(start.getDate() + 4);
  const fmt = d => d.toLocaleDateString("en-US", { month:"short", day:"numeric" });
  if (short) return "Week of " + fmt(start);
  return fmt(start) + " â€“ " + fmt(fri);
}

function buildWeekOptions(jobs) {
  const weekSet = new Set();
  jobs.forEach(j => {
    const d = j.submittedAt || j.createdAt;
    if (d) weekSet.add(weekStart(d));
  });
  return Array.from(weekSet).sort().reverse();
}

function DaysAgo({ date, label }) {
  if (!date) return <span style={{ color:C.muted, fontSize:11 }}>{label} â€”</span>;
  const n = daysBetween(date);
  const color = n > 14 ? C.red : n > 7 ? C.orange : C.muted;
  return (
    <span style={{ color:C.muted, fontSize:11 }}>
      {label} <span style={{ color:C.text, fontWeight:500 }}>{date}</span>
      <span style={{ color, marginLeft:4, fontSize:10 }}>({n === 0 ? "today" : n === 1 ? "1 day ago" : `${n}d ago`})</span>
    </span>
  );
}

// Reusable expandable job details panel (full financials + payout)
function JobDetailPanel({ job }) {
  const { totalCost, gp, margin } = calcJobMargin(job);
  const marginColor = margin < 25 ? C.red : margin < 35 ? C.orange : C.green;
  const cats = ["materials","labor","dump","franchiseFee","warranty","other"];
  const variances = calcVariances(job);

  return (
    <div style={{ marginTop:12, borderTop:`1px solid ${C.border}`, paddingTop:14, display:"flex", flexDirection:"column", gap:12 }}>

      {/* Financial summary */}
      <div style={{ display:"flex", gap:14, flexWrap:"wrap", padding:"10px 14px", background:C.panel, borderRadius:10 }}>
        {[
          { l:"Contract",     v:fmtDollarFull(job.contractPrice), c:C.text },
          { l:"Total Cost",   v:fmtDollarFull(totalCost),          c:C.text },
          { l:"Gross Profit", v:fmtDollarFull(gp),                 c:gp>=0?C.green:C.red },
          { l:"Margin",       v:fmtPct(margin),                    c:marginColor },
        ].map(s=>(
          <div key={s.l}>
            <div style={{ color:C.muted, fontSize:11, fontWeight:500 }}>{s.l}</div>
            <div style={{ color:s.c, fontFamily:"'Cabinet Grotesk',sans-serif", fontWeight:700, fontSize:16 }}>{s.v}</div>
          </div>
        ))}
      </div>

      {/* Cost breakdown table */}
      <div style={{ background:C.panel, border:`1px solid ${C.border}`, borderRadius:10, overflow:"hidden" }}>
        <div style={{ display:"grid", gridTemplateColumns:"1fr 115px 115px 110px 140px", gap:0, padding:"7px 12px", borderBottom:`1px solid ${C.border}` }}>
          {["Category","Estimated","Actual","Difference","Variance"].map(h=>(
            <div key={h} style={{ color:C.muted, fontSize:10, fontWeight:600, textAlign:h==="Category"?"left":"right", paddingRight: h==="Category"?0:8 }}>{h}</div>
          ))}
        </div>
        {variances.map(v=>{
          const m = CAT_META[v.cat];
          const rowColor = v.over ? C.red : v.under ? C.orange : v.hasActuals ? C.green : C.muted;
          return (
            <div key={v.cat} style={{ display:"grid", gridTemplateColumns:"1fr 115px 115px 110px 140px", gap:0, padding:"7px 12px", borderBottom:`1px solid ${C.border}`, alignItems:"center", background:v.over?C.red+"08":v.under?C.orange+"08":"transparent" }}>
              <div style={{ color:m.color, fontSize:12, fontWeight:500 }}>{m.icon} {m.label}</div>
              <div style={{ color:C.muted, fontSize:12, fontFamily:"'DM Mono',monospace", textAlign:"right", paddingRight:8 }}>{v.est>0?fmtDollarFull(v.est):"â€”"}</div>
              <div style={{ color:C.text, fontSize:12, fontFamily:"'DM Mono',monospace", textAlign:"right", paddingRight:8 }}>{v.hasActuals?fmtDollarFull(v.actual):"â€”"}</div>
              <div style={{ color:v.isFixed?C.muted:v.diff>0?C.red:v.diff<0?C.green:C.muted, fontSize:12, fontFamily:"'DM Mono',monospace", textAlign:"right", paddingRight:8 }}>
                {v.isFixed?"â€”":v.hasActuals&&v.est>0?(v.diff>=0?"+":"")+fmtDollarFull(v.diff):"â€”"}
              </div>
              <div style={{ textAlign:"right" }}>
                {v.isFixed
                  ? <span style={{ color:C.purple, fontSize:10, fontWeight:600, background:C.purpleDim, borderRadius:99, padding:"1px 7px" }}>ğŸ›¡ï¸ Fixed</span>
                  : v.hasActuals && v.est>0
                    ? <span style={{ color:rowColor, fontSize:11, fontFamily:"'DM Mono',monospace", fontWeight:600 }}>{v.over?"ğŸ”´":v.under?"ğŸŸ¡":"âœ…"} {(v.variancePct>=0?"+":"")+v.variancePct.toFixed(1)}%</span>
                    : <span style={{ color:C.muted, fontSize:11 }}>â€”</span>
                }
              </div>
            </div>
          );
        })}
      </div>

      {/* Payout status */}
      {job.payouts && (
        <div style={{ background:C.greenDim, border:`1px solid ${C.green}33`, borderRadius:10, padding:"10px 14px" }}>
          <div style={{ color:C.green, fontSize:11, fontWeight:600, marginBottom:6 }}>Payout status</div>
          <div style={{ display:"flex", gap:14, flexWrap:"wrap" }}>
            {job.payouts.materials?.map((p,i)=>(
              <div key={i} style={{ fontSize:12 }}>
                <span style={{ color:C.muted }}>Materials: </span>
                <span style={{ color:C.text }}>{fmtDollarFull(p.amount)} </span>
                <span style={{ color:p.status==="paid"?C.green:C.orange, fontSize:11, fontWeight:500 }}>{p.status==="paid"?"â— Paid":"â— Pending"}</span>
              </div>
            ))}
            {job.payouts.franchisee && (
              <div style={{ fontSize:12 }}>
                <span style={{ color:C.muted }}>Your GP: </span>
                <span style={{ color:C.green, fontWeight:700 }}>{fmtDollarFull(job.payouts.franchisee.net)} </span>
                <span style={{ color:job.payouts.franchisee.status==="paid"?C.green:C.orange, fontSize:11, fontWeight:500 }}>{job.payouts.franchisee.status==="paid"?"â— Paid":"â— Pending"}</span>
              </div>
            )}
          </div>
        </div>
      )}

      {/* BM note if any */}
      {job.bmNote && (
        <div style={{ background:C.orangeDim, border:`1px solid ${C.orange}33`, borderRadius:8, padding:"8px 12px", color:C.orange, fontSize:12 }}>
          ğŸ“ BM note: {job.bmNote}
        </div>
      )}

      {/* Approved/closed timestamp */}
      {job.approvedAt && (
        <div style={{ color:C.muted, fontSize:11 }}>
          âœ… Approved <span style={{ color:C.text, fontWeight:500 }}>{job.approvedAt}</span>
        </div>
      )}
    </div>
  );
}

// â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
// FRANCHISEE JOBS TAB
// â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
function FranchiseeJobsTab({ franchisee, myJobs, onCostJob, onSubmitJob, onCreateJob, showNewJob, newJob, setNewJob, onCreateJobSubmit, onCancelNewJob }) {
  const [statusFilter, setStatusFilter] = useState("all");
  const [weekFilter, setWeekFilter]     = useState("all"); // "all" or ISO week-start string
  const [sortBy, setSortBy]             = useState("submitted_desc");
  const [expandedJobs, setExpandedJobs] = useState(new Set());

  // Next weekly closeout meeting â€” next Friday
  const today = new Date();
  const daysUntilFriday = (5 - today.getDay() + 7) % 7 || 7;
  const nextMeeting = new Date(today); nextMeeting.setDate(today.getDate() + daysUntilFriday);
  const nextMeetingStr = nextMeeting.toLocaleDateString("en-US", { weekday:"long", month:"short", day:"numeric" });

  const weekOptions = buildWeekOptions(myJobs);

  const counts = {
    all:     myJobs.length,
    open:    myJobs.filter(j=>j.status==="open").length,
    pending: myJobs.filter(j=>j.status==="pending_review").length,
    flagged: myJobs.filter(j=>j.status==="flagged").length,
    approved:myJobs.filter(j=>["approved","closed"].includes(j.status)).length,
  };

  const statusFilters = [
    { id:"all",      label:"All",              count:counts.all,      color:C.text },
    { id:"open",     label:"Open",             count:counts.open,     color:C.muted },
    { id:"pending",  label:"Pending review",   count:counts.pending,  color:C.accent },
    { id:"flagged",  label:"Flagged",          count:counts.flagged,  color:C.red },
    { id:"approved", label:"Approved / Paid",  count:counts.approved, color:C.green },
  ];

  // Filter by status
  const statusFiltered = myJobs.filter(j => {
    if (statusFilter === "all") return true;
    if (statusFilter === "approved") return ["approved","closed"].includes(j.status);
    return j.status === statusFilter;
  });

  // Filter by submission week
  const filtered = weekFilter === "all" ? statusFiltered : statusFiltered.filter(j => {
    const d = j.submittedAt || j.createdAt;
    return d && weekStart(d) === weekFilter;
  });

  // Sort
  const sortKey = j => {
    if (sortBy === "submitted_desc" || sortBy === "submitted_asc") return j.submittedAt || j.createdAt || "";
    return j.createdAt || "";
  };
  const sorted = [...filtered].sort((a, b) => {
    const va = sortKey(a), vb = sortKey(b);
    return sortBy.endsWith("_desc") ? vb.localeCompare(va) : va.localeCompare(vb);
  });

  function toggleExpand(id) {
    setExpandedJobs(s => { const n=new Set(s); n.has(id)?n.delete(id):n.add(id); return n; });
  }

  return (
    <div>
      {/* Header */}
      <div style={{ display:"flex", alignItems:"center", justifyContent:"space-between", marginBottom:14 }}>
        <div>
          <h1 style={{ fontFamily:"'Cabinet Grotesk',sans-serif", fontSize:24, fontWeight:900, margin:0 }}>Your Jobs</h1>
          <p style={{ color:C.muted, fontSize:13, margin:"4px 0 0" }}>Cost your jobs, submit for closeout, track payouts.</p>
        </div>
        <button onClick={onCreateJob} style={btnPrimary}>+ New Job</button>
      </div>

      {/* Next meeting deadline banner */}
      <div style={{ background:C.accentDim, border:`1px solid ${C.accent}44`, borderRadius:12, padding:"10px 16px", marginBottom:14, display:"flex", alignItems:"center", justifyContent:"space-between", flexWrap:"wrap", gap:8 }}>
        <div>
          <span style={{ color:C.accent, fontWeight:600, fontSize:13 }}>ğŸ“… Next closeout meeting: {nextMeetingStr}</span>
          <span style={{ color:C.muted, fontSize:12, marginLeft:8 }}>Submit your costs before this date to get paid this week.</span>
        </div>
        {counts.pending > 0 && (
          <span style={{ color:C.accent, fontSize:12, fontWeight:600 }}>{counts.pending} job{counts.pending!==1?"s":""} in review</span>
        )}
      </div>

      {/* New job form */}
      {showNewJob && (
        <div style={{ background:C.card, border:`1px solid ${C.accent}44`, borderRadius:14, padding:18, marginBottom:14 }}>
          <div style={{ color:C.muted, fontSize:11, fontWeight:500, marginBottom:12 }}>Create new job</div>
          <div style={{ display:"flex", gap:10, flexWrap:"wrap", marginBottom:10 }}>
            <input style={{ ...inputStyle, flex:"2 1 200px" }} placeholder="Job address" value={newJob.address} onChange={e=>setNewJob(n=>({...n,address:e.target.value}))} />
            <input style={{ ...inputStyle, flex:"1 1 150px" }} placeholder="Customer name" value={newJob.customer} onChange={e=>setNewJob(n=>({...n,customer:e.target.value}))} />
            <div style={{ position:"relative", flex:"1 1 120px" }}>
              <span style={{ position:"absolute", left:10, top:"50%", transform:"translateY(-50%)", color:C.muted, zIndex:1 }}>$</span>
              <NumericInput value={newJob.contractPrice} onChange={v=>setNewJob(n=>({...n,contractPrice:v}))} placeholder="Contract price" style={{ paddingLeft:22 }} />
            </div>
          </div>
          <div style={{ display:"flex", gap:8 }}>
            <button onClick={onCancelNewJob} style={btnSecondary}>Cancel</button>
            <button onClick={onCreateJobSubmit} style={btnPrimary}>Create Job â†’</button>
          </div>
        </div>
      )}

      {/* Filter + sort bar */}
      <div style={{ display:"flex", flexDirection:"column", gap:8, marginBottom:12 }}>
        {/* Status filters */}
        <div style={{ display:"flex", alignItems:"center", justifyContent:"space-between", flexWrap:"wrap", gap:8 }}>
          <div style={{ display:"flex", gap:4, flexWrap:"wrap" }}>
            {statusFilters.map(f=>(
              <button key={f.id} onClick={()=>setStatusFilter(f.id)}
                style={{ background:statusFilter===f.id?f.color:C.panel, color:statusFilter===f.id?"#0A0C10":f.color, border:`1px solid ${statusFilter===f.id?f.color:C.border}`, borderRadius:20, padding:"5px 12px", fontSize:12, fontWeight:600, cursor:"pointer", fontFamily:"'Inter',sans-serif", whiteSpace:"nowrap" }}>
                {f.label} {f.count > 0 && <span style={{ opacity:0.8 }}>({f.count})</span>}
              </button>
            ))}
          </div>
          <select value={sortBy} onChange={e=>setSortBy(e.target.value)}
            style={{ ...inputStyle, width:"auto", fontSize:12, padding:"6px 10px", cursor:"pointer" }}>
            <option value="submitted_desc">Submitted: newest first</option>
            <option value="submitted_asc">Submitted: oldest first</option>
            <option value="created_desc">Created: newest first</option>
            <option value="created_asc">Created: oldest first</option>
          </select>
        </div>

        {/* Week filter */}
        <div style={{ display:"flex", alignItems:"center", gap:8, flexWrap:"wrap" }}>
          <span style={{ color:C.muted, fontSize:12, fontWeight:500, whiteSpace:"nowrap" }}>ğŸ“… Week:</span>
          <div style={{ display:"flex", gap:4, flexWrap:"wrap" }}>
            <button onClick={()=>setWeekFilter("all")}
              style={{ background:weekFilter==="all"?C.blue:C.panel, color:weekFilter==="all"?"#fff":C.muted, border:`1px solid ${weekFilter==="all"?C.blue:C.border}`, borderRadius:20, padding:"4px 11px", fontSize:11, fontWeight:600, cursor:"pointer" }}>
              All weeks
            </button>
            {weekOptions.map(ws=>{
              const fri = weekFriday(ws);
              const jobsThisWeek = myJobs.filter(j=>{ const d=j.submittedAt||j.createdAt; return d&&weekStart(d)===ws; });
              const active = weekFilter === ws;
              return (
                <button key={ws} onClick={()=>setWeekFilter(ws)}
                  style={{ background:active?C.blue:C.panel, color:active?"#fff":C.muted, border:`1px solid ${active?C.blue:C.border}`, borderRadius:20, padding:"4px 11px", fontSize:11, fontWeight:600, cursor:"pointer", whiteSpace:"nowrap" }}
                  title={`Closeout meeting: Fri ${fri}`}>
                  {weekLabel(ws, true)} <span style={{ opacity:0.7 }}>({jobsThisWeek.length})</span>
                </button>
              );
            })}
          </div>
        </div>
      </div>

      {/* Job count context */}
      <div style={{ color:C.muted, fontSize:12, marginBottom:10 }}>
        Showing {sorted.length} of {myJobs.length} job{myJobs.length!==1?"s":""}
        {(statusFilter !== "all" || weekFilter !== "all") && (
          <span> Â· <button onClick={()=>{ setStatusFilter("all"); setWeekFilter("all"); }} style={{ background:"none", border:"none", color:C.accent, cursor:"pointer", fontSize:12, padding:0 }}>clear filters</button></span>
        )}
      </div>

      {/* Job list */}
      {sorted.length === 0
        ? <div style={{ background:C.card, border:`1px dashed ${C.border}`, borderRadius:14, padding:"32px", textAlign:"center", color:C.muted }}>
            {myJobs.length === 0 ? "No jobs yet. Create your first job above." : "No jobs match this filter."}
          </div>
        : (
          <div style={{ display:"flex", flexDirection:"column", gap:10 }}>
            {sorted.map(job => {
              const { totalCost, gp, margin } = calcJobMargin(job);
              const hasActuals = ["materials","labor","dump","franchiseFee","warranty","other"].some(c=>(job.actuals?.[c]?.length||0)>0);
              const marginColor = margin < 25 ? C.red : margin < 35 ? C.orange : C.green;
              const liveFlags = evaluateFlags(job);
              const isApproved = ["approved","closed"].includes(job.status);
              const expanded = expandedJobs.has(job.id);
              const accentLeft = job.status==="flagged" ? C.red : isApproved ? C.green : job.status==="pending_review" ? C.accent : C.muted;

              return (
                <div key={job.id} style={{ background:C.card, border:`1px solid ${C.border}`, borderLeft:`3px solid ${accentLeft}`, borderRadius:14, padding:18 }}>
                  {/* Top row */}
                  <div style={{ display:"flex", alignItems:"flex-start", justifyContent:"space-between", flexWrap:"wrap", gap:10 }}>
                    <div style={{ flex:1 }}>
                      <div style={{ fontWeight:700, fontSize:15, color:C.text, marginBottom:3 }}>{job.address}</div>
                      <div style={{ color:C.muted, fontSize:12 }}>{job.customer} Â· <span style={{ color:C.accent }}>{fmtDollarFull(job.contractPrice)}</span></div>
                      {/* Date timeline */}
                      <div style={{ display:"flex", gap:14, marginTop:6, flexWrap:"wrap" }}>
                        <DaysAgo date={job.createdAt} label="Created" />
                        {job.submittedAt && <DaysAgo date={job.submittedAt} label="Submitted" />}
                        {job.approvedAt  && <DaysAgo date={job.approvedAt}  label="Approved" />}
                        {!job.submittedAt && job.status === "open" && (
                          <span style={{ color:C.orange, fontSize:11, fontWeight:600 }}>âš  Not yet submitted</span>
                        )}
                      </div>
                    </div>
                    <div style={{ display:"flex", alignItems:"center", gap:8, flexWrap:"wrap" }}>
                      {liveFlags.map((f,i)=><FlagBadge key={i} flag={f} />)}
                      <StatusBadge status={job.status} />
                    </div>
                  </div>

                  {/* Quick stats row (always visible if has actuals) */}
                  {hasActuals && !expanded && (
                    <div style={{ display:"flex", gap:14, padding:"8px 12px", background:C.panel, borderRadius:9, marginTop:10, flexWrap:"wrap" }}>
                      {[
                        { l:"Total Cost",  v:fmtDollarFull(totalCost), c:C.text },
                        { l:"Gross Profit",v:fmtDollarFull(gp),        c:gp>=0?C.green:C.red },
                        { l:"Margin",      v:fmtPct(margin),            c:marginColor },
                      ].map(s=>(
                        <div key={s.l}>
                          <div style={{ color:C.muted, fontSize:11, fontWeight:500 }}>{s.l}</div>
                          <div style={{ color:s.c, fontFamily:"'Cabinet Grotesk',sans-serif", fontWeight:700, fontSize:15 }}>{s.v}</div>
                        </div>
                      ))}
                    </div>
                  )}

                  {/* Expanded details */}
                  {expanded && <JobDetailPanel job={job} />}

                  {/* Action row */}
                  <div style={{ display:"flex", gap:8, flexWrap:"wrap", marginTop:12, alignItems:"center" }}>
                    {["open","flagged"].includes(job.status) && (
                      <button onClick={()=>onCostJob(job)} style={{ ...btnPrimary, fontSize:12 }}>
                        {job.status==="flagged"?"âœï¸ Fix & Resubmit":"ğŸ“ Enter Costs"}
                      </button>
                    )}
                    {job.status==="open" && totalCost > 0 && (
                      <button onClick={()=>onSubmitJob(job.id)} style={{ background:C.greenDim, color:C.green, border:`1px solid ${C.green}44`, borderRadius:9, padding:"8px 14px", fontSize:12, fontWeight:700, cursor:"pointer" }}>
                        Submit for Closeout â†’
                      </button>
                    )}
                    {job.status==="pending_review" && (
                      <span style={{ color:C.muted, fontSize:12, padding:"8px 0" }}>â³ Awaiting BM review</span>
                    )}
                    {/* View details toggle â€” always available if has actuals or is approved */}
                    {(hasActuals || isApproved) && (
                      <button onClick={()=>toggleExpand(job.id)}
                        style={{ background:"none", border:`1px solid ${C.border}`, borderRadius:9, padding:"7px 13px", fontSize:12, color:C.muted, cursor:"pointer", marginLeft:"auto" }}>
                        {expanded ? "â–² Hide details" : "â–¼ View details"}
                      </button>
                    )}
                  </div>
                </div>
              );
            })}
          </div>
        )
      }
    </div>
  );
}

// â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
// â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
// FILTER DROPDOWN â€” multi-select with Select All
// â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
function FilterDropdown({ label, icon, options, selected, onChange, colorMap }) {
  const [open, setOpen] = useState(false);
  const ref = React.useRef(null);

  React.useEffect(() => {
    function handler(e) { if (ref.current && !ref.current.contains(e.target)) setOpen(false); }
    document.addEventListener("mousedown", handler);
    return () => document.removeEventListener("mousedown", handler);
  }, []);

  const allSelected = selected.length === 0;
  const activeCount = selected.length;

  function toggle(id) {
    if (selected.includes(id)) onChange(selected.filter(x => x !== id));
    else onChange([...selected, id]);
  }

  return (
    <div ref={ref} style={{ position:"relative" }}>
      <button onClick={() => setOpen(!open)}
        style={{ display:"flex", alignItems:"center", gap:6, background:activeCount>0?C.accentDim:C.panel, color:activeCount>0?C.accent:C.muted, border:`1px solid ${activeCount>0?C.accent+"55":C.border}`, borderRadius:8, padding:"7px 12px", fontSize:12, fontWeight:600, cursor:"pointer", fontFamily:"'Inter',sans-serif", whiteSpace:"nowrap" }}>
        <span>{icon}</span>
        <span>{label}{activeCount > 0 ? " ("+activeCount+")" : ""}</span>
        <span style={{ fontSize:10, opacity:0.7 }}>{open ? "â–²" : "â–¼"}</span>
      </button>
      {open && (
        <div style={{ position:"absolute", top:"calc(100% + 6px)", left:0, zIndex:300, background:C.card, border:`1px solid ${C.border}`, borderRadius:12, padding:8, boxShadow:"0 8px 32px rgba(0,0,0,0.4)", minWidth:200, maxHeight:280, overflowY:"auto" }}>
          <button onClick={() => onChange([])}
            style={{ width:"100%", textAlign:"left", background:allSelected?C.accentDim:"none", color:allSelected?C.accent:C.muted, border:"none", borderRadius:7, padding:"7px 10px", fontSize:12, fontWeight:allSelected?700:400, cursor:"pointer", marginBottom:4 }}>
            All {label}
          </button>
          {options.map(opt => {
            const sel = selected.includes(opt.id);
            const col = colorMap?.[opt.id];
            return (
              <button key={opt.id} onClick={() => toggle(opt.id)}
                style={{ width:"100%", textAlign:"left", background:sel?(col||C.accent)+"22":"none", color:sel?(col||C.accent):C.text, border:"none", borderRadius:7, padding:"7px 10px", fontSize:12, fontWeight:sel?600:400, cursor:"pointer", display:"flex", alignItems:"center", justifyContent:"space-between", gap:8 }}>
                <span>{opt.label}</span>
                <div style={{ display:"flex", alignItems:"center", gap:6 }}>
                  {opt.badge && <span style={{ background:opt.badge.color+"22", color:opt.badge.color, borderRadius:99, padding:"1px 7px", fontSize:10, fontWeight:600 }}>{opt.badge.label}</span>}
                  {opt.count != null && <span style={{ color:C.muted, fontSize:11 }}>{opt.count}</span>}
                  {sel && <span style={{ color:col||C.accent, fontSize:12 }}>âœ“</span>}
                </div>
              </button>
            );
          })}
        </div>
      )}
    </div>
  );
}

// â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
// DATE RANGE PICKER
// â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
const MONTH_NAMES = ["January","February","March","April","May","June","July","August","September","October","November","December"];
const DAYS = ["Mo","Tu","We","Th","Fr","Sa","Su"];

function DateRangePicker({ dateFrom, dateTo, onChange }) {
  const [open, setOpen]         = useState(false);
  const [selecting, setSelecting] = useState("from");
  const [hovered, setHovered]   = useState(null);
  const ref = React.useRef(null);

  const now = new Date();
  const [year,  setYear]  = useState(now.getFullYear());
  const [month, setMonth] = useState(now.getMonth());

  React.useEffect(() => {
    function handler(e) { if (ref.current && !ref.current.contains(e.target)) setOpen(false); }
    document.addEventListener("mousedown", handler);
    return () => document.removeEventListener("mousedown", handler);
  }, []);

  const hasFilter = dateFrom || dateTo;
  const triggerLabel = hasFilter
    ? [(dateFrom ? fmtDateShort(dateFrom) : "â€”"), (dateTo ? fmtDateShort(dateTo) : "â€”")].join(" â†’ ")
    : "All dates";

  function fmtDateShort(iso) {
    if (!iso) return "";
    const [y,m,d] = iso.split("-");
    return MONTH_NAMES[Number(m)-1].slice(0,3) + " " + d + ", " + y;
  }

  function isoDate(y, m, d) {
    return y + "-" + String(m+1).padStart(2,"0") + "-" + String(d).padStart(2,"0");
  }

  const firstDay = (new Date(year, month, 1).getDay() + 6) % 7;
  const totalDays = new Date(year, month+1, 0).getDate();

  function prevMonth() { if (month === 0) { setMonth(11); setYear(y => y-1); } else setMonth(m => m-1); }
  function nextMonth() { if (month === 11) { setMonth(0); setYear(y => y+1); } else setMonth(m => m+1); }

  function handleDayClick(iso) {
    if (selecting === "from") {
      onChange({ from: iso, to: null });
      setSelecting("to");
    } else {
      if (iso < dateFrom) { onChange({ from: iso, to: dateFrom }); }
      else { onChange({ from: dateFrom, to: iso }); }
      setSelecting("from");
      setOpen(false);
    }
  }

  function clearDates() { onChange({ from: null, to: null }); setSelecting("from"); }

  return (
    <div ref={ref} style={{ position:"relative" }}>
      <button onClick={() => setOpen(!open)}
        style={{ display:"flex", alignItems:"center", gap:6, background:hasFilter?C.accentDim:C.panel, color:hasFilter?C.accent:C.muted, border:`1px solid ${hasFilter?C.accent+"55":C.border}`, borderRadius:8, padding:"7px 12px", fontSize:12, fontWeight:600, cursor:"pointer", fontFamily:"'Inter',sans-serif", whiteSpace:"nowrap", minWidth:150 }}>
        <span>ğŸ“…</span>
        <span style={{ flex:1, textAlign:"left" }}>Date range: <span style={{ fontWeight:700 }}>{triggerLabel}</span></span>
        <span style={{ fontSize:10, opacity:0.7 }}>{open ? "â–²" : "â–¼"}</span>
      </button>
      {open && (
        <div style={{ position:"absolute", top:"calc(100% + 6px)", left:0, zIndex:300, background:C.card, border:`1px solid ${C.border}`, borderRadius:14, padding:16, boxShadow:"0 8px 32px rgba(0,0,0,0.4)", minWidth:280 }}>
          <div style={{ display:"flex", justifyContent:"space-between", alignItems:"center", marginBottom:12 }}>
            <div style={{ display:"flex", gap:8 }}>
              <span style={{ fontSize:11, padding:"3px 8px", borderRadius:99, background:selecting==="from"?C.blue:C.panel, color:selecting==="from"?"#fff":C.muted, fontWeight:600 }}>
                From: {dateFrom ? fmtDateShort(dateFrom) : "â€”"}
              </span>
              <span style={{ fontSize:11, padding:"3px 8px", borderRadius:99, background:selecting==="to"?C.blue:C.panel, color:selecting==="to"?"#fff":C.muted, fontWeight:600 }}>
                To: {dateTo ? fmtDateShort(dateTo) : "â€”"}
              </span>
            </div>
            {hasFilter && <button onClick={clearDates} style={{ background:"none", border:"none", color:C.red, fontSize:11, cursor:"pointer", fontWeight:600 }}>Clear</button>}
          </div>
          <div style={{ display:"flex", alignItems:"center", justifyContent:"space-between", marginBottom:10 }}>
            <button onClick={prevMonth} style={{ background:"none", border:`1px solid ${C.border}`, borderRadius:6, padding:"3px 8px", color:C.muted, cursor:"pointer", fontSize:14 }}>â€¹</button>
            <span style={{ color:C.text, fontWeight:600, fontSize:13 }}>{MONTH_NAMES[month]} {year}</span>
            <button onClick={nextMonth} style={{ background:"none", border:`1px solid ${C.border}`, borderRadius:6, padding:"3px 8px", color:C.muted, cursor:"pointer", fontSize:14 }}>â€º</button>
          </div>
          <div style={{ display:"grid", gridTemplateColumns:"repeat(7,1fr)", gap:2, marginBottom:4 }}>
            {DAYS.map(d => <div key={d} style={{ textAlign:"center", color:C.muted, fontSize:10, fontWeight:600, padding:"2px 0" }}>{d}</div>)}
          </div>
          <div style={{ display:"grid", gridTemplateColumns:"repeat(7,1fr)", gap:2 }}>
            {Array.from({ length: firstDay }).map((_,i) => <div key={"e"+i} />)}
            {Array.from({ length: totalDays }).map((_,i) => {
              const day = i + 1;
              const iso = isoDate(year, month, day);
              const isFrom  = iso === dateFrom;
              const isTo    = iso === dateTo;
              const inRange = dateFrom && dateTo && iso > dateFrom && iso < dateTo;
              const isHover = hovered && dateFrom && !dateTo && iso > dateFrom && iso <= hovered;
              const isEnd   = isFrom || isTo;
              const bg = isEnd ? C.blue : (inRange || isHover) ? C.blue+"44" : "transparent";
              const fg = isEnd ? "#fff" : (inRange || isHover) ? C.blue : C.text;
              return (
                <div key={day} onClick={() => handleDayClick(iso)} onMouseEnter={() => setHovered(iso)} onMouseLeave={() => setHovered(null)}
                  style={{ textAlign:"center", padding:"5px 2px", cursor:"pointer", borderRadius:6, background:bg, color:fg, fontSize:12, fontWeight:isEnd?700:400 }}>
                  {day}
                </div>
              );
            })}
          </div>
          <div style={{ borderTop:`1px solid ${C.border}`, marginTop:12, paddingTop:10, display:"flex", gap:6, flexWrap:"wrap" }}>
            {[
              { label:"This month", fn:() => { const d=new Date(); return { from:`${d.getFullYear()}-${String(d.getMonth()+1).padStart(2,"0")}-01`, to:new Date(d.getFullYear(),d.getMonth()+1,0).toISOString().slice(0,10) }; } },
              { label:"Last 30d",   fn:() => { const d=new Date(), f=new Date(d); f.setDate(d.getDate()-30); return { from:f.toISOString().slice(0,10), to:d.toISOString().slice(0,10) }; } },
              { label:"This year",  fn:() => { const y=new Date().getFullYear(); return { from:`${y}-01-01`, to:`${y}-12-31` }; } },
            ].map(q => (
              <button key={q.label} onClick={() => { onChange(q.fn()); setOpen(false); }}
                style={{ background:C.panel, border:`1px solid ${C.border}`, borderRadius:6, padding:"4px 9px", fontSize:11, color:C.muted, cursor:"pointer", fontWeight:500 }}>
                {q.label}
              </button>
            ))}
          </div>
        </div>
      )}
    </div>
  );
}

// BM QUEUE TAB
// â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
function BMQueueTab({ allMyJobs, myFranchisees, pendingJobs, flaggedJobs, approvedThisWeek, totalPayoutPending, onReview }) {
  const [statusSel, setStatusSel]         = useState([]);  // [] = all
  const [franchiseeSel, setFranchiseeSel] = useState([]);  // [] = all
  const [dateRange, setDateRange]         = useState({ from:null, to:null });
  const [sortBy, setSortBy]               = useState("submitted_desc");
  const [expandedJobs, setExpandedJobs]   = useState(new Set());

  const STATUS_OPTS = [
    { id:"pending_review", label:"Pending Review", count:pendingJobs.length,                                                    badge:{ label:"Needs Action", color:C.accent } },
    { id:"flagged",        label:"Flagged",         count:flaggedJobs.length,                                                   badge:{ label:"Needs Action", color:C.red } },
    { id:"approved",       label:"Approved",        count:allMyJobs.filter(j=>["approved","closed"].includes(j.status)).length, badge:null },
    { id:"open",           label:"Open",            count:allMyJobs.filter(j=>j.status==="open").length,                       badge:null },
  ];
  const STATUS_COLOR_MAP = { pending_review:C.accent, flagged:C.red, approved:C.green, open:C.muted };

  const FRANCHISEE_OPTS = myFranchisees.map(f => {
    const fJobs = allMyJobs.filter(j=>j.fid===f.id);
    const hasPending = fJobs.some(j=>["pending_review","flagged"].includes(j.status));
    return { id:f.id, label:f.name, count:fJobs.length, badge: hasPending ? { label:"âš¡ Action", color:C.orange } : null };
  });

  const filtered = allMyJobs.filter(j => {
    if (statusSel.length > 0) {
      const ok = statusSel.some(s => s === "approved" ? ["approved","closed"].includes(j.status) : j.status === s);
      if (!ok) return false;
    }
    if (franchiseeSel.length > 0 && !franchiseeSel.includes(j.fid)) return false;
    const d = j.submittedAt || j.createdAt;
    if (dateRange.from && d && d < dateRange.from) return false;
    if (dateRange.to   && d && d > dateRange.to)   return false;
    return true;
  });

  const sortKey = j => sortBy.startsWith("submitted") ? (j.submittedAt || j.createdAt || "") : (j.createdAt || "");
  const sorted = [...filtered].sort((a,b) => {
    const va=sortKey(a), vb=sortKey(b);
    return sortBy.endsWith("_desc") ? vb.localeCompare(va) : va.localeCompare(vb);
  });

  const hasAnyFilter = statusSel.length > 0 || franchiseeSel.length > 0 || dateRange.from || dateRange.to;
  const singleFranchisee = franchiseeSel.length === 1 ? myFranchisees.find(f=>f.id===franchiseeSel[0]) : null;

  function resetFilters() { setStatusSel([]); setFranchiseeSel([]); setDateRange({ from:null, to:null }); }
  function toggleExpand(id) { setExpandedJobs(s=>{ const n=new Set(s); n.has(id)?n.delete(id):n.add(id); return n; }); }

  return (
    <div>
      <div style={{ marginBottom:14 }}>
        <h1 style={{ fontFamily:"'Cabinet Grotesk',sans-serif", fontSize:24, fontWeight:900, margin:0 }}>Closeout Queue</h1>
        <p style={{ color:C.muted, fontSize:13, margin:"4px 0 0" }}>Jobs across {myFranchisees.length} franchisees. Review pending submissions each week.</p>
      </div>

      {/* KPI strip */}
      <div style={{ display:"grid", gridTemplateColumns:"repeat(auto-fit,minmax(130px,1fr))", gap:10, marginBottom:16 }}>
        <KPI icon="â³" label="Pending Review"  value={pendingJobs.length}              color={C.accent} />
        <KPI icon="ğŸš©" label="Flagged"          value={flaggedJobs.length}              color={C.red} />
        <KPI icon="âœ…" label="Approved"         value={approvedThisWeek.length}         color={C.green} />
        <KPI icon="ğŸ’°" label="Payout Pending"   value={fmtDollar(totalPayoutPending)}   color={C.blue} />
      </div>

      {/* â”€â”€ FILTER BAR â”€â”€ */}
      <div style={{ background:C.panel, border:`1px solid ${C.border}`, borderRadius:12, padding:"12px 14px", marginBottom:12 }}>
        <div style={{ display:"flex", alignItems:"center", gap:8, flexWrap:"wrap" }}>
          {/* Dropdown filters */}
          <FilterDropdown
            label="Status" icon="ğŸ”–"
            options={STATUS_OPTS}
            selected={statusSel}
            onChange={setStatusSel}
            colorMap={STATUS_COLOR_MAP}
          />
          <FilterDropdown
            label="Franchisee" icon="ğŸ "
            options={FRANCHISEE_OPTS}
            selected={franchiseeSel}
            onChange={setFranchiseeSel}
          />
          <DateRangePicker
            dateFrom={dateRange.from}
            dateTo={dateRange.to}
            onChange={setDateRange}
          />

          {/* Spacer + sort */}
          <div style={{ marginLeft:"auto", display:"flex", alignItems:"center", gap:8 }}>
            {hasAnyFilter && (
              <button onClick={resetFilters}
                style={{ background:"none", border:`1px solid ${C.border}`, borderRadius:8, padding:"7px 12px", fontSize:12, color:C.muted, cursor:"pointer", fontWeight:500 }}>
                âœ• Reset
              </button>
            )}
            <select value={sortBy} onChange={e=>setSortBy(e.target.value)}
              style={{ ...inputStyle, width:"auto", fontSize:12, padding:"6px 10px", cursor:"pointer" }}>
              <option value="submitted_desc">Submitted: newest first</option>
              <option value="submitted_asc">Submitted: oldest first</option>
              <option value="created_desc">Created: newest first</option>
              <option value="created_asc">Created: oldest first</option>
            </select>
          </div>
        </div>

        {/* Active filter chips */}
        {hasAnyFilter && (
          <div style={{ display:"flex", gap:6, flexWrap:"wrap", marginTop:10, paddingTop:10, borderTop:`1px solid ${C.border}` }}>
            {statusSel.map(sid => {
              const opt = STATUS_OPTS.find(o=>o.id===sid);
              return opt ? (
                <span key={sid} style={{ display:"inline-flex", alignItems:"center", gap:5, background:STATUS_COLOR_MAP[sid]+"22", color:STATUS_COLOR_MAP[sid], borderRadius:99, padding:"3px 10px", fontSize:11, fontWeight:600 }}>
                  {opt.label}
                  <button onClick={()=>setStatusSel(s=>s.filter(x=>x!==sid))} style={{ background:"none", border:"none", color:"inherit", cursor:"pointer", padding:0, fontSize:12, lineHeight:1 }}>Ã—</button>
                </span>
              ) : null;
            })}
            {franchiseeSel.map(fid => {
              const f = myFranchisees.find(x=>x.id===fid);
              return f ? (
                <span key={fid} style={{ display:"inline-flex", alignItems:"center", gap:5, background:C.accentDim, color:C.accent, borderRadius:99, padding:"3px 10px", fontSize:11, fontWeight:600 }}>
                  ğŸ  {f.name}
                  <button onClick={()=>setFranchiseeSel(s=>s.filter(x=>x!==fid))} style={{ background:"none", border:"none", color:"inherit", cursor:"pointer", padding:0, fontSize:12, lineHeight:1 }}>Ã—</button>
                </span>
              ) : null;
            })}
            {(dateRange.from || dateRange.to) && (
              <span style={{ display:"inline-flex", alignItems:"center", gap:5, background:C.blueDim, color:C.blue, borderRadius:99, padding:"3px 10px", fontSize:11, fontWeight:600 }}>
                ğŸ“… {dateRange.from||"â€¦"} â€“ {dateRange.to||"â€¦"}
                <button onClick={()=>setDateRange({from:null,to:null})} style={{ background:"none", border:"none", color:"inherit", cursor:"pointer", padding:0, fontSize:12, lineHeight:1 }}>Ã—</button>
              </span>
            )}
          </div>
        )}
      </div>

      {/* Single-franchisee focus banner */}
      {singleFranchisee && (() => {
        const fJobs = allMyJobs.filter(j=>j.fid===singleFranchisee.id);
        return (
          <div style={{ background:C.accentDim, border:`1px solid ${C.accent}44`, borderRadius:12, padding:"10px 16px", marginBottom:10, display:"flex", alignItems:"center", justifyContent:"space-between", flexWrap:"wrap", gap:8 }}>
            <div>
              <span style={{ color:C.accent, fontWeight:700, fontSize:14 }}>{singleFranchisee.name}</span>
              <span style={{ color:C.muted, fontSize:12, marginLeft:8 }}>{singleFranchisee.owner} Â· {singleFranchisee.region}</span>
            </div>
            <div style={{ display:"flex", gap:12 }}>
              {fJobs.filter(j=>j.status==="pending_review").length > 0 && <span style={{ color:C.accent, fontSize:12, fontWeight:600 }}>â³ {fJobs.filter(j=>j.status==="pending_review").length} pending</span>}
              {fJobs.filter(j=>j.status==="flagged").length > 0        && <span style={{ color:C.red,    fontSize:12, fontWeight:600 }}>ğŸš© {fJobs.filter(j=>j.status==="flagged").length} flagged</span>}
              {fJobs.filter(j=>["approved","closed"].includes(j.status)).length > 0 && <span style={{ color:C.green, fontSize:12, fontWeight:600 }}>âœ… {fJobs.filter(j=>["approved","closed"].includes(j.status)).length} approved</span>}
            </div>
          </div>
        );
      })()}

      <div style={{ color:C.muted, fontSize:12, marginBottom:10 }}>
        Showing {sorted.length} of {allMyJobs.length} job{allMyJobs.length!==1?"s":""}
        {hasAnyFilter && <span style={{ color:C.accent }}> Â· {filtered.length} match filters</span>}
      </div>

      {sorted.length === 0
        ? <div style={{ background:C.card, border:`1px solid ${C.border}`, borderRadius:14, padding:"32px", textAlign:"center", color:C.muted }}>
            {!hasAnyFilter ? "ğŸ‰ Queue is clear â€” all caught up!" : "No jobs match these filters."}
          </div>
        : (
          <div style={{ display:"flex", flexDirection:"column", gap:10 }}>
            {sorted.map(job=>{
              const f = myFranchisees.find(x=>x.id===job.fid);
              const { gp, margin, totalCost } = calcJobMargin(job);
              const mc = margin < 25 ? C.red : margin < 35 ? C.orange : C.green;
              const liveFlags = evaluateFlags(job);
              const jobDocs = job.documents || [];
              const unassignedJobDocs = jobDocs.filter(d=>!d.assignedTo||d.assignedTo.length===0);
              const isApproved = ["approved","closed"].includes(job.status);
              const expanded = expandedJobs.has(job.id);
              const borderColor = job.status==="flagged" ? C.red+"55" : isApproved ? C.green+"33" : C.border;
              const accentLeft  = job.status==="flagged" ? C.red : isApproved ? C.green : job.status==="pending_review" ? C.accent : C.muted;

              // Days in queue â€” from submission to today
              const daysInQueue = job.submittedAt ? daysBetween(job.submittedAt) : null;
              const queueColor = daysInQueue === null ? C.muted : daysInQueue > 7 ? C.red : daysInQueue > 3 ? C.orange : C.green;

              return (
                <div key={job.id} style={{ background:C.card, border:`1px solid ${C.border}`, borderLeft:`3px solid ${accentLeft}`, borderRadius:14, padding:18 }}>
                  {/* Top row */}
                  <div style={{ display:"flex", alignItems:"flex-start", justifyContent:"space-between", flexWrap:"wrap", gap:10 }}>
                    <div style={{ flex:1 }}>
                      <div style={{ fontWeight:700, fontSize:15, color:C.text }}>{job.address}</div>
                      <div style={{ color:C.muted, fontSize:12, marginTop:2 }}>
                        <strong style={{ color:C.accent }}>{f?.name}</strong> Â· {job.customer} Â· <span>{fmtDollarFull(job.contractPrice)}</span>
                      </div>
                      {/* Date timeline */}
                      <div style={{ display:"flex", gap:14, marginTop:6, flexWrap:"wrap", alignItems:"center" }}>
                        <DaysAgo date={job.createdAt} label="Created" />
                        {job.submittedAt && <DaysAgo date={job.submittedAt} label="Submitted" />}
                        {job.approvedAt  && <DaysAgo date={job.approvedAt}  label="Approved" />}
                        {!job.submittedAt && (
                          <span style={{ color:C.muted, fontSize:11 }}>Not yet submitted</span>
                        )}
                        {/* Queue age badge */}
                        {daysInQueue !== null && !isApproved && (
                          <span style={{ background:queueColor+"22", color:queueColor, fontSize:10, fontWeight:600, borderRadius:99, padding:"2px 8px" }}>
                            {daysInQueue === 0 ? "Submitted today" : `${daysInQueue}d in queue`}
                          </span>
                        )}
                      </div>
                    </div>
                    <div style={{ display:"flex", alignItems:"center", gap:8, flexWrap:"wrap" }}>
                      {liveFlags.map((fl,i)=><FlagBadge key={i} flag={fl} />)}
                      <StatusBadge status={job.status} />
                    </div>
                  </div>

                  {/* Quick stats */}
                  {!expanded && (
                    <div style={{ display:"flex", gap:14, padding:"8px 12px", background:C.panel, borderRadius:9, marginTop:10, flexWrap:"wrap", alignItems:"center" }}>
                      <div><div style={{ color:C.muted, fontSize:11, fontWeight:500 }}>Contract</div><div style={{ color:C.text, fontFamily:"'Cabinet Grotesk',sans-serif", fontWeight:700, fontSize:15 }}>{fmtDollarFull(job.contractPrice)}</div></div>
                      <div><div style={{ color:C.muted, fontSize:11, fontWeight:500 }}>Gross Profit</div><div style={{ color:gp>=0?C.green:C.red, fontFamily:"'Cabinet Grotesk',sans-serif", fontWeight:700, fontSize:15 }}>{fmtDollarFull(gp)}</div></div>
                      <div><div style={{ color:C.muted, fontSize:11, fontWeight:500 }}>Margin</div><div style={{ color:mc, fontFamily:"'Cabinet Grotesk',sans-serif", fontWeight:700, fontSize:15 }}>{fmtPct(margin)}</div></div>
                      <div style={{ marginLeft:"auto" }}>
                        <div style={{ color:C.muted, fontSize:11, fontWeight:500 }}>Receipts</div>
                        <div style={{ display:"flex", alignItems:"center", gap:5 }}>
                          <span style={{ color:C.blue, fontWeight:600, fontSize:14 }}>ğŸ“ {jobDocs.length}</span>
                          {unassignedJobDocs.length > 0
                            ? <span style={{ background:C.redDim, color:C.red, fontSize:10, fontWeight:600, borderRadius:99, padding:"2px 8px" }}>âš  {unassignedJobDocs.length} unassigned</span>
                            : jobDocs.length > 0 && <span style={{ background:C.greenDim, color:C.green, fontSize:10, fontWeight:600, borderRadius:99, padding:"2px 8px" }}>âœ“ all assigned</span>
                          }
                        </div>
                      </div>
                    </div>
                  )}

                  {/* Expanded details */}
                  {expanded && <JobDetailPanel job={job} />}

                  {job.bmNote && !expanded && (
                    <div style={{ background:C.orangeDim, border:`1px solid ${C.orange}44`, borderRadius:8, padding:"8px 12px", marginTop:10, color:C.orange, fontSize:12 }}>
                      ğŸ“ {job.bmNote}
                    </div>
                  )}

                  {/* Actions */}
                  <div style={{ display:"flex", gap:8, flexWrap:"wrap", marginTop:12, alignItems:"center" }}>
                    {["pending_review","flagged"].includes(job.status) && (
                      <button onClick={()=>onReview(job)} style={{ ...btnPrimary, fontSize:13 }}>
                        Review & Close â†’
                      </button>
                    )}
                    <button onClick={()=>toggleExpand(job.id)}
                      style={{ background:"none", border:`1px solid ${C.border}`, borderRadius:9, padding:"7px 13px", fontSize:12, color:C.muted, cursor:"pointer", marginLeft:["pending_review","flagged"].includes(job.status)?"0":"auto" }}>
                      {expanded ? "â–² Hide details" : "â–¼ View details"}
                    </button>
                  </div>
                </div>
              );
            })}
          </div>
        )
      }
    </div>
  );
}

// â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
// FRANCHISEE PORTAL
// â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
function FranchiseePortal({ franchisee, jobs, onUpdateJob, onCreateJob, onUpdateFranchisee }) {
  const [tab, setTab]     = useState("jobs");
  const [costingJob, setCostingJob] = useState(null);
  const [showNewJob, setShowNewJob] = useState(false);
  const [newJob, setNewJob]         = useState({ address:"", customer:"", contractPrice:"" });

  const myJobs = jobs.filter(j=>j.fid===franchisee.id);
  const openJobs    = myJobs.filter(j=>j.status==="open");
  const pendingJobs = myJobs.filter(j=>j.status==="pending_review");
  const flaggedJobs = myJobs.filter(j=>j.status==="flagged");
  const approvedJobs= myJobs.filter(j=>["approved","closed"].includes(j.status));

  const ytdRevenue   = approvedJobs.reduce((a,j)=>a+j.contractPrice,0);
  const ytdGP        = approvedJobs.reduce((a,j)=>a+calcJobMargin(j).gp,0);
  const ytdMargin    = ytdRevenue > 0 ? (ytdGP/ytdRevenue)*100 : 0;
  const avgTicket    = myJobs.length > 0 ? myJobs.reduce((a,j)=>a+j.contractPrice,0)/myJobs.length : 0;

  function submitJob(jobId) {
    onUpdateJob(jobId, j => {
      const flags = evaluateFlags(j);
      return { ...j, status: flags.length > 0 ? "flagged" : "pending_review", submittedAt: new Date().toISOString().slice(0,10), flags };
    });
  }

  function createJob() {
    if (!newJob.address || !newJob.contractPrice) return;
    onCreateJob({ fid:franchisee.id, address:newJob.address, customer:newJob.customer, contractPrice:Number(newJob.contractPrice), status:"open", createdAt:new Date().toISOString().slice(0,10), estimated:{ materials:0, labor:0, dump:0, franchiseFee:0, warranty:0, other:0 }, actuals:{ materials:[], labor:[], dump:[], franchiseFee:[], warranty:[], other:[] }, documents:[], flags:[] });
    setNewJob({ address:"", customer:"", contractPrice:"" });
    setShowNewJob(false);
  }

  const navTabs = [
    { id:"jobs",       icon:"ğŸ”¨", label:"Jobs" },
    { id:"financials", icon:"ğŸ“Š", label:"Financials" },
  ];

  return (
    <div style={{ paddingBottom:80 }}>
      {costingJob && (
        <JobCostModal
          job={costingJob}
          franchiseeName={franchisee.owner}
          onSave={({estimated,actuals,documents}) => onUpdateJob(costingJob.id, j=>({...j, estimated, actuals, documents:documents||j.documents||[]}))}
          onSubmit={() => submitJob(costingJob.id)}
          onClose={()=>setCostingJob(null)}
        />
      )}

      {/* â”€â”€ JOBS TAB â”€â”€ */}
      {tab === "jobs" && (
        <FranchiseeJobsTab
          franchisee={franchisee}
          myJobs={myJobs}
          onCostJob={setCostingJob}
          onSubmitJob={submitJob}
          onCreateJob={()=>setShowNewJob(true)}
          showNewJob={showNewJob}
          newJob={newJob}
          setNewJob={setNewJob}
          onCreateJobSubmit={createJob}
          onCancelNewJob={()=>setShowNewJob(false)}
        />
      )}

      {/* â”€â”€ FINANCIALS TAB â”€â”€ */}
      {tab === "financials" && (
        <FinancialsTab
          franchisee={franchisee}
          allJobs={myJobs}
          approvedJobs={approvedJobs}
          ytdRevenue={ytdRevenue}
          ytdGP={ytdGP}
          ytdMargin={ytdMargin}
          avgTicket={avgTicket}
          onUpdateFranchisee={(updater) => onUpdateFranchisee(franchisee.id, updater)}
        />
      )}

      {/* Bottom tabs */}
      <div style={{ position:"fixed", bottom:0, left:0, right:0, background:C.card, borderTop:`1px solid ${C.border}`, display:"flex", zIndex:100, height:68 }}>
        {navTabs.map(n=>(
          <button key={n.id} onClick={()=>setTab(n.id)} style={{ flex:1, background:"none", border:"none", cursor:"pointer", display:"flex", flexDirection:"column", alignItems:"center", justifyContent:"center", gap:3, position:"relative" }}>
            <div style={{ fontSize:20, filter:tab===n.id?"none":"grayscale(1) opacity(0.4)" }}>{n.icon}</div>
            <span style={{ fontSize:11, fontFamily:"'Inter',sans-serif", color:tab===n.id?C.accent:C.muted, fontWeight:tab===n.id?600:400 }}>{n.label}</span>
            {tab===n.id&&<div style={{ position:"absolute", bottom:4, width:20, height:3, background:C.accent, borderRadius:99 }}/>}
          </button>
        ))}
      </div>
    </div>
  );
}

// â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
// HEALTH SCORE ENGINE
// Scores each franchisee 0â€“100 across 6 vital metrics.
// Each metric is weighted and color-coded.
// â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
const SCORE_WEIGHTS = {
  margin:      { label:"Gross Margin",     weight:25, icon:"ğŸ“ˆ", target:40,  unit:"%" },
  revenueGoal: { label:"Revenue vs Goal",  weight:20, icon:"ğŸ¯", target:100, unit:"%" },
  flagRate:    { label:"Flag Rate",        weight:20, icon:"ğŸš©", target:0,   unit:"%", inverted:true },
  avgTicket:   { label:"Avg Ticket",       weight:15, icon:"ğŸ’°", target:12000, unit:"$" },
  closeRate:   { label:"Close Rate",       weight:10, icon:"ğŸ¤", target:65,  unit:"%" },
  velocity:    { label:"Jobs / Month",     weight:10, icon:"âš¡", target:8,   unit:"" },
};

function calcHealthScore(franchisee, jobs, dateFrom, dateTo) {
  const filtered = jobs.filter(j => {
    if (j.fid !== franchisee.id) return false;
    const d = j.approvedAt || j.submittedAt || j.createdAt;
    if (dateFrom && d && d < dateFrom) return false;
    if (dateTo   && d && d > dateTo)   return false;
    return true;
  });

  const approved = filtered.filter(j => ["approved","closed"].includes(j.status));
  const flagged  = filtered.filter(j => j.status === "flagged");
  const allDone  = filtered.filter(j => j.status !== "open");

  const revenue  = approved.reduce((a,j) => a + j.contractPrice, 0);
  const gp       = approved.reduce((a,j) => a + calcJobMargin(j).gp, 0);
  const margin   = revenue > 0 ? (gp / revenue) * 100 : 0;
  const goalPct  = franchisee.revenueGoal > 0 ? (revenue / franchisee.revenueGoal) * 100 : 0;
  const flagRate = allDone.length > 0 ? (flagged.length / allDone.length) * 100 : 0;
  const avgTicket = approved.length > 0 ? revenue / approved.length : 0;
  const closeRate = franchisee.closeRate || 0;

  // Velocity: jobs approved per month over the filtered window
  let months = 1;
  if (dateFrom && dateTo) {
    const a = new Date(dateFrom), b = new Date(dateTo);
    months = Math.max(1, (b - a) / (1000*60*60*24*30));
  }
  const velocity = approved.length / months;

  // Score each metric 0â€“100
  function score(val, target, inverted) {
    if (inverted) return Math.max(0, Math.min(100, 100 - (val / Math.max(target || 10, 1)) * 100));
    return Math.max(0, Math.min(100, (val / Math.max(target, 1)) * 100));
  }

  const metrics = {
    margin:      { raw: margin,    scored: score(margin, 40),         display: margin.toFixed(1) + "%" },
    revenueGoal: { raw: goalPct,   scored: score(goalPct, 100),       display: goalPct.toFixed(0) + "%" },
    flagRate:    { raw: flagRate,  scored: score(flagRate, 10, true),  display: flagRate.toFixed(0) + "%" },
    avgTicket:   { raw: avgTicket, scored: score(avgTicket, 12000),    display: fmtDollar(avgTicket) },
    closeRate:   { raw: closeRate, scored: score(closeRate, 65),       display: closeRate + "%" },
    velocity:    { raw: velocity,  scored: score(velocity, 8),         display: velocity.toFixed(1) },
  };

  const composite = Object.entries(metrics).reduce((sum, [key, m]) => {
    return sum + (m.scored * SCORE_WEIGHTS[key].weight / 100);
  }, 0);

  return { composite: Math.round(composite), metrics, revenue, gp, margin, approved, flagged, allJobs: filtered };
}

function scoreColor(s) {
  return s >= 80 ? C.green : s >= 60 ? C.accent : s >= 40 ? C.orange : C.red;
}

function ScoreGauge({ score, size = 72 }) {
  const color = scoreColor(score);
  const r = (size / 2) - 6;
  const circ = 2 * Math.PI * r;
  const pct  = score / 100;
  return (
    <div style={{ position:"relative", width:size, height:size, flexShrink:0 }}>
      <svg width={size} height={size} style={{ transform:"rotate(-90deg)" }}>
        <circle cx={size/2} cy={size/2} r={r} fill="none" stroke={C.border} strokeWidth={6}/>
        <circle cx={size/2} cy={size/2} r={r} fill="none" stroke={color} strokeWidth={6}
          strokeDasharray={`${circ * pct} ${circ * (1-pct)}`}
          strokeLinecap="round" style={{ transition:"stroke-dasharray 0.5s ease" }} />
      </svg>
      <div style={{ position:"absolute", inset:0, display:"flex", flexDirection:"column", alignItems:"center", justifyContent:"center" }}>
        <span style={{ color, fontFamily:"'Cabinet Grotesk',sans-serif", fontWeight:900, fontSize:size > 60 ? 18 : 13, lineHeight:1 }}>{score}</span>
      </div>
    </div>
  );
}

function MetricBar({ label, icon, scored, display, weight, inverted }) {
  const color = inverted
    ? scored >= 70 ? C.green : scored >= 40 ? C.orange : C.red
    : scored >= 80 ? C.green : scored >= 55 ? C.accent : scored >= 35 ? C.orange : C.red;
  return (
    <div style={{ marginBottom:8 }}>
      <div style={{ display:"flex", justifyContent:"space-between", alignItems:"center", marginBottom:3 }}>
        <span style={{ color:C.muted, fontSize:11, fontWeight:500 }}>{icon} {label}</span>
        <span style={{ color, fontSize:11, fontFamily:"'DM Mono',monospace", fontWeight:700 }}>{display}</span>
      </div>
      <div style={{ height:4, background:C.border, borderRadius:99 }}>
        <div style={{ width:`${scored}%`, height:"100%", background:color, borderRadius:99, transition:"width 0.4s ease" }} />
      </div>
    </div>
  );
}

// â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
// REPORTS TAB â€” used by both BM and Admin
// scope = array of franchisees visible to this user
// â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
function ReportsTab({ franchisees, jobs, bms, allFranchisees, userRole, onImpersonate }) {
  const [dateRange, setDateRange]       = useState({ from:null, to:null });
  const [selectedIds, setSelectedIds]   = useState([]); // [] = all in scope
  const [sortBy, setSortBy]             = useState("score_desc");
  const [drillId, setDrillId]           = useState(null);

  const scopedFranchisees = franchisees; // already filtered to role scope by parent

  // Compute scores for all in scope
  const scored = scopedFranchisees.map(f => ({
    franchisee: f,
    bm: bms?.find(b => b.id === f.bm),
    ...calcHealthScore(f, jobs, dateRange.from, dateRange.to),
  }));

  // Apply selection filter
  const visible = (selectedIds.length === 0 ? scored : scored.filter(s => selectedIds.includes(s.franchisee.id)));

  // Sort
  const sorted = [...visible].sort((a, b) => {
    if (sortBy === "score_desc")  return b.composite - a.composite;
    if (sortBy === "score_asc")   return a.composite - b.composite;
    if (sortBy === "revenue_desc") return b.revenue - a.revenue;
    if (sortBy === "margin_desc")  return b.margin - a.margin;
    if (sortBy === "name_asc")     return a.franchisee.name.localeCompare(b.franchisee.name);
    return 0;
  });

  const drillData = drillId ? scored.find(s => s.franchisee.id === drillId) : null;

  // Portfolio rollup
  const totalRevenue = visible.reduce((a, s) => a + s.revenue, 0);
  const totalGP      = visible.reduce((a, s) => a + s.gp, 0);
  const avgScore     = visible.length > 0 ? Math.round(visible.reduce((a, s) => a + s.composite, 0) / visible.length) : 0;
  const atRisk       = visible.filter(s => s.composite < 50).length;

  // Franchisee multi-select options
  const FRAN_OPTS = scopedFranchisees.map(f => ({ id:f.id, label:f.name, count: null }));

  // Drill-in view
  if (drillData) {
    const { franchisee, composite, metrics, revenue, gp, margin, approved, flagged, allJobs } = drillData;
    const bm = bms?.find(b => b.id === franchisee.bm);
    return (
      <div style={{ animation:"fadeIn 0.2s ease" }}>
        <div style={{ display:"flex", alignItems:"center", gap:12, marginBottom:20 }}>
          <button onClick={() => setDrillId(null)}
            style={{ background:"none", border:`1px solid ${C.border}`, borderRadius:8, padding:"6px 12px", color:C.muted, cursor:"pointer", fontSize:13 }}>
            â† Back
          </button>
          <div>
            <h1 style={{ fontFamily:"'Cabinet Grotesk',sans-serif", fontSize:22, fontWeight:900, margin:0 }}>{franchisee.name}</h1>
            <p style={{ color:C.muted, fontSize:12, margin:0 }}>{franchisee.owner} Â· {franchisee.region}{bm ? ` Â· BM: ${bm.name}` : ""}</p>
          </div>
          {onImpersonate && (
            <div style={{ marginLeft:"auto", display:"flex", gap:8 }}>
              <button onClick={() => onImpersonate("franchisee", franchisee.id)}
                style={{ background:C.accentDim, color:C.accent, border:`1px solid ${C.accent}44`, borderRadius:8, padding:"7px 14px", fontSize:12, fontWeight:700, cursor:"pointer" }}>
                ğŸ  View as Franchisee
              </button>
              {bm && (
                <button onClick={() => onImpersonate("bm", bm.id)}
                  style={{ background:C.blueDim, color:C.blue, border:`1px solid ${C.blue}44`, borderRadius:8, padding:"7px 14px", fontSize:12, fontWeight:700, cursor:"pointer" }}>
                  ğŸ‘” View as BM
                </button>
              )}
            </div>
          )}
        </div>

        {/* Score hero */}
        <div style={{ background:C.card, border:`1px solid ${C.border}`, borderRadius:16, padding:24, marginBottom:16, display:"flex", gap:24, alignItems:"center", flexWrap:"wrap" }}>
          <ScoreGauge score={composite} size={100} />
          <div>
            <div style={{ color:C.muted, fontSize:11, fontWeight:600, marginBottom:4 }}>HEALTH SCORE</div>
            <div style={{ fontFamily:"'Cabinet Grotesk',sans-serif", fontSize:32, fontWeight:900, color:scoreColor(composite), lineHeight:1 }}>{composite}<span style={{ fontSize:16, color:C.muted }}>/100</span></div>
            <div style={{ color:C.muted, fontSize:12, marginTop:6 }}>
              {composite >= 80 ? "ğŸŒŸ Excellent â€” top performer" : composite >= 65 ? "âœ… Good â€” on track" : composite >= 50 ? "âš ï¸ Fair â€” needs attention" : "ğŸ”´ At risk â€” requires action"}
            </div>
          </div>
          <div style={{ marginLeft:"auto", display:"grid", gridTemplateColumns:"1fr 1fr 1fr", gap:16 }}>
            {[
              { l:"YTD Revenue",  v:fmtDollar(revenue),             c:C.accent },
              { l:"YTD GP",       v:fmtDollar(gp),                  c:C.green  },
              { l:"Avg Margin",   v:margin.toFixed(1)+"%",           c:margin<30?C.red:C.green },
              { l:"Jobs Closed",  v:approved.length,                 c:C.blue   },
              { l:"Flagged",      v:flagged.length,                  c:flagged.length>0?C.red:C.muted },
              { l:"Revenue Goal", v:fmtDollar(franchisee.revenueGoal), c:C.muted },
            ].map(s=>(
              <div key={s.l}>
                <div style={{ color:C.muted, fontSize:10, fontWeight:500 }}>{s.l}</div>
                <div style={{ color:s.c, fontFamily:"'Cabinet Grotesk',sans-serif", fontWeight:700, fontSize:16 }}>{s.v}</div>
              </div>
            ))}
          </div>
        </div>

        {/* Metric breakdown */}
        <div style={{ background:C.card, border:`1px solid ${C.border}`, borderRadius:14, padding:20, marginBottom:16 }}>
          <div style={{ color:C.muted, fontSize:11, fontWeight:600, marginBottom:14 }}>METRIC BREAKDOWN</div>
          <div style={{ display:"grid", gridTemplateColumns:"1fr 1fr", gap:16 }}>
            {Object.entries(metrics).map(([key, m]) => {
              const cfg = SCORE_WEIGHTS[key];
              return (
                <MetricBar key={key} label={cfg.label} icon={cfg.icon} scored={m.scored} display={m.display} weight={cfg.weight} inverted={cfg.inverted} />
              );
            })}
          </div>
        </div>

        {/* Recent jobs */}
        <div style={{ background:C.card, border:`1px solid ${C.border}`, borderRadius:14, padding:20 }}>
          <div style={{ color:C.muted, fontSize:11, fontWeight:600, marginBottom:12 }}>
            JOB HISTORY ({allJobs.length} in period)
          </div>
          {allJobs.length === 0
            ? <div style={{ color:C.muted, fontSize:12 }}>No jobs in selected period.</div>
            : [...allJobs].sort((a,b)=>(b.approvedAt||b.createdAt||"").localeCompare(a.approvedAt||a.createdAt||"")).map(job => {
                const { margin: jm, gp: jg } = calcJobMargin(job);
                const mc = jm < 25 ? C.red : jm < 35 ? C.orange : C.green;
                const statusChip = {
                  open:"Open", pending_review:"Pending", flagged:"Flagged", approved:"Approved", closed:"Closed"
                }[job.status] || job.status;
                const chipColor = { open:C.muted, pending_review:C.accent, flagged:C.red, approved:C.green, closed:C.green }[job.status] || C.muted;
                return (
                  <div key={job.id} style={{ display:"grid", gridTemplateColumns:"1fr 100px 90px 90px 90px", gap:8, padding:"8px 0", borderBottom:`1px solid ${C.border}`, alignItems:"center" }}>
                    <div>
                      <div style={{ color:C.text, fontSize:12, fontWeight:500 }}>{job.address}</div>
                      <div style={{ color:C.muted, fontSize:11 }}>{job.customer} Â· {job.approvedAt || job.submittedAt || job.createdAt}</div>
                    </div>
                    <div style={{ textAlign:"right", color:C.accent, fontFamily:"'DM Mono',monospace", fontSize:12 }}>{fmtDollarFull(job.contractPrice)}</div>
                    <div style={{ textAlign:"right", color:mc, fontFamily:"'DM Mono',monospace", fontSize:12 }}>{jm.toFixed(1)}%</div>
                    <div style={{ textAlign:"right", color:C.green, fontFamily:"'DM Mono',monospace", fontSize:12 }}>{fmtDollar(jg)}</div>
                    <div style={{ textAlign:"right" }}>
                      <span style={{ background:chipColor+"22", color:chipColor, borderRadius:99, padding:"2px 8px", fontSize:10, fontWeight:600 }}>{statusChip}</span>
                    </div>
                  </div>
                );
              })
          }
        </div>
      </div>
    );
  }

  // â”€â”€ MAIN REPORTS VIEW â”€â”€
  return (
    <div style={{ animation:"fadeIn 0.2s ease" }}>
      <div style={{ marginBottom:16 }}>
        <h1 style={{ fontFamily:"'Cabinet Grotesk',sans-serif", fontSize:24, fontWeight:900, margin:0 }}>
          {userRole === "admin" ? "ğŸ“Š Portfolio Reports" : "ğŸ“Š My Franchisee Reports"}
        </h1>
        <p style={{ color:C.muted, fontSize:13, margin:"4px 0 0" }}>
          Health scores and performance metrics across {scopedFranchisees.length} franchisee{scopedFranchisees.length !== 1 ? "s" : ""}.
        </p>
      </div>

      {/* Filter bar */}
      <div style={{ background:C.panel, border:`1px solid ${C.border}`, borderRadius:12, padding:"12px 14px", marginBottom:16, display:"flex", gap:10, flexWrap:"wrap", alignItems:"center" }}>
        <FilterDropdown label="Franchisees" icon="ğŸ " options={FRAN_OPTS} selected={selectedIds} onChange={setSelectedIds} />
        <DateRangePicker dateFrom={dateRange.from} dateTo={dateRange.to} onChange={setDateRange} />
        <div style={{ marginLeft:"auto", display:"flex", alignItems:"center", gap:8 }}>
          <select value={sortBy} onChange={e=>setSortBy(e.target.value)}
            style={{ ...inputStyle, width:"auto", fontSize:12, padding:"6px 10px", cursor:"pointer" }}>
            <option value="score_desc">Score: High â†’ Low</option>
            <option value="score_asc">Score: Low â†’ High (At Risk first)</option>
            <option value="revenue_desc">Revenue: High â†’ Low</option>
            <option value="margin_desc">Margin: High â†’ Low</option>
            <option value="name_asc">Name Aâ€“Z</option>
          </select>
        </div>
      </div>

      {/* Portfolio summary KPIs */}
      <div style={{ display:"grid", gridTemplateColumns:"repeat(auto-fit,minmax(130px,1fr))", gap:10, marginBottom:16 }}>
        <KPI icon="â­" label="Avg Health Score" value={avgScore + "/100"} color={scoreColor(avgScore)} />
        <KPI icon="ğŸ’°" label="Portfolio Revenue" value={fmtDollar(totalRevenue)} color={C.accent} />
        <KPI icon="ğŸ“ˆ" label="Portfolio GP"      value={fmtDollar(totalGP)}     color={C.green} />
        <KPI icon="ğŸ”´" label="At Risk (<50)"     value={atRisk}                  color={atRisk > 0 ? C.red : C.muted} />
      </div>

      {/* Score table */}
      {/* Column header */}
      <div style={{ display:"grid", gridTemplateColumns:"40px 1fr 80px 100px 90px 90px 80px 90px", gap:8, padding:"8px 14px", marginBottom:4 }}>
        {["","Franchisee","Score","Revenue","Margin","GP","Jobs",""].map((h,i) => (
          <div key={i} style={{ color:C.muted, fontSize:10, fontWeight:600, textAlign: i===0||i===7?"center":"left" }}>{h}</div>
        ))}
      </div>

      {sorted.map(s => {
        const { franchisee, composite, revenue, gp, margin, approved, allJobs: aJobs } = s;
        const color = scoreColor(composite);
        const bm    = bms?.find(b => b.id === franchisee.bm);
        return (
          <div key={franchisee.id}
            onClick={() => setDrillId(franchisee.id)}
            style={{ display:"grid", gridTemplateColumns:"40px 1fr 80px 100px 90px 90px 80px 90px", gap:8, padding:"12px 14px", background:C.card, border:`1px solid ${composite < 50 ? C.red+"44" : C.border}`, borderLeft:`3px solid ${color}`, borderRadius:12, marginBottom:8, cursor:"pointer", alignItems:"center", transition:"border-color 0.15s" }}>
            <ScoreGauge score={composite} size={36} />
            <div>
              <div style={{ color:C.text, fontSize:13, fontWeight:700 }}>{franchisee.name}</div>
              <div style={{ color:C.muted, fontSize:11, marginTop:1 }}>{franchisee.owner}{bm ? ` Â· ${bm.name}` : ""}</div>
            </div>
            <div>
              <div style={{ color, fontFamily:"'Cabinet Grotesk',sans-serif", fontWeight:900, fontSize:18 }}>{composite}</div>
              <div style={{ color:C.muted, fontSize:10 }}>/100</div>
            </div>
            <div style={{ color:C.accent, fontFamily:"'DM Mono',monospace", fontSize:12, fontWeight:600 }}>{fmtDollar(revenue)}</div>
            <div style={{ color:margin<30?C.red:C.green, fontFamily:"'DM Mono',monospace", fontSize:12 }}>{margin.toFixed(1)}%</div>
            <div style={{ color:C.green, fontFamily:"'DM Mono',monospace", fontSize:12 }}>{fmtDollar(gp)}</div>
            <div style={{ color:C.blue, fontFamily:"'DM Mono',monospace", fontSize:12 }}>{approved.length}</div>
            <button
              onClick={e=>{ e.stopPropagation(); setDrillId(franchisee.id); }}
              style={{ background:C.panel, border:`1px solid ${C.border}`, borderRadius:7, padding:"5px 10px", fontSize:11, color:C.muted, cursor:"pointer" }}>
              Details â†’
            </button>
          </div>
        );
      })}

      {sorted.length === 0 && (
        <div style={{ background:C.card, border:`1px solid ${C.border}`, borderRadius:14, padding:"32px", textAlign:"center", color:C.muted }}>
          No franchisees match the current filters.
        </div>
      )}
    </div>
  );
}


function BMPortal({ bm, franchisees, jobs, onUpdateJob }) {
  const [tab, setTab]         = useState("queue");
  const [reviewJob, setReviewJob] = useState(null);
  const [reviewFranchisee, setReviewFranchisee] = useState(null);
  const [selectedFranchisee, setSelectedFranchisee] = useState(null);

  const myFranchisees = franchisees.filter(f=>bm.franchiseeIds.includes(f.id));
  const allMyJobs     = jobs.filter(j=>myFranchisees.some(f=>f.id===j.fid));

  const pendingJobs = allMyJobs.filter(j=>j.status==="pending_review");
  const flaggedJobs = allMyJobs.filter(j=>j.status==="flagged");
  const approvedThisWeek = allMyJobs.filter(j=>j.status==="approved");
  const payoutQueue = allMyJobs.filter(j=>j.payouts && j.status==="approved");

  const totalPayoutPending = payoutQueue.reduce((a,j)=>{
    const matAmt = (j.payouts.materials||[]).filter(p=>p.status==="pending").reduce((x,p)=>x+p.amount,0);
    const subAmt = (j.payouts.subs||[]).filter(p=>p.status==="pending").reduce((x,p)=>x+p.amount,0);
    const frAmt  = j.payouts.franchisee?.status==="pending" ? j.payouts.franchisee.net : 0;
    return a + matAmt + subAmt + frAmt;
  }, 0);

  function openReview(job) {
    const f = myFranchisees.find(f=>f.id===job.fid);
    setReviewJob(job);
    setReviewFranchisee(f);
  }

  function handleApprove(job, payoutsData, note) {
    const matTotal = actualCatTotal(job.actuals, "materials");
    const { gp, totalCost } = calcJobMargin(job);
    const payouts = {
      materials: matTotal > 0 ? [{ payee:"Materials Supplier", amount:matTotal, status:"pending" }] : [],
      subs: [],
      franchisee: { gross:job.contractPrice, costs:totalCost, net:Math.max(0,gp), status:"pending" },
    };
    onUpdateJob(job.id, j=>({ ...j, status:"approved", approvedAt:new Date().toISOString().slice(0,10), bmNote:note||"", payouts, flags:[] }));
  }

  function handleFlag(job, note) {
    onUpdateJob(job.id, j=>({ ...j, status:"flagged", bmNote:note||"", flags:evaluateFlags(j) }));
  }

  function markPaid(jobId, type, idx) {
    onUpdateJob(jobId, j=>{
      const p = JSON.parse(JSON.stringify(j.payouts));
      if (type==="materials") p.materials[idx].status="paid";
      else if (type==="sub")  p.subs[idx].status="paid";
      else if (type==="franchisee") p.franchisee.status="paid";
      const allPaid = p.materials.every(x=>x.status==="paid") && p.subs.every(x=>x.status==="paid") && p.franchisee?.status==="paid";
      return { ...j, payouts:p, status:allPaid?"closed":"approved" };
    });
  }

  const navTabs = [
    { id:"queue",      icon:"â³", label:"Queue",   badge: pendingJobs.length + flaggedJobs.length },
    { id:"payouts",    icon:"ğŸ’°", label:"Payouts",  badge: payoutQueue.length },
    { id:"franchisees",icon:"ğŸ ", label:"Accounts" },
    { id:"reports",    icon:"ğŸ“Š", label:"Reports"  },
  ];

  return (
    <div style={{ paddingBottom:80 }}>
      {reviewJob && reviewFranchisee && (
        <ReviewModal
          job={reviewJob} franchisee={reviewFranchisee} bmName={bm.name}
          onApprove={(payouts,note)=>handleApprove(reviewJob,payouts,note)}
          onFlag={(note)=>handleFlag(reviewJob,note)}
          onClose={()=>{ setReviewJob(null); setReviewFranchisee(null); }}
          onDocsChange={(newDocs)=>onUpdateJob(reviewJob.id, j=>({...j, documents:newDocs}))}
        />
      )}

      {/* â”€â”€ QUEUE TAB â”€â”€ */}
      {tab === "queue" && (
        <BMQueueTab
          allMyJobs={allMyJobs}
          myFranchisees={myFranchisees}
          pendingJobs={pendingJobs}
          flaggedJobs={flaggedJobs}
          approvedThisWeek={approvedThisWeek}
          totalPayoutPending={totalPayoutPending}
          onReview={openReview}
        />
      )}

      {/* â”€â”€ PAYOUTS TAB â”€â”€ */}
      {tab === "payouts" && (
        <div>
          <div style={{ marginBottom:18 }}>
            <h1 style={{ fontFamily:"'Cabinet Grotesk',sans-serif", fontSize:24, fontWeight:900, margin:0 }}>Payout Queue</h1>
            <p style={{ color:C.muted, fontSize:13, margin:"4px 0 0" }}>Track what needs to be paid and mark items complete.</p>
          </div>

          <div style={{ display:"grid", gridTemplateColumns:"repeat(auto-fit,minmax(150px,1fr))", gap:10, marginBottom:20 }}>
            <KPI icon="ğŸ’°" label="Total Pending"   value={fmtDollar(totalPayoutPending)} color={C.accent} />
            <KPI icon="ğŸ”§" label="Jobs in Queue"    value={payoutQueue.length}            color={C.blue} />
          </div>

          {payoutQueue.length === 0
            ? <div style={{ background:C.card, border:`1px solid ${C.border}`, borderRadius:14, padding:"32px", textAlign:"center", color:C.muted }}>No pending payouts.</div>
            : payoutQueue.map(job=>{
                const f = myFranchisees.find(x=>x.id===job.fid);
                const p = job.payouts;
                const totalP = [...(p.materials||[]),...(p.subs||[])].reduce((a,x)=>a+x.amount,0) + (p.franchisee?.net||0);
                const totalPaid = (p.materials||[]).filter(x=>x.status==="paid").reduce((a,x)=>a+x.amount,0)
                  + (p.subs||[]).filter(x=>x.status==="paid").reduce((a,x)=>a+x.amount,0)
                  + (p.franchisee?.status==="paid"?p.franchisee.net:0);
                return (
                  <div key={job.id} style={{ background:C.card, border:`1px solid ${C.border}`, borderRadius:14, padding:18, marginBottom:12 }}>
                    <div style={{ display:"flex", justifyContent:"space-between", alignItems:"flex-start", marginBottom:14, flexWrap:"wrap", gap:8 }}>
                      <div>
                        <div style={{ fontWeight:700, fontSize:15, color:C.text }}>{job.address}</div>
                        <div style={{ color:C.muted, fontSize:12 }}><strong style={{ color:C.accent }}>{f?.name}</strong> Â· Approved {job.approvedAt}</div>
                      </div>
                      <div style={{ textAlign:"right" }}>
                        <div style={{ color:C.muted, fontSize:11, fontFamily:"'Inter',sans-serif", fontWeight:500 }}>PAID / TOTAL</div>
                        <div style={{ color:totalPaid===totalP?C.green:C.accent, fontFamily:"'Cabinet Grotesk',sans-serif", fontWeight:800, fontSize:16 }}>{fmtDollarFull(totalPaid)} / {fmtDollarFull(totalP)}</div>
                      </div>
                    </div>

                    {/* Materials */}
                    {(p.materials||[]).map((m,i)=>(
                      <div key={i} style={{ display:"flex", alignItems:"center", justifyContent:"space-between", padding:"10px 14px", background:C.panel, borderRadius:9, marginBottom:6, border:`1px solid ${C.border}` }}>
                        <div>
                          <div style={{ color:C.text, fontSize:13, fontWeight:600 }}>ğŸªš {m.payee}</div>
                          <div style={{ color:C.muted, fontSize:11, fontFamily:"'Inter',sans-serif", fontWeight:500 }}>Materials</div>
                        </div>
                        <div style={{ display:"flex", alignItems:"center", gap:10 }}>
                          <span style={{ color:C.accent, fontFamily:"'Cabinet Grotesk',sans-serif", fontWeight:700, fontSize:15 }}>{fmtDollarFull(m.amount)}</span>
                          {m.status==="paid"
                            ? <span style={{ color:C.green, fontSize:11, fontFamily:"'Inter',sans-serif", fontWeight:600 }}>âœ“ PAID</span>
                            : <button onClick={()=>markPaid(job.id,"materials",i)} style={{ background:C.greenDim, color:C.green, border:`1px solid ${C.green}44`, borderRadius:7, padding:"5px 12px", fontSize:11, fontWeight:700, cursor:"pointer" }}>Mark Paid</button>
                          }
                        </div>
                      </div>
                    ))}

                    {/* Subs */}
                    {(p.subs||[]).map((s,i)=>(
                      <div key={i} style={{ display:"flex", alignItems:"center", justifyContent:"space-between", padding:"10px 14px", background:C.panel, borderRadius:9, marginBottom:6, border:`1px solid ${C.border}` }}>
                        <div>
                          <div style={{ color:C.text, fontSize:13, fontWeight:600 }}>ğŸ”§ {s.payee}</div>
                          <div style={{ color:C.muted, fontSize:11, fontFamily:"'Inter',sans-serif", fontWeight:500 }}>Subcontractor</div>
                        </div>
                        <div style={{ display:"flex", alignItems:"center", gap:10 }}>
                          <span style={{ color:C.purple, fontFamily:"'Cabinet Grotesk',sans-serif", fontWeight:700, fontSize:15 }}>{fmtDollarFull(s.amount)}</span>
                          {s.status==="paid"
                            ? <span style={{ color:C.green, fontSize:11, fontFamily:"'Inter',sans-serif", fontWeight:600 }}>âœ“ PAID</span>
                            : <button onClick={()=>markPaid(job.id,"sub",i)} style={{ background:C.greenDim, color:C.green, border:`1px solid ${C.green}44`, borderRadius:7, padding:"5px 12px", fontSize:11, fontWeight:700, cursor:"pointer" }}>Mark Paid</button>
                          }
                        </div>
                      </div>
                    ))}

                    {/* Franchisee GP */}
                    {p.franchisee && (
                      <div style={{ display:"flex", alignItems:"center", justifyContent:"space-between", padding:"10px 14px", background:C.greenDim, borderRadius:9, border:`1px solid ${C.green}33` }}>
                        <div>
                          <div style={{ color:C.text, fontSize:13, fontWeight:600 }}>ğŸ  {f?.owner} â€” Franchisee GP</div>
                          <div style={{ color:C.muted, fontSize:11, fontFamily:"'Inter',sans-serif", fontWeight:500 }}>Contract: {fmtDollarFull(p.franchisee.gross)} Â· Costs: {fmtDollarFull(p.franchisee.costs)}</div>
                        </div>
                        <div style={{ display:"flex", alignItems:"center", gap:10 }}>
                          <span style={{ color:C.green, fontFamily:"'Cabinet Grotesk',sans-serif", fontWeight:800, fontSize:16 }}>{fmtDollarFull(p.franchisee.net)}</span>
                          {p.franchisee.status==="paid"
                            ? <span style={{ color:C.green, fontSize:11, fontFamily:"'Inter',sans-serif", fontWeight:600 }}>âœ“ PAID</span>
                            : <button onClick={()=>markPaid(job.id,"franchisee")} style={{ background:C.greenDim, color:C.green, border:`1px solid ${C.green}44`, borderRadius:7, padding:"5px 12px", fontSize:11, fontWeight:700, cursor:"pointer" }}>Mark Paid</button>
                          }
                        </div>
                      </div>
                    )}
                  </div>
                );
              })
          }
        </div>
      )}

      {/* â”€â”€ FRANCHISEE ACCOUNTS TAB â”€â”€ */}
      {tab === "franchisees" && (
        <div>
          <div style={{ marginBottom:18 }}>
            <h1 style={{ fontFamily:"'Cabinet Grotesk',sans-serif", fontSize:24, fontWeight:900, margin:0 }}>My Accounts</h1>
            <p style={{ color:C.muted, fontSize:13, margin:"4px 0 0" }}>{myFranchisees.length} franchisees assigned to you.</p>
          </div>
          {myFranchisees.map(f=>{
            const fJobs    = jobs.filter(j=>j.fid===f.id);
            const fPending = fJobs.filter(j=>j.status==="pending_review").length;
            const fFlagged = fJobs.filter(j=>j.status==="flagged").length;
            const fApproved= fJobs.filter(j=>["approved","closed"].includes(j.status));
            const fRevenue = fApproved.reduce((a,j)=>a+j.contractPrice,0);
            const fGP      = fApproved.reduce((a,j)=>a+calcJobMargin(j).gp,0);
            const fMargin  = fRevenue > 0 ? (fGP/fRevenue)*100 : 0;
            const goalPct  = Math.min((fRevenue/f.revenueGoal)*100,100);
            return (
              <div key={f.id} style={{ background:C.card, border:`1px solid ${(fFlagged>0||fPending>0)?C.accent+"55":C.border}`, borderRadius:14, padding:18, marginBottom:10 }}>
                <div style={{ display:"flex", alignItems:"flex-start", justifyContent:"space-between", marginBottom:12, flexWrap:"wrap", gap:8 }}>
                  <div>
                    <div style={{ fontFamily:"'Cabinet Grotesk',sans-serif", fontWeight:800, fontSize:16, color:C.text }}>{f.name}</div>
                    <div style={{ color:C.muted, fontSize:12, marginTop:2 }}>{f.owner} Â· {f.region}</div>
                  </div>
                  <div style={{ display:"flex", gap:8 }}>
                    {fFlagged>0  && <span style={{ background:C.redDim,    color:C.red,    borderRadius:99, padding:"3px 10px", fontSize:11, fontFamily:"'Inter',sans-serif", fontWeight:500, fontWeight:700 }}>ğŸš© {fFlagged} flagged</span>}
                    {fPending>0  && <span style={{ background:C.accentDim, color:C.accent, borderRadius:99, padding:"3px 10px", fontSize:11, fontFamily:"'Inter',sans-serif", fontWeight:500, fontWeight:700 }}>â³ {fPending} pending</span>}
                  </div>
                </div>
                <div style={{ display:"flex", gap:14, marginBottom:12, flexWrap:"wrap" }}>
                  {[
                    { l:"YTD Revenue", v:fmtDollar(fRevenue),    c:C.accent },
                    { l:"YTD GP",      v:fmtDollar(fGP),         c:C.green },
                    { l:"Avg Margin",  v:fmtPct(fMargin),        c:fMargin<30?C.red:C.green },
                    { l:"Jobs",        v:fJobs.length,            c:C.blue },
                  ].map(s=>(
                    <div key={s.l}>
                      <div style={{ color:C.muted, fontSize:11, fontFamily:"'Inter',sans-serif", fontWeight:500 }}>{s.l}</div>
                      <div style={{ color:s.c, fontFamily:"'Cabinet Grotesk',sans-serif", fontWeight:700, fontSize:16 }}>{s.v}</div>
                    </div>
                  ))}
                </div>
                <div>
                  <div style={{ display:"flex", justifyContent:"space-between", marginBottom:4 }}>
                    <span style={{ color:C.muted, fontSize:11 }}>Revenue Goal Progress</span>
                    <span style={{ color:C.accent, fontSize:11, fontFamily:"'DM Mono',monospace" }}>{Math.round(goalPct)}% of {fmtDollar(f.revenueGoal)}</span>
                  </div>
                  <div style={{ height:5, background:C.border, borderRadius:99 }}>
                    <div style={{ width:`${goalPct}%`, height:"100%", background:C.accent, borderRadius:99 }} />
                  </div>
                </div>
              </div>
            );
          })}
        </div>
      )}

      {/* â”€â”€ REPORTS TAB â”€â”€ */}
      {tab === "reports" && (
        <ReportsTab
          franchisees={myFranchisees}
          jobs={allMyJobs}
          bms={[bm]}
          userRole="bm"
          onImpersonate={null}
        />
      )}

      {/* Bottom Nav */}
      <div style={{ position:"fixed", bottom:0, left:0, right:0, background:C.card, borderTop:`1px solid ${C.border}`, display:"flex", zIndex:100, height:68 }}>
        {navTabs.map(n=>(
          <button key={n.id} onClick={()=>setTab(n.id)} style={{ flex:1, background:"none", border:"none", cursor:"pointer", display:"flex", flexDirection:"column", alignItems:"center", justifyContent:"center", gap:3, position:"relative" }}>
            <div style={{ position:"relative" }}>
              <div style={{ fontSize:20, filter:tab===n.id?"none":"grayscale(1) opacity(0.4)" }}>{n.icon}</div>
              {n.badge > 0 && <div style={{ position:"absolute", top:-6, right:-8, background:C.red, color:"#fff", borderRadius:"50%", width:16, height:16, display:"flex", alignItems:"center", justifyContent:"center", fontSize:9, fontWeight:700 }}>{n.badge}</div>}
            </div>
            <span style={{ fontSize:11, fontFamily:"'Inter',sans-serif", color:tab===n.id?C.accent:C.muted, fontWeight:tab===n.id?600:400 }}>{n.label}</span>
            {tab===n.id&&<div style={{ position:"absolute", bottom:4, width:20, height:3, background:C.accent, borderRadius:99 }}/>}
          </button>
        ))}
      </div>
    </div>
  );
}

// â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
// ADMIN PORTAL â€” full HQ view, impersonation, cross-BM reports
// â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
function AdminPortal({ franchisees, jobs, bms, onUpdateJob, onImpersonate }) {
  const [adminTab, setAdminTab] = useState("reports");
  const [selectedBMId, setSelectedBMId] = useState("all"); // "all" | bmId

  const adminNavTabs = [
    { id:"reports",   icon:"ğŸ“Š", label:"Reports"    },
    { id:"ops",       icon:"âš™ï¸", label:"Operations" },
    { id:"team",      icon:"ğŸ‘”", label:"Team"       },
  ];

  // Filter franchisees by selected BM scope
  const scopedFranchisees = selectedBMId === "all"
    ? franchisees
    : franchisees.filter(f => f.bm === selectedBMId);
  const scopedJobs = jobs.filter(j => scopedFranchisees.some(f => f.id === j.fid));

  // Portfolio-wide KPIs
  const allApproved = jobs.filter(j => ["approved","closed"].includes(j.status));
  const totalRevenue = allApproved.reduce((a,j) => a+j.contractPrice, 0);
  const totalGP      = allApproved.reduce((a,j) => a+calcJobMargin(j).gp, 0);
  const totalMargin  = totalRevenue > 0 ? (totalGP/totalRevenue)*100 : 0;

  return (
    <div style={{ animation:"fadeIn 0.3s ease", paddingBottom:90 }}>
      {/* Admin top KPIs */}
      <div style={{ marginBottom:18 }}>
        <div style={{ display:"flex", alignItems:"center", justifyContent:"space-between", flexWrap:"wrap", gap:10, marginBottom:16 }}>
          <div>
            <h1 style={{ fontFamily:"'Cabinet Grotesk',sans-serif", fontSize:24, fontWeight:900, margin:0 }}>ğŸ‘‘ Franchise HQ</h1>
            <p style={{ color:C.muted, fontSize:13, margin:"4px 0 0" }}>Full portfolio â€” all regions, all BMs, all franchisees.</p>
          </div>
          {/* BM scope filter */}
          <div style={{ display:"flex", alignItems:"center", gap:8 }}>
            <span style={{ color:C.muted, fontSize:12 }}>Scope:</span>
            <select value={selectedBMId} onChange={e=>setSelectedBMId(e.target.value)}
              style={{ ...inputStyle, width:"auto", fontSize:12, padding:"6px 12px", cursor:"pointer" }}>
              <option value="all">All BMs ({franchisees.length} franchisees)</option>
              {bms.map(b => (
                <option key={b.id} value={b.id}>{b.name} â€” {b.region} ({franchisees.filter(f=>f.bm===b.id).length})</option>
              ))}
            </select>
          </div>
        </div>

        <div style={{ display:"grid", gridTemplateColumns:"repeat(auto-fit,minmax(130px,1fr))", gap:10 }}>
          <KPI icon="ğŸ " label="Franchisees"    value={franchisees.length}                                         color={C.accent} />
          <KPI icon="ğŸ‘”" label="BM Teams"        value={bms.length}                                                 color={C.blue} />
          <KPI icon="ğŸ”¨" label="Total Jobs"      value={jobs.length}                                                color={C.purple} />
          <KPI icon="ğŸ’°" label="Portfolio Rev."  value={fmtDollar(totalRevenue)}                                    color={C.green} />
          <KPI icon="ğŸ“ˆ" label="Portfolio GP"    value={fmtDollar(totalGP)}                                         color={C.green} />
          <KPI icon="â³" label="Pending Review"  value={jobs.filter(j=>j.status==="pending_review").length}         color={C.orange} />
          <KPI icon="ğŸš©" label="Flagged"         value={jobs.filter(j=>j.status==="flagged").length}                color={C.red} />
          <KPI icon="ğŸ“Š" label="Avg Margin"      value={totalMargin.toFixed(1)+"%"}                                 color={totalMargin<30?C.red:C.green} />
        </div>
      </div>

      {/* Tab switcher */}
      <div style={{ display:"flex", gap:0, marginBottom:20, background:C.panel, borderRadius:10, padding:4 }}>
        {adminNavTabs.map(t => (
          <button key={t.id} onClick={()=>setAdminTab(t.id)}
            style={{ flex:1, background:adminTab===t.id?C.purple:"transparent", color:adminTab===t.id?"#fff":C.muted, border:"none", borderRadius:7, padding:"9px 12px", fontWeight:600, cursor:"pointer", fontSize:13, fontFamily:"'Inter',sans-serif" }}>
            {t.icon} {t.label}
          </button>
        ))}
      </div>

      {/* â”€â”€ REPORTS TAB â”€â”€ */}
      {adminTab === "reports" && (
        <ReportsTab
          franchisees={scopedFranchisees}
          jobs={scopedJobs}
          bms={bms}
          userRole="admin"
          onImpersonate={onImpersonate}
        />
      )}

      {/* â”€â”€ OPERATIONS TAB â€” operational status board â”€â”€ */}
      {adminTab === "ops" && (
        <div>
          <div style={{ marginBottom:14 }}>
            <h2 style={{ fontFamily:"'Cabinet Grotesk',sans-serif", fontWeight:900, fontSize:18, margin:"0 0 4px" }}>Operations Board</h2>
            <p style={{ color:C.muted, fontSize:13, margin:0 }}>Live status across all jobs. Click any row to drill in.</p>
          </div>
          {/* BM sections */}
          {bms.map(bmItem => {
            const bmFranchisees = franchisees.filter(f => f.bm === bmItem.id);
            const bmJobs = jobs.filter(j => bmFranchisees.some(f => f.id === j.fid));
            const pending = bmJobs.filter(j=>j.status==="pending_review").length;
            const flagged = bmJobs.filter(j=>j.status==="flagged").length;
            return (
              <div key={bmItem.id} style={{ marginBottom:20 }}>
                <div style={{ display:"flex", alignItems:"center", gap:12, marginBottom:10 }}>
                  <span style={{ color:C.blue, fontFamily:"'Cabinet Grotesk',sans-serif", fontWeight:800, fontSize:15 }}>ğŸ‘” {bmItem.name}</span>
                  <span style={{ color:C.muted, fontSize:12 }}>{bmItem.region}</span>
                  {pending>0 && <span style={{ background:C.accentDim, color:C.accent, borderRadius:99, padding:"2px 8px", fontSize:11, fontWeight:600 }}>â³ {pending} pending</span>}
                  {flagged>0 && <span style={{ background:C.redDim,    color:C.red,    borderRadius:99, padding:"2px 8px", fontSize:11, fontWeight:600 }}>ğŸš© {flagged} flagged</span>}
                  <button onClick={() => onImpersonate("bm", bmItem.id)}
                    style={{ marginLeft:"auto", background:C.blueDim, color:C.blue, border:`1px solid ${C.blue}33`, borderRadius:7, padding:"4px 10px", fontSize:11, fontWeight:700, cursor:"pointer" }}>
                    View as BM â†’
                  </button>
                </div>
                {bmFranchisees.map(f => {
                  const fJobs = jobs.filter(j => j.fid === f.id);
                  const fPending = fJobs.filter(j=>j.status==="pending_review").length;
                  const fFlagged = fJobs.filter(j=>j.status==="flagged").length;
                  const fApproved = fJobs.filter(j=>["approved","closed"].includes(j.status));
                  const fRev = fApproved.reduce((a,j)=>a+j.contractPrice,0);
                  const { margin: fMar } = fApproved.length > 0 ? calcJobMargin({ contractPrice: fRev, actuals: {} }) : { margin:0 };
                  const score = calcHealthScore(f, jobs).composite;
                  const sc = scoreColor(score);
                  return (
                    <div key={f.id} style={{ background:C.card, border:`1px solid ${C.border}`, borderLeft:`3px solid ${sc}`, borderRadius:12, padding:"12px 16px", marginBottom:8, display:"flex", alignItems:"center", gap:16, flexWrap:"wrap" }}>
                      <ScoreGauge score={score} size={40} />
                      <div style={{ flex:1, minWidth:120 }}>
                        <div style={{ color:C.text, fontSize:13, fontWeight:700 }}>{f.name}</div>
                        <div style={{ color:C.muted, fontSize:11 }}>{f.owner} Â· {f.region}</div>
                      </div>
                      <div style={{ display:"flex", gap:16, flexWrap:"wrap" }}>
                        {[
                          { l:"Revenue",  v:fmtDollar(fRev),    c:C.accent },
                          { l:"Jobs",     v:fJobs.length,        c:C.blue },
                          { l:"Pending",  v:fPending,            c:fPending>0?C.orange:C.muted },
                          { l:"Flagged",  v:fFlagged,            c:fFlagged>0?C.red:C.muted },
                        ].map(s=>(
                          <div key={s.l}>
                            <div style={{ color:C.muted, fontSize:10 }}>{s.l}</div>
                            <div style={{ color:s.c, fontWeight:700, fontSize:14, fontFamily:"'Cabinet Grotesk',sans-serif" }}>{s.v}</div>
                          </div>
                        ))}
                      </div>
                      <button onClick={() => onImpersonate("franchisee", f.id)}
                        style={{ background:C.accentDim, color:C.accent, border:`1px solid ${C.accent}33`, borderRadius:7, padding:"5px 11px", fontSize:11, fontWeight:700, cursor:"pointer" }}>
                        ğŸ  Enter Portal â†’
                      </button>
                    </div>
                  );
                })}
              </div>
            );
          })}
        </div>
      )}

      {/* â”€â”€ TEAM TAB â€” BM overview â”€â”€ */}
      {adminTab === "team" && (
        <div>
          <div style={{ marginBottom:14 }}>
            <h2 style={{ fontFamily:"'Cabinet Grotesk',sans-serif", fontWeight:900, fontSize:18, margin:"0 0 4px" }}>Business Manager Team</h2>
            <p style={{ color:C.muted, fontSize:13, margin:0 }}>Performance overview per BM and their assigned portfolio.</p>
          </div>
          {bms.map(bmItem => {
            const bmFranchisees = franchisees.filter(f => f.bm === bmItem.id);
            const bmJobs = jobs.filter(j => bmFranchisees.some(f => f.id === j.fid));
            const approved = bmJobs.filter(j=>["approved","closed"].includes(j.status));
            const bmRev = approved.reduce((a,j)=>a+j.contractPrice,0);
            const bmGP  = approved.reduce((a,j)=>a+calcJobMargin(j).gp,0);
            const bmMar = bmRev > 0 ? (bmGP/bmRev)*100 : 0;
            const avgScore = bmFranchisees.length > 0
              ? Math.round(bmFranchisees.reduce((a,f) => a + calcHealthScore(f,jobs).composite, 0) / bmFranchisees.length)
              : 0;
            return (
              <div key={bmItem.id} style={{ background:C.card, border:`1px solid ${C.border}`, borderRadius:14, padding:20, marginBottom:14 }}>
                <div style={{ display:"flex", alignItems:"flex-start", justifyContent:"space-between", flexWrap:"wrap", gap:12, marginBottom:16 }}>
                  <div style={{ display:"flex", alignItems:"center", gap:14 }}>
                    <div style={{ background:C.blueDim, border:`1px solid ${C.blue}33`, borderRadius:12, width:48, height:48, display:"flex", alignItems:"center", justifyContent:"center", fontSize:22 }}>ğŸ‘”</div>
                    <div>
                      <div style={{ fontFamily:"'Cabinet Grotesk',sans-serif", fontWeight:800, fontSize:17, color:C.text }}>{bmItem.name}</div>
                      <div style={{ color:C.muted, fontSize:12 }}>{bmItem.region} Â· {bmFranchisees.length} franchisees</div>
                    </div>
                  </div>
                  <div style={{ display:"flex", gap:8 }}>
                    <div style={{ textAlign:"center" }}>
                      <div style={{ color:C.muted, fontSize:10, marginBottom:2 }}>Portfolio Score</div>
                      <div style={{ color:scoreColor(avgScore), fontFamily:"'Cabinet Grotesk',sans-serif", fontWeight:900, fontSize:22 }}>{avgScore}</div>
                    </div>
                    <button onClick={() => onImpersonate("bm", bmItem.id)}
                      style={{ background:C.blueDim, color:C.blue, border:`1px solid ${C.blue}44`, borderRadius:9, padding:"8px 16px", fontSize:12, fontWeight:700, cursor:"pointer", alignSelf:"center" }}>
                      View as BM â†’
                    </button>
                  </div>
                </div>
                <div style={{ display:"flex", gap:20, flexWrap:"wrap", marginBottom:16 }}>
                  {[
                    { l:"Portfolio Revenue",  v:fmtDollar(bmRev),  c:C.accent },
                    { l:"Portfolio GP",       v:fmtDollar(bmGP),   c:C.green  },
                    { l:"Avg Margin",         v:bmMar.toFixed(1)+"%", c:bmMar<30?C.red:C.green },
                    { l:"Total Jobs",         v:bmJobs.length,     c:C.blue   },
                    { l:"Pending Review",     v:bmJobs.filter(j=>j.status==="pending_review").length, c:C.orange },
                    { l:"Flagged",            v:bmJobs.filter(j=>j.status==="flagged").length,        c:C.red    },
                  ].map(s=>(
                    <div key={s.l}>
                      <div style={{ color:C.muted, fontSize:10 }}>{s.l}</div>
                      <div style={{ color:s.c, fontFamily:"'Cabinet Grotesk',sans-serif", fontWeight:700, fontSize:16 }}>{s.v}</div>
                    </div>
                  ))}
                </div>
                {/* Franchisee mini-list */}
                <div style={{ borderTop:`1px solid ${C.border}`, paddingTop:12 }}>
                  <div style={{ color:C.muted, fontSize:10, fontWeight:600, marginBottom:8 }}>ASSIGNED FRANCHISEES</div>
                  <div style={{ display:"flex", flexWrap:"wrap", gap:8 }}>
                    {bmFranchisees.map(f => {
                      const fs = calcHealthScore(f, jobs).composite;
                      return (
                        <button key={f.id} onClick={() => onImpersonate("franchisee", f.id)}
                          style={{ display:"flex", alignItems:"center", gap:8, background:C.panel, border:`1px solid ${C.border}`, borderRadius:8, padding:"6px 12px", cursor:"pointer" }}>
                          <div style={{ width:8, height:8, borderRadius:"50%", background:scoreColor(fs) }} />
                          <span style={{ color:C.text, fontSize:12, fontWeight:500 }}>{f.name}</span>
                          <span style={{ color:scoreColor(fs), fontSize:11, fontWeight:700, fontFamily:"'DM Mono',monospace" }}>{fs}</span>
                        </button>
                      );
                    })}
                  </div>
                </div>
              </div>
            );
          })}
        </div>
      )}
    </div>
  );
}

// â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
// ROOT APP â€” Role Switcher
// â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
export default function RoofProFranchise() {
  const [role,     setRole]     = useState(null); // "franchisee" | "bm" | "admin"
  const [selectedF, setSelectedF] = useState("f1");
  const [selectedBM, setSelectedBM] = useState("bm1");
  const [jobs,        setJobs]        = useState(SEED_JOBS);
  const [franchisees, setFranchisees] = useState(SEED_FRANCHISEES);
  const [bms]                         = useState(SEED_BMS);

  const updateJob = useCallback((id, updater) => {
    setJobs(js => js.map(j => j.id === id ? updater(j) : j));
  }, []);

  const createJob = useCallback((jobData) => {
    const id = "j" + (Date.now() % 100000);
    setJobs(js => [...js, { id, ...jobData }]);
  }, []);

  const updateFranchisee = useCallback((id, updater) => {
    setFranchisees(fs => fs.map(f => f.id === id ? updater(f) : f));
  }, []);

  const currentFranchisee = franchisees.find(f=>f.id===selectedF);
  const currentBM         = bms.find(b=>b.id===selectedBM);

  // Login screen
  if (!role) return (
    <div style={{ minHeight:"100vh", background:C.bg, display:"flex", flexDirection:"column", alignItems:"center", justifyContent:"center", padding:24, fontFamily:"'Inter',sans-serif" }}>
      <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600&family=DM+Mono:wght@400;500;700&family=Cabinet+Grotesk:wght@700;800;900&display=swap" rel="stylesheet"/>
      <style>{`select option{background:#14171F}@keyframes fadeIn{from{opacity:0;transform:translateY(10px)}to{opacity:1;transform:translateY(0)}}`}</style>
      <div style={{ animation:"fadeIn 0.4s ease", width:"100%", maxWidth:440 }}>
        <div style={{ display:"flex", alignItems:"center", gap:10, marginBottom:32, justifyContent:"center" }}>
          <div style={{ background:C.accent, width:38, height:38, borderRadius:10, display:"flex", alignItems:"center", justifyContent:"center", fontSize:20 }}>ğŸ </div>
          <span style={{ fontFamily:"'Cabinet Grotesk',sans-serif", fontWeight:900, fontSize:26, color:C.text }}>Roof<span style={{ color:C.accent }}>Pro</span></span>
        </div>

        <div style={{ background:C.card, border:`1px solid ${C.border}`, borderRadius:20, padding:28 }}>
          <h2 style={{ fontFamily:"'Cabinet Grotesk',sans-serif", fontWeight:900, fontSize:22, margin:"0 0 6px", color:C.text }}>Select Your Portal</h2>
          <p style={{ color:C.muted, fontSize:13, margin:"0 0 24px" }}>This is a prototype demo â€” choose a role to explore.</p>

          {/* Franchisee login */}
          <div style={{ marginBottom:16 }}>
            <div style={{ color:C.muted, fontSize:11, fontFamily:"'Inter',sans-serif", fontWeight:500, marginBottom:8 }}>ğŸ  FRANCHISEE PORTAL</div>
            <select value={selectedF} onChange={e=>setSelectedF(e.target.value)} style={{ ...inputStyle, marginBottom:8 }}>
              {franchisees.map(f=><option key={f.id} value={f.id}>{f.name} â€” {f.owner}</option>)}
            </select>
            <button onClick={()=>setRole("franchisee")} style={{ ...btnPrimary, width:"100%", textAlign:"center", padding:"12px" }}>
              Enter as Franchisee â†’
            </button>
          </div>

          <div style={{ borderTop:`1px solid ${C.border}`, margin:"20px 0" }}/>

          {/* BM login */}
          <div style={{ marginBottom:16 }}>
            <div style={{ color:C.muted, fontSize:11, fontFamily:"'Inter',sans-serif", fontWeight:500, marginBottom:8 }}>ğŸ‘” BUSINESS MANAGER PORTAL</div>
            <select value={selectedBM} onChange={e=>setSelectedBM(e.target.value)} style={{ ...inputStyle, marginBottom:8 }}>
              {bms.map(b=><option key={b.id} value={b.id}>{b.name} â€” {b.region} ({franchisees.filter(f=>b.franchiseeIds.includes(f.id)).length} franchisees)</option>)}
            </select>
            <button onClick={()=>setRole("bm")} style={{ background:C.blueDim, color:C.blue, border:`1px solid ${C.blue}44`, borderRadius:9, padding:"12px", fontWeight:800, cursor:"pointer", fontSize:13, width:"100%", fontFamily:"'Cabinet Grotesk',sans-serif" }}>
              Enter as Business Manager â†’
            </button>
          </div>

          <div style={{ borderTop:`1px solid ${C.border}`, margin:"20px 0" }}/>

          {/* Admin */}
          <div>
            <div style={{ color:C.muted, fontSize:11, fontFamily:"'Inter',sans-serif", fontWeight:500, marginBottom:8 }}>ğŸ‘‘ ADMIN / FRANCHISE HQ</div>
            <button onClick={()=>setRole("admin")} style={{ background:C.purpleDim, color:C.purple, border:`1px solid ${C.purple}44`, borderRadius:9, padding:"12px", fontWeight:800, cursor:"pointer", fontSize:13, width:"100%", fontFamily:"'Cabinet Grotesk',sans-serif" }}>
              Enter as Admin â†’
            </button>
          </div>
        </div>
      </div>
    </div>
  );

  const currentFranchiseeName = role === "franchisee" ? currentFranchisee?.name : role === "bm" ? currentBM?.name : "HQ Admin";
  const roleColor = role === "franchisee" ? C.accent : role === "bm" ? C.blue : C.purple;
  const roleIcon  = role === "franchisee" ? "ğŸ " : role === "bm" ? "ğŸ‘”" : "ğŸ‘‘";

  return (
    <div style={{ minHeight:"100vh", background:C.bg, color:C.text, fontFamily:"'Inter',sans-serif" }}>
      <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600&family=DM+Mono:wght@400;500;700&family=Cabinet+Grotesk:wght@700;800;900&display=swap" rel="stylesheet"/>
      <style>{`input[type=number]::-webkit-inner-spin-button{-webkit-appearance:none}input[type=number]{-moz-appearance:textfield}select option{background:#14171F}textarea{font-family:'Inter',sans-serif}@keyframes fadeIn{from{opacity:0;transform:translateY(10px)}to{opacity:1;transform:translateY(0)}}`}</style>

      {/* Top bar */}
      <div style={{ background:C.card, borderBottom:`1px solid ${C.border}`, padding:"0 18px", display:"flex", alignItems:"center", justifyContent:"space-between", height:52, position:"sticky", top:0, zIndex:200 }}>
        <div style={{ display:"flex", alignItems:"center", gap:10 }}>
          <div style={{ background:C.accent, width:28, height:28, borderRadius:7, display:"flex", alignItems:"center", justifyContent:"center", fontSize:14 }}>ğŸ </div>
          <span style={{ fontFamily:"'Cabinet Grotesk',sans-serif", fontWeight:900, fontSize:18, color:C.text }}>Roof<span style={{ color:C.accent }}>Pro</span></span>
          <span style={{ background:roleColor+"22", color:roleColor, borderRadius:99, padding:"3px 11px", fontSize:11, fontFamily:"'Inter',sans-serif", fontWeight:600 }}>{roleIcon} {currentFranchiseeName}</span>
        </div>
        <button onClick={()=>setRole(null)} style={{ ...btnSecondary, padding:"5px 12px", fontSize:12 }}>Switch Portal</button>
      </div>

      <div style={{ padding:"18px 16px" }}>
        {role === "franchisee" && currentFranchisee && (
          <FranchiseePortal franchisee={currentFranchisee} jobs={jobs} onUpdateJob={updateJob} onCreateJob={createJob} onUpdateFranchisee={updateFranchisee} />
        )}
        {role === "bm" && currentBM && (
          <BMPortal bm={currentBM} franchisees={franchisees} jobs={jobs} onUpdateJob={updateJob} />
        )}
        {role === "admin" && (
          <AdminPortal
            franchisees={franchisees}
            jobs={jobs}
            bms={bms}
            onUpdateJob={updateJob}
            onImpersonate={(impRole, impId) => {
              if (impRole === "franchisee") { setSelectedF(impId); setRole("franchisee"); }
              if (impRole === "bm")         { setSelectedBM(impId); setRole("bm"); }
            }}
          />
        )}
      </div>
    </div>
  );
}
